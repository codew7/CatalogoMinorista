<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Clientes</title>
    <link rel="icon" href="faviconnegro.png" type="image/png">
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="config.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #6c4eb6, #8b5fbf);
            color: white;
            padding: 2rem 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .container {
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .search-box input {
            padding: 0.8rem 1rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            min-width: 300px;
            transition: border-color 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #6c4eb6;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #6c4eb6;
            color: white;
        }

        .btn-primary:hover {
            background: #5a3d9b;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
            padding: 0.5rem;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            justify-content: center;
            align-items: center;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, #6c4eb6, #8b5fbf);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s ease;
            user-select: none;
        }

        th:hover {
            background: linear-gradient(135deg, #5a3d9b, #7a4fb3);
        }

        th.sortable {
            position: relative;
        }

        th.sortable::after {
            content: '↕️';
            position: absolute;
            right: 0.5rem;
            font-size: 0.8rem;
            opacity: 0.7;
        }

        th.sort-asc::after {
            content: '↑';
        }

        th.sort-desc::after {
            content: '↓';
        }

        /* Anchos específicos de columnas */
        th:nth-child(1), td:nth-child(1) { width: 8%; } /* ID */
        th:nth-child(2), td:nth-child(2) { width: 14%; } /* Nombre */
        th:nth-child(3), td:nth-child(3) { width: 12%; } /* Email */
        th:nth-child(4), td:nth-child(4) { width: 9%; } /* Teléfono */
        th:nth-child(5), td:nth-child(5) { width: 18%; } /* Dirección */
        th:nth-child(6), td:nth-child(6) { width: 13%; } /* Provincia */
        th:nth-child(7), td:nth-child(7) { width: 6%; }  /* DNI */
        th:nth-child(8), td:nth-child(8) { width: auto; min-width: 80px; } /* Tipo Cliente */
        th:nth-child(9), td:nth-child(9) { width: auto; min-width: 60px; } /* Registro */
        th:nth-child(10), td:nth-child(10) { width: auto; min-width: 70px; } /* Pedidos */
        th:nth-child(11), td:nth-child(11) { width: 40px; } /* Acciones */

        th.actions-header {
            width: 40px !important;
            min-width: 40px;
            cursor: default;
        }

        th.actions-header:hover {
            background: linear-gradient(135deg, #6c4eb6, #8b5fbf);
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }

        td.actions-cell {
            width: 40px !important;
            min-width: 40px;
        }

        td.id-cell {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }

        tr:hover {
            background: #f8f9fa;
            cursor: pointer;
        }

        tr.editing {
            background: #fff3cd !important;
        }

        tr.editing:hover {
            background: #fff3cd !important;
            cursor: default !important; /* Cambiar cursor en modo edición */
        }

        .editable-input {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid #6c4eb6;
            border-radius: 4px;
            font-size: 0.9rem;
            background: white;
        }

        .select-input {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid #6c4eb6;
            border-radius: 4px;
            font-size: 0.9rem;
            background: white;
        }

        .save-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 0.4rem 0.6rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-right: 0.3rem;
        }

        .save-btn:hover {
            background: #219a52;
        }

        .cancel-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 0.4rem 0.6rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .cancel-btn:hover {
            background: #7f8c8d;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            font-size: 1.2rem;
            color: #666;
        }

        .no-data {
            text-align: center;
            padding: 3rem;
            color: #666;
            font-size: 1.1rem;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #6c4eb6;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
        }

        .actions-cell {
            text-align: center;
            white-space: nowrap;
            width: 40px !important;
            min-width: 40px;
        }

        .tooltip {
            position: relative;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box input {
                min-width: 100%;
            }

            table {
                font-size: 0.9rem;
            }

            th, td {
                padding: 0.7rem 0.5rem;
            }

            .header h1 {
                font-size: 2rem;
            }
        }

        .type-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .type-consumidor {
            background: #e8f5e8;
            color: #2d8659;
        }

        .type-mayorista {
            background: #fff3cd;
            color: #856404;
        }

        .registro-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .registro-web {
            background: #e3f2fd;
            color: #1565c0;
        }

        .registro-local {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .filter-buttons {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .filter-group label {
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #ddd;
            border-radius: 20px;
            background: white;
            color: #666;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .filter-btn:hover {
            border-color: #6c4eb6;
            color: #6c4eb6;
        }

        .filter-btn.active {
            background: #6c4eb6;
            color: white;
            border-color: #6c4eb6;
        }

        .filter-btn.filter-vacio {
            background: #f8f9fa;
            color: #6c757d;
            border-color: #dee2e6;
        }

        .filter-btn.filter-vacio.active {
            background: #6c757d;
            color: white;
            border-color: #6c757d;
        }

        tr.highlight-save {
            background: #d4edda !important;
            animation: highlightFade 2s ease-out;
        }

        tr.highlight-save:hover {
            background: #d4edda !important;
        }

        @keyframes highlightFade {
            0% { background: #d4edda !important; }
            100% { background: transparent; }
        }

        .pedidos-count {
            display: inline-block;
            background: #6c4eb6;
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 25px;
            text-align: center;
        }

        .pedidos-count:hover {
            background: #5a3d9b;
            transform: scale(1.1);
        }

        .pedidos-count.zero {
            background: #dee2e6;
            color: #6c757d;
            cursor: default;
        }

        .pedidos-count.zero:hover {
            transform: none;
            background: #dee2e6;
        }

        /* Modal de reporte de pedidos */
        .modal-reporte {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-reporte-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 32px rgba(0,0,0,0.2);
            max-width: 90vw;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-reporte-header {
            background: linear-gradient(135deg, #6c4eb6, #8b5fbf);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-reporte-header h3 {
            margin: 0;
            font-size: 1.3rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.2);
        }

        .modal-reporte-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .pedido-item {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #f8f9fa;
        }

        .pedido-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .pedido-fecha {
            color: #666;
            font-size: 0.9rem;
        }

        .pedido-total {
            color: #6c4eb6;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .pedido-items {
            font-size: 0.9rem;
            color: #555;
            margin-top: 0.5rem;
        }

        .sin-pedidos {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 2rem;
        }
    </style>
</head>
<body>
    <!-- Firebase Auth Check -->
    <script>
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();
        
        firebase.auth().onAuthStateChanged(function(user) {
            if (!user) {
                window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname);
            }
        });
    </script>

    <div class="header">
        <h1>🧑‍🤝‍🧑 Gestión de Clientes</h1>
        <p>Administra la información de todos tus clientes de forma simple y eficiente</p>
    </div>

    <div class="container">
        <!-- Estadísticas -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalClientes">0</div>
                <div class="stat-label">Total Clientes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="clientesConsumidor">0</div>
                <div class="stat-label">Consumidores Finales</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="clientesMayorista">0</div>
                <div class="stat-label">Mayoristas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="clientesConEmail">0</div>
                <div class="stat-label">Con Email</div>
            </div>
        </div>

        <!-- Controles -->
        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="🔍 Buscar por nombre, email, teléfono, dirección o provincia...">
            </div>
            
            <!-- Filtros -->
            <div class="filter-buttons">
                <div class="filter-group">
                    <label>Registro:</label>
                    <button class="filter-btn active" onclick="filtrarPorRegistro('')">Todos</button>
                    <button class="filter-btn" onclick="filtrarPorRegistro('Web')">Web</button>
                    <button class="filter-btn" onclick="filtrarPorRegistro('Local')">Local</button>
                    <button class="filter-btn filter-vacio" onclick="filtrarPorRegistro('vacio')">Sin Registro</button>
                </div>
                
                <div class="filter-group">
                    <label>Tipo:</label>
                    <button class="filter-btn active" onclick="filtrarPorTipoCliente('')">Todos</button>
                    <button class="filter-btn" onclick="filtrarPorTipoCliente('consumidor final')">Consumidor</button>
                    <button class="filter-btn" onclick="filtrarPorTipoCliente('mayorista')">Mayorista</button>
                    <button class="filter-btn filter-vacio" onclick="filtrarPorTipoCliente('vacio')">Sin Tipo</button>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="agregarNuevoCliente()">
                ➕ Agregar Cliente
            </button>
        </div>

        <!-- Tabla -->
        <div class="table-container">
            <div id="loadingDiv" class="loading">
                <div>⏳ Cargando clientes...</div>
            </div>
            
            <table id="clientesTable" style="display: none;">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="id">ID</th>
                        <th class="sortable" data-sort="nombre">Nombre</th>
                        <th class="sortable" data-sort="email">Email</th>
                        <th class="sortable" data-sort="telefono">Teléfono</th>
                        <th class="sortable" data-sort="direccion">Dirección</th>
                        <th class="sortable" data-sort="provincia">Provincia</th>
                        <th class="sortable" data-sort="dni">DNI</th>
                        <th class="sortable" data-sort="tipoCliente">Tipo Cliente</th>
                        <th class="sortable" data-sort="registro">Registro</th>
                        <th class="sortable" data-sort="pedidosCount">Pedidos</th>
                        <th class="actions-header"></th>
                    </tr>
                </thead>
                <tbody id="clientesTableBody">
                </tbody>
            </table>

            <div id="noDataDiv" class="no-data" style="display: none;">
                <div>📋 No se encontraron clientes</div>
                <p>Agrega tu primer cliente para comenzar</p>
            </div>
        </div>
    </div>

    <!-- Modal para reporte de pedidos -->
    <div id="modalReportePedidos" class="modal-reporte">
        <div class="modal-reporte-content">
            <div class="modal-reporte-header">
                <h3 id="modalReporteTitle">Pedidos del Cliente</h3>
                <button class="modal-close" onclick="cerrarModalReporte()">&times;</button>
            </div>
            <div class="modal-reporte-body" id="modalReporteBody">
                <!-- Contenido se generará dinámicamente -->
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let todosLosClientes = [];
        let clientesFiltrados = [];
        let clienteEditando = null;
        let sortField = '';
        let sortDirection = 'asc';
        let filtroRegistro = '';
        let filtroTipoCliente = '';
        let pedidosPorEmail = {};
        let pedidosPorTelefono = {};

        // Lista de provincias argentinas
        const provinciasArgentinas = [
            'Buenos Aires',
            'Catamarca',
            'Chaco',
            'Chubut',
            'Córdoba',
            'Corrientes',
            'Entre Ríos',
            'Formosa',
            'Jujuy',
            'La Pampa',
            'La Rioja',
            'Mendoza',
            'Misiones',
            'Neuquén',
            'Río Negro',
            'Salta',
            'San Juan',
            'San Luis',
            'Santa Cruz',
            'Santa Fe',
            'Santiago del Estero',
            'Tierra del Fuego',
            'Tucumán',
            'Ciudad Autónoma de Buenos Aires'
        ];

        // Elementos del DOM
        const loadingDiv = document.getElementById('loadingDiv');
        const tableDiv = document.getElementById('clientesTable');
        const noDataDiv = document.getElementById('noDataDiv');
        const tableBody = document.getElementById('clientesTableBody');
        const searchInput = document.getElementById('searchInput');

        // Elementos de estadísticas
        const totalClientesEl = document.getElementById('totalClientes');
        const clientesConsumidorEl = document.getElementById('clientesConsumidor');
        const clientesMayoristaEl = document.getElementById('clientesMayorista');
        const clientesConEmailEl = document.getElementById('clientesConEmail');

        // Cargar datos desde Firebase
        function cargarClientes() {
            mostrarCarga();
            
            // Cargar pedidos primero para contar por email y teléfono
            db.ref('pedidos').once('value').then(pedidosSnapshot => {
                pedidosPorEmail = {};
                pedidosPorTelefono = {};
                
                if (pedidosSnapshot.exists()) {
                    pedidosSnapshot.forEach(child => {
                        const pedido = child.val();
                        if (pedido.cliente && (!pedido.status || pedido.status.toUpperCase() !== 'CANCELADO')) {
                            // Indexar por email si existe
                            if (pedido.cliente.email && pedido.cliente.email.trim() !== '') {
                                const email = pedido.cliente.email.toLowerCase().trim();
                                if (!pedidosPorEmail[email]) {
                                    pedidosPorEmail[email] = [];
                                }
                                pedidosPorEmail[email].push({
                                    id: child.key,
                                    ...pedido
                                });
                            }
                            
                            // Indexar por teléfono si existe
                            if (pedido.cliente.telefono && pedido.cliente.telefono.trim() !== '') {
                                const telefono = pedido.cliente.telefono.trim();
                                if (!pedidosPorTelefono[telefono]) {
                                    pedidosPorTelefono[telefono] = [];
                                }
                                pedidosPorTelefono[telefono].push({
                                    id: child.key,
                                    ...pedido
                                });
                            }
                        }
                    });
                }
                
                // Ahora cargar clientes
                db.ref('clientes').on('value', snapshot => {
                    todosLosClientes = [];
                    
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            const cliente = child.val();
                            cliente.id = child.key;
                            
                            // Agregar contador de pedidos
                            // Priorizar email, si no hay email usar teléfono
                            const emailCliente = (cliente.email || '').toLowerCase().trim();
                            const telefonoCliente = (cliente.telefono || '').trim();
                            
                            let pedidosCount = 0;
                            if (emailCliente && pedidosPorEmail[emailCliente]) {
                                pedidosCount = pedidosPorEmail[emailCliente].length;
                                cliente.criterioUsado = 'email';
                                cliente.valorCriterio = emailCliente;
                            } else if (telefonoCliente && pedidosPorTelefono[telefonoCliente]) {
                                pedidosCount = pedidosPorTelefono[telefonoCliente].length;
                                cliente.criterioUsado = 'telefono';
                                cliente.valorCriterio = telefonoCliente;
                            } else {
                                cliente.criterioUsado = 'ninguno';
                                cliente.valorCriterio = '';
                            }
                            
                            cliente.pedidosCount = pedidosCount;
                            todosLosClientes.push(cliente);
                        });
                    }
                    
                    // Invertir el orden de los registros (últimos en Firebase aparecen primero)
                    todosLosClientes.reverse();
                    
                    aplicarFiltros();
                    actualizarEstadisticas();
                    ocultarCarga();
                }, error => {
                    console.error('Error al cargar clientes:', error);
                    ocultarCarga();
                    mostrarSinDatos();
                });
            }).catch(error => {
                console.error('Error al cargar pedidos:', error);
                ocultarCarga();
                mostrarSinDatos();
            });
        }

        // Aplicar filtros de búsqueda
        function aplicarFiltros() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            clientesFiltrados = todosLosClientes.filter(cliente => {
                const nombre = (cliente.nombre || '').toLowerCase();
                const email = (cliente.email || '').toLowerCase();
                const telefono = (cliente.telefono || '').toLowerCase();
                const direccion = (cliente.direccion || '').toLowerCase();
                const provincia = (cliente.provincia || '').toLowerCase();
                const dni = (cliente.dni || '').toLowerCase();
                
                // Filtro de búsqueda por texto
                const coincideBusqueda = nombre.includes(searchTerm) || 
                       email.includes(searchTerm) || 
                       telefono.includes(searchTerm) ||
                       direccion.includes(searchTerm) ||
                       provincia.includes(searchTerm) ||
                       dni.includes(searchTerm);
                
                // Filtro por registro
                let coincideRegistro = true;
                if (filtroRegistro) {
                    if (filtroRegistro === 'vacio') {
                        coincideRegistro = !cliente.registro || cliente.registro.trim() === '';
                    } else {
                        coincideRegistro = (cliente.registro || '').toLowerCase() === filtroRegistro.toLowerCase();
                    }
                }
                
                // Filtro por tipo cliente
                let coincideTipoCliente = true;
                if (filtroTipoCliente) {
                    if (filtroTipoCliente === 'vacio') {
                        coincideTipoCliente = !cliente.tipoCliente || cliente.tipoCliente.trim() === '';
                    } else {
                        coincideTipoCliente = (cliente.tipoCliente || '').toLowerCase() === filtroTipoCliente.toLowerCase();
                    }
                }
                
                return coincideBusqueda && coincideRegistro && coincideTipoCliente;
            });
            
            aplicarOrdenamiento();
            renderizarTabla();
        }

        // Funciones para filtros
        function filtrarPorRegistro(valor) {
            filtroRegistro = valor;
            
            // Actualizar botones activos
            document.querySelectorAll('.filter-group:first-child .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            aplicarFiltros();
        }

        function filtrarPorTipoCliente(valor) {
            filtroTipoCliente = valor;
            
            // Actualizar botones activos
            document.querySelectorAll('.filter-group:last-child .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            aplicarFiltros();
        }

        // Función para ordenamiento
        function aplicarOrdenamiento() {
            if (!sortField) return;
            
            clientesFiltrados.sort((a, b) => {
                let valorA = a[sortField] || '';
                let valorB = b[sortField] || '';
                
                // Convertir a string para comparación
                valorA = String(valorA).toLowerCase();
                valorB = String(valorB).toLowerCase();
                
                if (valorA < valorB) {
                    return sortDirection === 'asc' ? -1 : 1;
                }
                if (valorA > valorB) {
                    return sortDirection === 'asc' ? 1 : -1;
                }
                return 0;
            });
        }

        // Función para manejar el click en headers
        function ordenarPor(campo) {
            if (clienteEditando) {
                cancelarEdicion();
            }
            
            if (sortField === campo) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = campo;
                sortDirection = 'asc';
            }
            
            // Actualizar indicadores visuales
            actualizarIndicadoresOrden();
            
            aplicarOrdenamiento();
            renderizarTabla();
        }

        // Actualizar indicadores de ordenamiento en headers
        function actualizarIndicadoresOrden() {
            const headers = document.querySelectorAll('th.sortable');
            headers.forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
                if (header.dataset.sort === sortField) {
                    header.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }

        // Renderizar tabla
        function renderizarTabla() {
            tableBody.innerHTML = '';
            
            if (clientesFiltrados.length === 0) {
                mostrarSinDatos();
                return;
            }
            
            mostrarTabla();
            
            clientesFiltrados.forEach(cliente => {
                const fila = crearFilaCliente(cliente);
                tableBody.appendChild(fila);
            });
        }

        // Crear fila de cliente
        function crearFilaCliente(cliente) {
            const fila = document.createElement('tr');
            fila.dataset.clienteId = cliente.id;
            
            const tipoCliente = cliente.tipoCliente || '';
            const registro = cliente.registro || '';
            
            // Contenido para Tipo Cliente
            let tipoClienteHTML = '';
            if (tipoCliente.trim() !== '') {
                const badgeClass = tipoCliente.toLowerCase().includes('mayorista') ? 'type-mayorista' : 'type-consumidor';
                const tipoClienteDisplay = tipoCliente.toLowerCase() === 'consumidor final' ? 'Consumidor' : tipoCliente;
                tipoClienteHTML = `<span class="type-badge ${badgeClass}">${tipoClienteDisplay}</span>`;
            }
            
            // Contenido para Registro
            let registroHTML = '';
            if (registro.trim() !== '') {
                const registroTexto = registro.toLowerCase() === 'web' ? 'Web' : 'Local';
                const registroBadgeClass = registro.toLowerCase() === 'web' ? 'registro-web' : 'registro-local';
                registroHTML = `<span class="registro-badge ${registroBadgeClass}">${registroTexto}</span>`;
            }
            
            // Contenido para Pedidos
            const pedidosCount = cliente.pedidosCount || 0;
            const pedidosClass = pedidosCount === 0 ? 'pedidos-count zero' : 'pedidos-count';
            
            // Determinar qué criterio usar para mostrar reporte
            let criterioReporte = '';
            let valorReporte = '';
            if (cliente.criterioUsado === 'email') {
                criterioReporte = 'email';
                valorReporte = cliente.email;
            } else if (cliente.criterioUsado === 'telefono') {
                criterioReporte = 'telefono';
                valorReporte = cliente.telefono;
            }
            
            const pedidosOnClick = pedidosCount > 0 ? `onclick="mostrarReportePedidos('${criterioReporte}', '${valorReporte}', '${cliente.nombre}')"` : '';
            const pedidosHTML = `<span class="${pedidosClass}" ${pedidosOnClick}>${pedidosCount}</span>`;
            
            // Truncar ID si es muy largo
            const idDisplay = cliente.id.length > 8 ? cliente.id.substring(0, 8) + '...' : cliente.id;
            
            fila.innerHTML = `
                <td class="id-cell" title="${cliente.id}">${idDisplay}</td>
                <td><strong>${cliente.nombre || ''}</strong></td>
                <td>${cliente.email || '<em>Sin email</em>'}</td>
                <td>${cliente.telefono || '<em>Sin teléfono</em>'}</td>
                <td>${cliente.direccion || '<em>Sin dirección</em>'}</td>
                <td>${cliente.provincia || '<em>Sin provincia</em>'}</td>
                <td>${cliente.dni || '<em>Sin DNI</em>'}</td>
                <td>${tipoClienteHTML}</td>
                <td>${registroHTML}</td>
                <td style="text-align: center;">${pedidosHTML}</td>
                <td class="actions-cell">
                    <button class="btn-danger tooltip" data-tooltip="Eliminar cliente" onclick="eliminarCliente('${cliente.id}', event)">
                        ✕
                    </button>
                </td>
            `;
            
            // Hacer la fila clickeable para editar SOLO si no está en modo edición
            fila.addEventListener('click', (e) => {
                // No editar si se hizo click en eliminar, en pedidos count, o si ya está editando
                if (e.target.closest('.btn-danger') || e.target.closest('.pedidos-count') || clienteEditando === cliente.id) {
                    return;
                }
                editarCliente(cliente.id);
            });
            
            return fila;
        }

        // Editar cliente
        function editarCliente(clienteId) {
            if (clienteEditando) {
                cancelarEdicion();
            }
            
            const cliente = todosLosClientes.find(c => c.id === clienteId);
            if (!cliente) return;
            
            clienteEditando = clienteId;
            const fila = document.querySelector(`tr[data-cliente-id="${clienteId}"]`);
            fila.classList.add('editing');
            
            const tipoCliente = cliente.tipoCliente || 'consumidor final';
            
            // Crear opciones para el select de provincias
            let opcionesProvincias = '<option value="">Seleccionar provincia</option>';
            provinciasArgentinas.forEach(provincia => {
                const selected = (cliente.provincia === provincia) ? 'selected' : '';
                opcionesProvincias += `<option value="${provincia}" ${selected}>${provincia}</option>`;
            });
            
            fila.innerHTML = `
                <td class="id-cell" title="${cliente.id}">${clienteId}</td>
                <td><input type="text" class="editable-input" value="${cliente.nombre || ''}" id="edit-nombre"></td>
                <td><input type="email" class="editable-input" value="${cliente.email || ''}" id="edit-email"></td>
                <td><input type="tel" class="editable-input" value="${cliente.telefono || ''}" id="edit-telefono"></td>
                <td><input type="text" class="editable-input" value="${cliente.direccion || ''}" id="edit-direccion"></td>
                <td>
                    <select class="select-input" id="edit-provincia">
                        ${opcionesProvincias}
                    </select>
                </td>
                <td><input type="text" class="editable-input" value="${cliente.dni || ''}" id="edit-dni"></td>
                <td>
                    <select class="select-input" id="edit-tipoCliente">
                        <option value="" ${!tipoCliente || tipoCliente === '' ? 'selected' : ''}>Sin especificar</option>
                        <option value="consumidor final" ${tipoCliente === 'consumidor final' ? 'selected' : ''}>Consumidor Final</option>
                        <option value="mayorista" ${tipoCliente === 'mayorista' ? 'selected' : ''}>Mayorista</option>
                    </select>
                </td>
                <td>
                    <select class="select-input" id="edit-registro">
                        <option value="" ${!cliente.registro || cliente.registro === '' ? 'selected' : ''}>Sin especificar</option>
                        <option value="Local" ${(cliente.registro || '') === 'Local' ? 'selected' : ''}>Local</option>
                        <option value="Web" ${(cliente.registro || '') === 'Web' ? 'selected' : ''}>Web</option>
                    </select>
                </td>
                <td style="text-align: center;">
                    <span class="pedidos-count ${cliente.pedidosCount === 0 ? 'zero' : ''}" 
                          ${cliente.pedidosCount > 0 ? `onclick="mostrarReportePedidos('${cliente.criterioUsado}', '${cliente.valorCriterio}', '${cliente.nombre}')"` : ''}>
                        ${cliente.pedidosCount || 0}
                    </span>
                </td>
                <td class="actions-cell">
                    <button class="save-btn" onclick="guardarEdicion('${clienteId}')">💾</button>
                    <button class="cancel-btn" onclick="cancelarEdicion()">❌</button>
                </td>
            `;
            
            // Remover el event listener de click de la fila mientras está en edición
            const nuevaFila = fila.cloneNode(true);
            fila.parentNode.replaceChild(nuevaFila, fila);
            
            // Agregar event listeners para prevenir la propagación de eventos
            nuevaFila.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            // Prevenir que los selects se cierren
            const selects = nuevaFila.querySelectorAll('select');
            selects.forEach(select => {
                select.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                });
                select.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            });
            
            // Prevenir que los inputs pierdan el foco
            const inputs = nuevaFila.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
                input.addEventListener('focus', (e) => {
                    e.stopPropagation();
                });
            });
        }

        // Guardar edición
        function guardarEdicion(clienteId) {
            const nombre = document.getElementById('edit-nombre').value.trim();
            const email = document.getElementById('edit-email').value.trim();
            const telefono = document.getElementById('edit-telefono').value.trim();
            const direccion = document.getElementById('edit-direccion').value.trim();
            const provincia = document.getElementById('edit-provincia').value.trim();
            const dni = document.getElementById('edit-dni').value.trim();
            const tipoCliente = document.getElementById('edit-tipoCliente').value;
            const registro = document.getElementById('edit-registro').value;
            
            if (!nombre) {
                alert('El nombre es obligatorio');
                return;
            }
            
            const datosActualizados = {
                nombre,
                email,
                telefono,
                direccion,
                provincia,
                dni,
                tipoCliente,
                registro
            };
            
            db.ref(`clientes/${clienteId}`).update(datosActualizados)
                .then(() => {
                    clienteEditando = null;
                    
                    // Resaltar la fila guardada por un momento
                    setTimeout(() => {
                        const fila = document.querySelector(`tr[data-cliente-id="${clienteId}"]`);
                        if (fila) {
                            fila.classList.add('highlight-save');
                            setTimeout(() => {
                                fila.classList.remove('highlight-save');
                            }, 2000);
                        }
                    }, 100);
                    
                    // La tabla se actualizará automáticamente por el listener de Firebase
                })
                .catch(error => {
                    console.error('Error al actualizar cliente:', error);
                    alert('Error al guardar los cambios');
                });
        }

        // Cancelar edición
        function cancelarEdicion() {
            if (!clienteEditando) return;
            
            clienteEditando = null;
            renderizarTabla(); // Re-renderizar para restaurar la fila original
        }

        // Eliminar cliente
        function eliminarCliente(clienteId, event) {
            event.stopPropagation();
            
            const cliente = todosLosClientes.find(c => c.id === clienteId);
            if (!cliente) return;
            
            if (confirm(`¿Estás seguro de que deseas eliminar al cliente "${cliente.nombre}"?\n\nEsta acción no se puede deshacer.`)) {
                db.ref(`clientes/${clienteId}`).remove()
                    .then(() => {
                        // La tabla se actualizará automáticamente por el listener de Firebase
                    })
                    .catch(error => {
                        console.error('Error al eliminar cliente:', error);
                        alert('Error al eliminar el cliente');
                    });
            }
        }

        // Agregar nuevo cliente
        function agregarNuevoCliente() {
            if (clienteEditando) {
                cancelarEdicion();
            }
            
            const nuevoCliente = {
                nombre: 'Nuevo Cliente',
                email: '',
                telefono: '',
                direccion: '',
                provincia: '',
                dni: '',
                tipoCliente: '',
                registro: ''
            };
            
            db.ref('clientes').push(nuevoCliente)
                .then((ref) => {
                    // Esperar a que se actualice la lista y luego editar
                    setTimeout(() => {
                        editarCliente(ref.key);
                    }, 500);
                })
                .catch(error => {
                    console.error('Error al agregar cliente:', error);
                    alert('Error al agregar nuevo cliente');
                });
        }

        // Actualizar estadísticas
        function actualizarEstadisticas() {
            const total = todosLosClientes.length;
            const consumidores = todosLosClientes.filter(c => 
                (c.tipoCliente || '').toLowerCase().includes('consumidor')).length;
            const mayoristas = todosLosClientes.filter(c => 
                (c.tipoCliente || '').toLowerCase().includes('mayorista')).length;
            const conEmail = todosLosClientes.filter(c => c.email && c.email.trim() !== '').length;
            
            totalClientesEl.textContent = total;
            clientesConsumidorEl.textContent = consumidores;
            clientesMayoristaEl.textContent = mayoristas;
            clientesConEmailEl.textContent = conEmail;
        }

        // Funciones de UI
        function mostrarCarga() {
            loadingDiv.style.display = 'block';
            tableDiv.style.display = 'none';
            noDataDiv.style.display = 'none';
        }

        function mostrarTabla() {
            loadingDiv.style.display = 'none';
            tableDiv.style.display = 'table';
            noDataDiv.style.display = 'none';
        }

        function mostrarSinDatos() {
            loadingDiv.style.display = 'none';
            tableDiv.style.display = 'none';
            noDataDiv.style.display = 'block';
        }

        function ocultarCarga() {
            loadingDiv.style.display = 'none';
        }

        // Event listeners
        searchInput.addEventListener('input', aplicarFiltros);

        // Event listeners para ordenamiento
        document.addEventListener('click', function(e) {
            if (e.target.matches('th.sortable')) {
                const campo = e.target.dataset.sort;
                ordenarPor(campo);
            }
        });

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            cargarClientes();
        });

        // Manejar tecla Escape para cancelar edición
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && clienteEditando) {
                cancelarEdicion();
            }
        });

        // === FUNCIONES PARA REPORTE DE PEDIDOS ===
        
        function mostrarReportePedidos(criterio, valor, nombreCliente) {
            if (!criterio || !valor) return;
            
            let pedidos = [];
            
            // Buscar pedidos usando el criterio especificado
            if (criterio === 'email') {
                const emailKey = valor.toLowerCase().trim();
                pedidos = pedidosPorEmail[emailKey] || [];
            } else if (criterio === 'telefono') {
                pedidos = pedidosPorTelefono[valor] || [];
            }
            
            const modal = document.getElementById('modalReportePedidos');
            const title = document.getElementById('modalReporteTitle');
            const body = document.getElementById('modalReporteBody');
            
            title.textContent = `Pedidos de ${nombreCliente}`;
            
            if (pedidos.length === 0) {
                body.innerHTML = '<div class="sin-pedidos">No hay pedidos registrados para este cliente.</div>';
            } else {
                // Ordenar pedidos por fecha (más recientes primero)
                pedidos.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                
                let html = '';
                pedidos.forEach(pedido => {
                    const fecha = pedido.fecha || 'Sin fecha';
                    const total = pedido.pagos?.totalFinal || 0;
                    const items = pedido.items || [];
                    const medioPago = pedido.pagos?.medioPago || 'No especificado';
                    const status = pedido.status || 'Sin estado';
                    
                    // Crear resumen de artículos
                    let itemsResumen = '';
                    if (items.length > 0) {
                        const primeros3 = items.slice(0, 3);
                        itemsResumen = primeros3.map(item => 
                            `${item.cantidad}x ${item.nombre}`
                        ).join(', ');
                        
                        if (items.length > 3) {
                            itemsResumen += ` y ${items.length - 3} más...`;
                        }
                    }
                    
                    html += `
                        <div class="pedido-item">
                            <div class="pedido-header">
                                <span class="pedido-fecha">📅 ${fecha}</span>
                                <span class="pedido-total">$${parseInt(total).toLocaleString('es-AR')}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="font-size: 0.9rem; color: #666;">💳 ${medioPago}</span>
                                <span style="font-size: 0.85rem; background: #e3f2fd; color: #1565c0; padding: 0.2rem 0.5rem; border-radius: 10px;">${status}</span>
                            </div>
                            ${itemsResumen ? `<div class="pedido-items">🛍️ ${itemsResumen}</div>` : ''}
                        </div>
                    `;
                });
                
                body.innerHTML = html;
            }
            
            modal.style.display = 'flex';
        }
        
        function cerrarModalReporte() {
            const modal = document.getElementById('modalReportePedidos');
            modal.style.display = 'none';
        }
        
        // Cerrar modal al hacer clic fuera
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('modalReportePedidos');
            if (e.target === modal) {
                cerrarModalReporte();
            }
        });
        
        // Cerrar modal con Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('modalReportePedidos');
                if (modal.style.display === 'flex') {
                    cerrarModalReporte();
                }
            }
        });
    </script>
</body>
</html>
