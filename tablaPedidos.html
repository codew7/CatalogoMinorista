<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabla de Pedidos - Sistema de Gesti√≥n</title>
    <link rel="icon" href="faviconnegro.png" type="image/png">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    
    <!-- DataTables CSS y JS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
            --dark-text: #2c3e50;
            --border-color: #dee2e6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark-text);
        }

        .container-fluid {
            padding: 20px;
        }

        .main-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(-20px, -20px) rotate(180deg); }
        }

        .header h1 {
            position: relative;
            z-index: 2;
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .header p {
            position: relative;
            z-index: 2;
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .filters-section {
            padding: 30px;
            background: var(--light-bg);
            border-bottom: 2px solid var(--border-color);
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            position: relative;
        }

        .filter-group label {
            display: block;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 8px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-control, .form-select {
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 12px 15px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
            outline: none;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(149, 165, 166, 0.4);
        }

        .table-section {
            padding: 30px;
        }

        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        #pedidosTable {
            width: 100% !important;
            margin: 0;
        }

        #pedidosTable thead th {
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            padding: 15px 10px;
            border: none;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #pedidosTable tbody td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
            font-size: 0.9rem;
        }

        #pedidosTable tbody tr {
            transition: all 0.3s ease;
        }

        #pedidosTable tbody tr:hover {
            background: rgba(52, 152, 219, 0.05);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pendiente {
            background: rgba(243, 156, 18, 0.2);
            color: var(--warning-color);
            border: 1px solid var(--warning-color);
        }

        .status-completado {
            background: rgba(39, 174, 96, 0.2);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .status-cancelado {
            background: rgba(231, 76, 60, 0.2);
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.2rem;
            color: var(--secondary-color);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--secondary-color);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--primary-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .currency {
            color: var(--success-color);
            font-weight: 600;
        }

        .date-cell {
            white-space: nowrap;
        }

        .items-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .export-btn {
            background: linear-gradient(135deg, var(--success-color), #229954);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        /* Estilos para filas expandibles */
        .expandable-row {
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .expandable-row:hover {
            background-color: rgba(52, 152, 219, 0.1) !important;
        }

        .expandable-row.expanded {
            background-color: rgba(52, 152, 219, 0.15) !important;
        }

        .expand-icon {
            font-size: 12px;
            margin-right: 8px;
            transition: transform 0.3s ease;
            display: inline-block;
        }

        .expand-icon.expanded {
            transform: rotate(90deg);
        }

        .detail-row {
            background-color: #f8f9fa !important;
            border-left: 4px solid var(--secondary-color);
        }

        .detail-content {
            padding: 20px;
            background: white;
            border-radius: 8px;
            margin: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .items-detail-table {
            width: 100%;
            margin-top: 15px;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .items-detail-table th {
            background: var(--primary-color);
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #ddd;
        }

        .items-detail-table td {
            padding: 10px 8px;
            border: 1px solid #ddd;
            vertical-align: middle;
        }

        .items-detail-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .items-detail-table tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .detail-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .detail-summary {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            color: var(--dark-text);
        }

        .summary-item {
            background: var(--light-bg);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .summary-label {
            font-weight: 600;
            color: var(--primary-color);
        }

        .item-codigo {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: var(--primary-color);
        }

        .item-nombre {
            font-weight: 500;
        }

        .item-cantidad {
            text-align: center;
            font-weight: 600;
            color: var(--secondary-color);
        }

        .item-valor {
            text-align: right;
            font-weight: 600;
            color: var(--success-color);
        }

        .item-total {
            text-align: right;
            font-weight: 700;
            color: var(--success-color);
            background-color: rgba(39, 174, 96, 0.1);
        }

        .delete-btn {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(231, 76, 60, 0.4);
        }

        .delete-btn:active {
            transform: translateY(0);
        }

        /* Estilo para columna de acciones en el margen derecho */
        #pedidosTable th:last-child,
        #pedidosTable td:last-child {
            text-align: center;
            vertical-align: middle;
            position: sticky;
            right: 0;
            background: inherit;
            z-index: 5;
        }

        #pedidosTable th:last-child {
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            z-index: 15;
        }

        /* Estilos para el modal de confirmaci√≥n */
        .modal-content {
            border: none;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px 15px 0 0;
            border: none;
        }

        .modal-header.danger {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
        }

        .modal-title {
            font-weight: 600;
        }

        .btn-close {
            filter: brightness(0) invert(1);
        }

        .modal-body {
            padding: 30px;
            text-align: center;
        }

        .delete-form-group {
            margin-bottom: 20px;
        }

        .delete-form-group label {
            display: block;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .delete-form-group input {
            width: 100%;
            max-width: 300px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 15px;
            font-size: 16px;
            text-align: center;
            letter-spacing: 2px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .delete-form-group input:focus {
            border-color: var(--danger-color);
            box-shadow: 0 0 0 0.2rem rgba(231, 76, 60, 0.25);
            outline: none;
        }

        .btn-delete-confirm {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        .btn-delete-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .btn-delete-confirm:disabled {
            background: #bdc3c7;
            transform: none;
            box-shadow: none;
            cursor: not-allowed;
        }

        .btn-cancel {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .btn-cancel:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(149, 165, 166, 0.4);
        }

        .warning-text {
            color: var(--danger-color);
            font-weight: 600;
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        .pedido-info {
            background: var(--light-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: left;
        }

        .pedido-info-item {
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .pedido-info-label {
            font-weight: 600;
            color: var(--primary-color);
            display: inline-block;
            width: 120px;
        }

        @media (max-width: 768px) {
            .container-fluid {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                justify-content: center;
            }
            
            .stats-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="main-card">
            <div class="header">
                <h1><i class="bi bi-table"></i> Tabla de Pedidos</h1>
                <p>Sistema de gesti√≥n y visualizaci√≥n de pedidos</p>
                <div id="adminIndicator" style="position: absolute; top: 10px; right: 20px; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; display: none;">
                    <i class="bi bi-shield-check"></i> Modo Administrador
                    <button id="logoutBtn" style="margin-left: 10px; background: rgba(255,255,255,0.3); border: 1px solid rgba(255,255,255,0.5); border-radius: 8px; padding: 3px 8px; font-size: 0.7rem; color: white; cursor: pointer;" title="Cerrar sesi√≥n">
                        <i class="bi bi-box-arrow-right"></i>
                    </button>
                </div>
                <div id="userIndicator" style="position: absolute; top: 10px; right: 20px; background: rgba(76, 175, 80, 0.2); padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; display: none; color: white;">
                    <i class="bi bi-person-check"></i> <span id="userEmail"></span>
                    <button id="logoutBtnUser" style="margin-left: 10px; background: rgba(255,255,255,0.3); border: 1px solid rgba(255,255,255,0.5); border-radius: 8px; padding: 3px 8px; font-size: 0.7rem; color: white; cursor: pointer;" title="Cerrar sesi√≥n">
                        <i class="bi bi-box-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Estad√≠sticas -->
            <div class="filters-section">
                <div class="stats-row" id="statsRow">
                    <div class="stat-card">
                        <div class="stat-number" id="totalPedidos">0</div>
                        <div class="stat-label">Total Pedidos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number currency" id="totalVentas">$0</div>
                        <div class="stat-label">Total Ventas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalClientes">0</div>
                        <div class="stat-label">Clientes √önicos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number currency" id="promedioVenta">$0</div>
                        <div class="stat-label">Promedio por Venta</div>
                    </div>
                </div>

                <!-- Filtros -->
                <h5 class="mb-3"><i class="bi bi-funnel"></i> Filtros</h5>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="filtroFechaDesde">Fecha Desde</label>
                        <input type="date" id="filtroFechaDesde" class="form-control">
                    </div>
                    <div class="filter-group">
                        <label for="filtroFechaHasta">Fecha Hasta</label>
                        <input type="date" id="filtroFechaHasta" class="form-control">
                    </div>
                    <div class="filter-group">
                        <label for="filtroCliente">Cliente</label>
                        <input type="text" id="filtroCliente" class="form-control" placeholder="Buscar por cliente...">
                    </div>
                    <div class="filter-group">
                        <label for="filtroTipoCliente">Tipo Cliente</label>
                        <select id="filtroTipoCliente" class="form-select">
                            <option value="">Todos los tipos</option>
                            <option value="consumidor final">Consumidor Final</option>
                            <option value="mayorista">Mayorista</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filtroEntrega">Entrega</label>
                        <select id="filtroEntrega" class="form-select">
                            <option value="">Todos los tipos</option>
                            <option value="Local">Local</option>
                            <option value="Envios">Env√≠os</option>
                        </select>
                    </div>
                </div>
                <div class="btn-group mt-3">
                    <button id="aplicarFiltros" class="btn btn-primary">
                        <i class="bi bi-search"></i> Aplicar Filtros
                    </button>
                    <button id="limpiarFiltros" class="btn btn-secondary">
                        <i class="bi bi-x-circle"></i> Limpiar Filtros
                    </button>
                    <button id="exportarExcel" class="btn export-btn">
                        <i class="bi bi-download"></i> Exportar Excel
                    </button>
                    <button id="refrescarDatos" class="btn btn-primary">
                        <i class="bi bi-arrow-clockwise"></i> Refrescar
                    </button>
                </div>
            </div>

            <!-- Tabla -->
            <div class="table-section">
                <div id="loadingDiv" class="loading">
                    <div class="spinner"></div>
                    <span id="loadingText">Verificando credenciales...</span>
                </div>
                <div class="table-responsive" id="tableContainer" style="display: none;">
                    <table id="pedidosTable" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Tipo Cliente</th>
                                <th>Items</th>
                                <th>Subtotal</th>
                                <th>Descuento</th>
                                <th>Recargo</th>
                                <th>Total Final</th>
                                <th>Entrega</th>
                                <th>Vendedor</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="pedidosTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n de Eliminaci√≥n -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header danger">
                    <h5 class="modal-title" id="deleteModalLabel">
                        <i class="bi bi-exclamation-triangle"></i> Confirmar Eliminaci√≥n
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="warning-text">
                        <i class="bi bi-exclamation-circle"></i> ¬°ATENCI√ìN! Esta acci√≥n es irreversible
                    </div>
                    
                    <div class="pedido-info" id="pedidoInfo">
                        <!-- Informaci√≥n del pedido se cargar√° aqu√≠ -->
                    </div>
                    
                    <form id="deleteForm">
                        <input type="hidden" id="deletePedidoId" />
                        
                        <div class="delete-form-group">
                            <label for="deletePassword">Para confirmar la eliminaci√≥n, ingrese la clave de seguridad:</label>
                            <input type="password" id="deletePassword" placeholder="Ingrese la clave" maxlength="6" autocomplete="new-password">
                        </div>
                        
                        <div style="color: #666; font-size: 0.9rem; margin-bottom: 20px;">
                            Esta acci√≥n eliminar√° permanentemente el pedido y todos sus datos asociados.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-delete-confirm" id="confirmDelete" disabled>
                        <i class="bi bi-trash"></i> Eliminar Pedido
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="config.js"></script>

    <script>
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        // Sistema de autenticaci√≥n
        let admin = false; // Declarar admin al principio para evitar errores de hoisting
        let authResolved = false; // Flag para controlar si la autenticaci√≥n se resolvi√≥
        
        // Lista de emails de administradores
        const adminEmails = ["distribuidorahomepoint@gmail.com"];

        // Funci√≥n para inicializar la p√°gina despu√©s de la autenticaci√≥n
        function inicializarPagina() {
            // Si la p√°gina ya est√° cargada, ejecutar inmediatamente
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', cargarPedidos);
            } else {
                cargarPedidos();
            }
        }

        // Funci√≥n para redirigir a login con par√°metro de retorno
        function redirigirALogin() {
            const currentUrl = encodeURIComponent(window.location.href);
            window.location.href = `login.html?redirect=${currentUrl}`;
        }

        // Timeout de seguridad: verificar autenticaci√≥n despu√©s de 5 segundos
        setTimeout(() => {
            if (!authResolved) {
                console.warn('Timeout de autenticaci√≥n - redirigiendo a login');
                redirigirALogin();
            }
        }, 5000);

        firebase.auth().onAuthStateChanged(user => {
            console.log('Firebase Auth State Changed:', user ? 'Usuario autenticado' : 'No hay usuario');
            authResolved = true; // Marcar que la autenticaci√≥n se resolvi√≥
            
            if (user) {
                // Usuario autenticado
                console.log('Usuario autenticado:', user.email);
                
                // Verificar si es administrador
                if (adminEmails.includes(user.email)) {
                    admin = true;
                    console.log('Usuario es administrador:', user.email);
                    
                    // Mostrar indicador de administrador
                    const adminIndicator = document.getElementById('adminIndicator');
                    const userIndicator = document.getElementById('userIndicator');
                    if (adminIndicator) {
                        adminIndicator.style.display = 'block';
                    }
                    if (userIndicator) {
                        userIndicator.style.display = 'none';
                    }
                } else {
                    // Usuario normal (no administrador)
                    admin = false;
                    console.log('Usuario normal:', user.email);
                    
                    // Mostrar indicador de usuario normal
                    const adminIndicator = document.getElementById('adminIndicator');
                    const userIndicator = document.getElementById('userIndicator');
                    const userEmail = document.getElementById('userEmail');
                    
                    if (adminIndicator) {
                        adminIndicator.style.display = 'none';
                    }
                    if (userIndicator) {
                        userIndicator.style.display = 'block';
                    }
                    if (userEmail) {
                        userEmail.textContent = user.email;
                    }
                }
                
                // Usuario autenticado, inicializar p√°gina
                console.log('Inicializando p√°gina para usuario autenticado...');
                inicializarPagina();
            } else {
                // No hay usuario autenticado, redirigir a login
                console.log('No hay usuario autenticado, redirigiendo a login...');
                
                // Peque√±o delay para asegurar que Firebase Auth termine de inicializar
                setTimeout(() => {
                    redirigirALogin();
                }, 500);
            }
        });
        
        // Funci√≥n para inicializar la p√°gina despu√©s de la autenticaci√≥n
        function inicializarPagina() {
            // Si la p√°gina ya est√° cargada, ejecutar inmediatamente
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', cargarPedidos);
            } else {
                cargarPedidos();
            }
        }
        
        let todosLosPedidos = [];
        let pedidosFiltrados = [];
        let dataTable;

        // Elementos del DOM
        const loadingDiv = document.getElementById('loadingDiv');
        const tableContainer = document.getElementById('tableContainer');
        const pedidosTableBody = document.getElementById('pedidosTableBody');
        
        // Estad√≠sticas
        const totalPedidosEl = document.getElementById('totalPedidos');
        const totalVentasEl = document.getElementById('totalVentas');
        const totalClientesEl = document.getElementById('totalClientes');
        const promedioVentaEl = document.getElementById('promedioVenta');
        
        // Filtros
        const filtroFechaDesde = document.getElementById('filtroFechaDesde');
        const filtroFechaHasta = document.getElementById('filtroFechaHasta');
        const filtroCliente = document.getElementById('filtroCliente');
        const filtroTipoCliente = document.getElementById('filtroTipoCliente');
        const filtroEntrega = document.getElementById('filtroEntrega');

        // Botones
        const aplicarFiltrosBtn = document.getElementById('aplicarFiltros');
        const limpiarFiltrosBtn = document.getElementById('limpiarFiltros');
        const exportarExcelBtn = document.getElementById('exportarExcel');
        const refrescarDatosBtn = document.getElementById('refrescarDatos');

        // Funciones de utilidad
        function formatearFecha(fecha) {
            if (!fecha) return '';
            const date = new Date(fecha);
            return date.toLocaleDateString('es-AR') + ' ' + date.toLocaleTimeString('es-AR', {hour: '2-digit', minute: '2-digit'});
        }

        function formatearMoneda(monto) {
            if (!monto) return '$0';
            return '$' + parseInt(monto).toLocaleString('es-AR');
        }

        function obtenerEstadoBadge(estado) {
            if (!estado) estado = 'pendiente';
            const badgeClass = estado === 'completado' ? 'status-completado' : 
                             estado === 'cancelado' ? 'status-cancelado' : 'status-pendiente';
            return `<span class="status-badge ${badgeClass}">${estado}</span>`;
        }

        function truncarTexto(texto, maxLength = 50) {
            if (!texto) return '';
            return texto.length > maxLength ? texto.substring(0, maxLength) + '...' : texto;
        }

        function formatearItems(items) {
            if (!items || !Array.isArray(items)) return '';
            return items.map(item => `${item.nombre} (${item.cantidad})`).join(', ');
        }

        // Cargar datos desde Firebase
        function cargarPedidos() {
            console.log('cargarPedidos iniciado');
            const loadingText = document.getElementById('loadingText');
            if (loadingText) {
                loadingText.textContent = 'Cargando pedidos...';
            }
            
            loadingDiv.style.display = 'flex';
            tableContainer.style.display = 'none';
            
            db.ref('pedidos').once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    
                    if (data) {
                        // Optimizaci√≥n avanzada: Procesar datos en chunks muy peque√±os
                        const keys = Object.keys(data);
                        todosLosPedidos = [];
                        
                        const procesarChunk = (index = 0, chunkSize = 50) => { // Reducido el chunk size
                            const endIndex = Math.min(index + chunkSize, keys.length);
                            const startTime = performance.now();
                            
                            // Procesar chunk actual con l√≠mite de tiempo
                            for (let i = index; i < endIndex; i++) {
                                const key = keys[i];
                                const pedido = data[key];
                                pedido.id = key;
                                todosLosPedidos.push(pedido);
                                
                                // Si el procesamiento toma m√°s de 10ms, diferir al siguiente frame
                                if (performance.now() - startTime > 10) {
                                    // Continuar desde donde nos quedamos
                                    requestAnimationFrame(() => procesarChunk(i + 1, chunkSize));
                                    return;
                                }
                            }
                            
                            // Actualizar progreso de manera eficiente
                            const progress = Math.round((endIndex / keys.length) * 100);
                            if (loadingText && progress % 10 === 0) { // Actualizar solo cada 10%
                                loadingText.textContent = `Cargando pedidos... ${progress}%`;
                            }
                            
                            if (endIndex < keys.length) {
                                // Usar requestIdleCallback si est√° disponible
                                if (window.requestIdleCallback) {
                                    window.requestIdleCallback(() => procesarChunk(endIndex, chunkSize), { timeout: 100 });
                                } else {
                                    setTimeout(() => procesarChunk(endIndex, chunkSize), 1);
                                }
                            } else {
                                // Procesamiento completo
                                finalizarCarga();
                            }
                        };
                        
                        const finalizarCarga = () => {
                            // Usar requestIdleCallback para operaciones finales
                            const finalizar = () => {
                                // Ordenar por fecha descendente de manera eficiente
                                todosLosPedidos.sort((a, b) => {
                                    const fechaA = a.fecha ? new Date(a.fecha).getTime() : 0;
                                    const fechaB = b.fecha ? new Date(b.fecha).getTime() : 0;
                                    return fechaB - fechaA;
                                });
                                
                                aplicarFiltros();
                                
                                requestAnimationFrame(() => {
                                    loadingDiv.style.display = 'none';
                                    tableContainer.style.display = 'block';
                                });
                            };
                            
                            if (window.requestIdleCallback) {
                                window.requestIdleCallback(finalizar, { timeout: 1000 });
                            } else {
                                setTimeout(finalizar, 10);
                            }
                        };
                        
                        // Comenzar procesamiento
                        procesarChunk();
                    } else {
                        todosLosPedidos = [];
                        pedidosFiltrados = [];
                        
                        requestAnimationFrame(() => {
                            aplicarFiltros();
                            
                            setTimeout(() => {
                                loadingDiv.style.display = 'none';
                                tableContainer.style.display = 'block';
                            }, 10);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error al cargar pedidos:', error);
                    loadingDiv.innerHTML = '<div class="text-danger">Error al cargar los datos</div>';
                });
        }

        // Aplicar filtros
        function aplicarFiltros() {
            // Optimizaci√≥n cr√≠tica: Limitar tiempo de ejecuci√≥n por frame
            const executeFilters = () => {
                const startTime = performance.now();
                const maxExecutionTime = 16; // ~60fps
                
                // Si hay muchos pedidos, procesar en chunks
                if (todosLosPedidos.length > 500) {
                    procesarFiltrosEnChunks();
                } else {
                    procesarFiltrosDirecto();
                }
                
                function procesarFiltrosDirecto() {
                    pedidosFiltrados = todosLosPedidos.filter(pedido => {
                        // Filtrar solo registros con fecha v√°lida
                        if (!pedido.fecha || pedido.fecha.trim() === '') {
                            return false;
                        }
                        
                        // Pre-calcular valores para evitar accesos repetidos
                        const clienteNombre = pedido.cliente?.nombre || '';
                        const clienteTipo = pedido.cliente?.tipoCliente;
                        const entrega = pedido.entrega;
                        
                        // Filtro por fecha (optimizado)
                        if (filtroFechaDesde.value) {
                            const fechaDesde = new Date(filtroFechaDesde.value);
                            const fechaPedido = new Date(pedido.fecha);
                            if (fechaPedido < fechaDesde) return false;
                        }
                        
                        if (filtroFechaHasta.value) {
                            const fechaHasta = new Date(filtroFechaHasta.value);
                            fechaHasta.setHours(23, 59, 59);
                            const fechaPedido = new Date(pedido.fecha);
                            if (fechaPedido > fechaHasta) return false;
                        }
                        
                        // Filtro por cliente (optimizado)
                        if (filtroCliente.value) {
                            const clienteLower = clienteNombre.toLowerCase();
                            const filtroLower = filtroCliente.value.toLowerCase();
                            if (!clienteLower.includes(filtroLower)) return false;
                        }
                        
                        // Filtro por tipo cliente
                        if (filtroTipoCliente.value && clienteTipo !== filtroTipoCliente.value) {
                            return false;
                        }
                        
                        // Filtro por entrega
                        if (filtroEntrega.value && entrega !== filtroEntrega.value) {
                            return false;
                        }
                        
                        return true;
                    });
                    
                    // Ejecutar renderizado y estad√≠sticas de manera as√≠ncrona
                    requestAnimationFrame(() => {
                        renderizarTabla();
                        setTimeout(() => {
                            actualizarEstadisticas();
                        }, 10);
                    });
                }
                
                function procesarFiltrosEnChunks() {
                    pedidosFiltrados = [];
                    let currentIndex = 0;
                    const chunkSize = 100;
                    
                    const procesarChunk = () => {
                        const endIndex = Math.min(currentIndex + chunkSize, todosLosPedidos.length);
                        const chunkStartTime = performance.now();
                        
                        for (let i = currentIndex; i < endIndex; i++) {
                            const pedido = todosLosPedidos[i];
                            
                            // Filtrar solo registros con fecha v√°lida
                            if (!pedido.fecha || pedido.fecha.trim() === '') {
                                // Si el chunk toma demasiado tiempo, diferir
                                if (performance.now() - chunkStartTime > maxExecutionTime) {
                                    currentIndex = i + 1;
                                    requestAnimationFrame(procesarChunk);
                                    return;
                                }
                                continue;
                            }
                            
                            // Aplicar filtros igual que arriba pero de manera m√°s eficiente
                            let pasaFiltro = true;
                            
                            // Pre-calcular una sola vez
                            const clienteNombre = pedido.cliente?.nombre || '';
                            const clienteTipo = pedido.cliente?.tipoCliente;
                            const entrega = pedido.entrega;
                            
                            // Filtros optimizados
                            if (pasaFiltro && filtroFechaDesde.value) {
                                const fechaDesde = new Date(filtroFechaDesde.value);
                                const fechaPedido = new Date(pedido.fecha);
                                pasaFiltro = fechaPedido >= fechaDesde;
                            }
                            
                            if (pasaFiltro && filtroFechaHasta.value) {
                                const fechaHasta = new Date(filtroFechaHasta.value);
                                fechaHasta.setHours(23, 59, 59);
                                const fechaPedido = new Date(pedido.fecha);
                                pasaFiltro = fechaPedido <= fechaHasta;
                            }
                            
                            if (pasaFiltro && filtroCliente.value) {
                                const clienteLower = clienteNombre.toLowerCase();
                                const filtroLower = filtroCliente.value.toLowerCase();
                                pasaFiltro = clienteLower.includes(filtroLower);
                            }
                            
                            if (pasaFiltro && filtroTipoCliente.value) {
                                pasaFiltro = clienteTipo === filtroTipoCliente.value;
                            }
                            
                            if (pasaFiltro && filtroEntrega.value) {
                                pasaFiltro = entrega === filtroEntrega.value;
                            }
                            
                            if (pasaFiltro) {
                                pedidosFiltrados.push(pedido);
                            }
                            
                            // Si el chunk toma demasiado tiempo, diferir
                            if (performance.now() - chunkStartTime > maxExecutionTime) {
                                currentIndex = i + 1;
                                requestAnimationFrame(procesarChunk);
                                return;
                            }
                        }
                        
                        currentIndex = endIndex;
                        
                        if (currentIndex < todosLosPedidos.length) {
                            requestAnimationFrame(procesarChunk);
                        } else {
                            // Procesamiento completo
                            requestAnimationFrame(() => {
                                renderizarTabla();
                                setTimeout(() => {
                                    actualizarEstadisticas();
                                }, 10);
                            });
                        }
                    };
                    
                    procesarChunk();
                }
            };
            
            // Usar requestIdleCallback con timeout m√°s corto
            if (window.requestIdleCallback) {
                window.requestIdleCallback(executeFilters, { timeout: 500 });
            } else {
                setTimeout(executeFilters, 5);
            }
        }

        // Renderizar tabla
        function renderizarTabla() {
            // Optimizaci√≥n avanzada: Procesar en chunks muy peque√±os para evitar bloqueos
            const procesarEnChunks = () => {
                // Destruir tabla existente primero
                if (dataTable) {
                    dataTable.destroy();
                    dataTable = null;
                }
                
                // Limpiar contenido
                pedidosTableBody.innerHTML = '';
                
                // Procesar datos en chunks peque√±os
                const chunkSize = 25; // Reducido para mejor rendimiento
                let currentIndex = 0;
                const tableData = [];
                
                const procesarChunk = () => {
                    const endIndex = Math.min(currentIndex + chunkSize, pedidosFiltrados.length);
                    
                    // Procesar chunk actual
                    for (let i = currentIndex; i < endIndex; i++) {
                        const pedido = pedidosFiltrados[i];
                        
                        // Pre-calcular valores para evitar accesos repetidos
                        const subtotal = pedido.pagos?.subtotal || 0;
                        const descuento = pedido.pagos?.descuento || 0;
                        const recargo = pedido.pagos?.recargo || 0;
                        const totalFinal = pedido.pagos?.totalFinal || 0;
                        const itemsCount = pedido.items?.length || 0;
                        
                        tableData.push([
                            `<span class="expand-icon">‚ñ∂</span>${truncarTexto(pedido.id, 10)}`,
                            pedido.fecha,
                            truncarTexto(pedido.cliente?.nombre || '', 25),
                            pedido.cliente?.tipoCliente || '',
                            itemsCount ? `${itemsCount} art√≠culo(s)` : 'Sin items',
                            formatearMoneda(subtotal),
                            formatearMoneda(descuento),
                            formatearMoneda(recargo),
                            formatearMoneda(totalFinal),
                            pedido.entrega || '',
                            pedido.vendedor || '',
                            admin ? `<button class="delete-btn" onclick="confirmarEliminacion('${pedido.id}')" title="Eliminar pedido${pedido.locked ? ' (BLOQUEADO - se puede eliminar)' : ''}">
                                <i class="bi bi-trash"></i>${pedido.locked ? ' <i class="bi bi-lock" style="font-size: 0.7em;"></i>' : ''}
                            </button>` : '<span style="color: #999; font-size: 0.8em;">-</span>'
                        ]);
                    }
                    
                    currentIndex = endIndex;
                    
                    if (currentIndex < pedidosFiltrados.length) {
                        // Continuar con el siguiente chunk
                        requestAnimationFrame(procesarChunk);
                    } else {
                        // Todos los datos procesados, inicializar DataTable
                        requestAnimationFrame(inicializarDataTable);
                    }
                };
                
                const inicializarDataTable = () => {
                    // Usar setTimeout para diferir la inicializaci√≥n y permitir que el navegador respire
                    setTimeout(() => {
                        dataTable = $('#pedidosTable').DataTable({
                            data: tableData,
                            language: {
                                url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
                            },
                            responsive: true,
                            pageLength: 25,
                            order: [[1, 'desc']],
                            columnDefs: [
                                { targets: [0], width: '80px' },
                                { 
                                    targets: [1], 
                                    width: '130px',
                                    type: 'num',
                                    render: function(data, type, row) {
                                        if (type === 'display') {
                                            return formatearFecha(data);
                                        }
                                        if (type === 'sort' || type === 'type') {
                                            return data ? new Date(data).getTime() : 0;
                                        }
                                        return data;
                                    }
                                },
                                { targets: [2], width: '150px' },
                                { targets: [3], width: '120px' },
                                { targets: [4], width: '200px' },
                                { targets: [5, 6, 7, 8], width: '100px', className: 'text-end' },
                                { targets: [9, 10], width: '120px' },
                                { targets: [11], width: '60px', orderable: false }
                            ],
                            scrollX: true,
                            fixedHeader: true,
                            dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip',
                            deferRender: true, // Renderizar solo las filas visibles
                            createdRow: function(row, data, dataIndex) {
                                // Optimizaci√≥n: Diferir configuraci√≥n de eventos
                                requestAnimationFrame(() => {
                                    const $row = $(row);
                                    $row.addClass('expandable-row').attr('data-pedido-id', pedidosFiltrados[dataIndex]?.id);
                                    
                                    // Agregar eventos solo a las celdas necesarias
                                    const $clickableCells = $row.find('td:nth-child(1), td:nth-child(5)');
                                    $clickableCells.on('click', function(e) {
                                        e.preventDefault();
                                        if (pedidosFiltrados[dataIndex]) {
                                            toggleRowDetails(row, pedidosFiltrados[dataIndex]);
                                        }
                                    }).css({
                                        'cursor': 'pointer',
                                        'user-select': 'none'
                                    });
                                    
                                    $row.find('td:nth-child(5)').attr('title', 'Haz clic para ver el detalle de los art√≠culos');
                                });
                            }
                        });
                    }, 50); // Peque√±o delay para permitir que el DOM se estabilice
                };
                
                // Comenzar procesamiento
                if (pedidosFiltrados.length > 0) {
                    procesarChunk();
                } else {
                    inicializarDataTable();
                }
            };
            
            // Usar requestIdleCallback si est√° disponible
            if (window.requestIdleCallback) {
                window.requestIdleCallback(procesarEnChunks, { timeout: 2000 });
            } else {
                requestAnimationFrame(procesarEnChunks);
            }
        }

        // Funci√≥n para expandir/contraer detalles de fila
        function toggleRowDetails(row, pedido) {
            // Optimizaci√≥n cr√≠tica: Evitar accesos DOM repetidos
            const expandIcon = row.querySelector('.expand-icon');
            const isExpanded = row.classList.contains('expanded');
            
            // Batch todas las operaciones DOM para evitar forced reflow
            const batchDOMOperations = () => {
                // Cerrar todas las otras filas expandidas de manera eficiente
                const expandedRows = document.querySelectorAll('.expandable-row.expanded');
                const rowsToClose = Array.from(expandedRows).filter(expandedRow => expandedRow !== row);
                
                // Procesar cierre en lotes peque√±os
                const closeRowsBatch = (index = 0) => {
                    const batchSize = 3;
                    const endIndex = Math.min(index + batchSize, rowsToClose.length);
                    
                    for (let i = index; i < endIndex; i++) {
                        const expandedRow = rowsToClose[i];
                        expandedRow.classList.remove('expanded');
                        const icon = expandedRow.querySelector('.expand-icon');
                        if (icon) icon.classList.remove('expanded');
                        const nextRow = expandedRow.nextElementSibling;
                        if (nextRow && nextRow.classList.contains('detail-row')) {
                            nextRow.remove();
                        }
                    }
                    
                    if (endIndex < rowsToClose.length) {
                        requestAnimationFrame(() => closeRowsBatch(endIndex));
                    } else {
                        // Continuar con la operaci√≥n principal
                        processCurrentRow();
                    }
                };
                
                const processCurrentRow = () => {
                    if (isExpanded) {
                        // Contraer la fila actual
                        row.classList.remove('expanded');
                        expandIcon.classList.remove('expanded');
                        const detailRow = row.nextElementSibling;
                        if (detailRow && detailRow.classList.contains('detail-row')) {
                            detailRow.remove();
                        }
                    } else {
                        // Expandir la fila actual
                        row.classList.add('expanded');
                        expandIcon.classList.add('expanded');
                        
                        // Crear fila de detalle de manera as√≠ncrona y eficiente
                        createDetailRowAsync(row, pedido);
                    }
                };
                
                // Comenzar el proceso
                if (rowsToClose.length > 0) {
                    closeRowsBatch();
                } else {
                    processCurrentRow();
                }
            };
            
            // Ejecutar operaciones DOM en el pr√≥ximo frame
            requestAnimationFrame(batchDOMOperations);
        }

        // Funci√≥n optimizada para crear fila de detalle
        function createDetailRowAsync(row, pedido) {
            // Usar requestIdleCallback para operaciones no cr√≠ticas
            const createDetail = () => {
                // Pre-calcular contenido para evitar rec√°lculos
                const detailContent = createDetailContent(pedido);
                
                // Crear elementos de manera eficiente
                const detailRow = document.createElement('tr');
                detailRow.classList.add('detail-row');
                
                // Usar innerHTML una sola vez
                detailRow.innerHTML = `<td colspan="12">${detailContent}</td>`;
                
                // Insertar en el DOM
                row.parentNode.insertBefore(detailRow, row.nextSibling);
            };
            
            if (window.requestIdleCallback) {
                window.requestIdleCallback(createDetail, { timeout: 500 });
            } else {
                setTimeout(createDetail, 10);
            }
        }

        // Funci√≥n optimizada para crear el contenido del detalle
        function createDetailContent(pedido) {
            // Pre-calcular todos los valores para evitar accesos repetidos
            const items = pedido.items || [];
            const totalItems = items.length;
            
            // Optimizaci√≥n: Calcular subtotal de manera m√°s eficiente
            let subtotalCalculado = 0;
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                subtotalCalculado += (item.cantidad || 0) * (item.valorU || 0);
            }
            
            let itemsHtml = '';
            if (totalItems > 0) {
                // Usar array para construir HTML de manera m√°s eficiente
                const itemRows = [];
                itemRows.push(`
                    <table class="items-detail-table">
                        <thead>
                            <tr>
                                <th style="width: 100px">C√≥digo</th>
                                <th>Art√≠culo</th>
                                <th style="width: 80px; text-align: center">Cantidad</th>
                                <th style="width: 120px; text-align: right">Valor Unitario</th>
                                <th style="width: 120px; text-align: right">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                `);
                
                // Procesar items de manera m√°s eficiente
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    const cantidad = item.cantidad || 0;
                    const valorU = item.valorU || 0;
                    const total = cantidad * valorU;
                    
                    itemRows.push(`
                        <tr>
                            <td class="item-codigo">${item.codigo || 'N/A'}</td>
                            <td class="item-nombre">${item.nombre || 'Sin nombre'}</td>
                            <td class="item-cantidad">${cantidad}</td>
                            <td class="item-valor">${formatearMoneda(valorU)}</td>
                            <td class="item-total">${formatearMoneda(total)}</td>
                        </tr>
                    `);
                }
                
                itemRows.push(`
                        </tbody>
                    </table>
                `);
                
                itemsHtml = itemRows.join('');
            } else {
                itemsHtml = '<p style="text-align: center; color: #666; font-style: italic; margin: 20px 0;">No hay art√≠culos en este pedido</p>';
            }
            
            // Pre-calcular valores para evitar accesos repetidos
            const totalFinal = pedido.pagos?.totalFinal || 0;
            
            // Construir HTML de manera m√°s eficiente
            return `
                <div class="detail-content">
                    <div class="detail-header">
                        <div class="detail-title">
                            <i class="bi bi-box-seam"></i> Detalle del Pedido #${pedido.id}
                        </div>
                        <div class="detail-summary">
                            <div class="summary-item">
                                <span class="summary-label">Total Items:</span> ${totalItems}
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Subtotal Calculado:</span> ${formatearMoneda(subtotalCalculado)}
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Total Final:</span> ${formatearMoneda(totalFinal)}
                            </div>
                        </div>
                    </div>
                    ${itemsHtml}
                </div>
            `;
        }

        // Actualizar estad√≠sticas
        function actualizarEstadisticas() {
            // Optimizaci√≥n: Calcular todo de una vez y luego actualizar DOM
            const stats = pedidosFiltrados.reduce((acc, p) => {
                acc.totalPedidos++;
                const total = parseFloat(p.pagos?.totalFinal) || 0;
                acc.totalVentas += total;
                
                const cliente = p.cliente?.nombre;
                if (cliente) {
                    acc.clientesSet.add(cliente);
                }
                
                return acc;
            }, {
                totalPedidos: 0,
                totalVentas: 0,
                clientesSet: new Set()
            });
            
            const promedioVenta = stats.totalPedidos > 0 ? stats.totalVentas / stats.totalPedidos : 0;
            
            // Actualizar DOM una sola vez con requestAnimationFrame
            requestAnimationFrame(() => {
                totalPedidosEl.textContent = stats.totalPedidos;
                totalVentasEl.textContent = formatearMoneda(stats.totalVentas);
                totalClientesEl.textContent = stats.clientesSet.size;
                promedioVentaEl.textContent = formatearMoneda(promedioVenta);
            });
        }

        // Limpiar filtros
        function limpiarFiltros() {
            filtroFechaDesde.value = '';
            filtroFechaHasta.value = '';
            filtroCliente.value = '';
            filtroTipoCliente.value = '';
            filtroEntrega.value = '';
            aplicarFiltros();
        }

        // Exportar a Excel
        function exportarExcel() {
            const datosExport = pedidosFiltrados.map(pedido => ({
                'ID': pedido.id,
                'Fecha': formatearFecha(pedido.fecha),
                'Cliente': pedido.cliente?.nombre || '',
                'Tipo Cliente': pedido.cliente?.tipoCliente || '',
                'Items': formatearItems(pedido.items),
                'Subtotal': parseFloat(pedido.pagos?.subtotal) || 0,
                'Descuento': parseFloat(pedido.pagos?.descuento) || 0,
                'Recargo': parseFloat(pedido.pagos?.recargo) || 0,
                'Total Final': parseFloat(pedido.pagos?.totalFinal) || 0,
                'Entrega': pedido.entrega || '',
                'Vendedor': pedido.vendedor || ''
            }));
            
            const ws = XLSX.utils.json_to_sheet(datosExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Pedidos');
            
            const fechaActual = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `pedidos_${fechaActual}.xlsx`);
        }

        // Funciones para eliminar pedidos
        function confirmarEliminacion(pedidoId) {
            // Verificar permisos de administrador
            if (!admin) {
                alert('Acceso denegado. Esta funci√≥n requiere permisos de administrador.');
                return;
            }
            
            const pedido = todosLosPedidos.find(p => p.id === pedidoId);
            if (!pedido) {
                alert('Pedido no encontrado');
                return;
            }

            // Llenar informaci√≥n del pedido en el modal
            const pedidoInfo = document.getElementById('pedidoInfo');
            const lockedStatus = pedido.locked ? 
                `<div class="pedido-info-item" style="color: #f39c12;">
                    <span class="pedido-info-label">Estado:</span> <i class="bi bi-lock"></i> BLOQUEADO (se eliminar√° de todas formas)
                </div>` : '';
            
            pedidoInfo.innerHTML = `
                <div class="pedido-info-item">
                    <span class="pedido-info-label">ID:</span> ${pedido.id}
                </div>
                <div class="pedido-info-item">
                    <span class="pedido-info-label">Fecha:</span> ${formatearFecha(pedido.fecha)}
                </div>
                <div class="pedido-info-item">
                    <span class="pedido-info-label">Cliente:</span> ${pedido.cliente?.nombre || 'N/A'}
                </div>
                <div class="pedido-info-item">
                    <span class="pedido-info-label">Total:</span> ${formatearMoneda(pedido.pagos?.totalFinal || 0)}
                </div>
                <div class="pedido-info-item">
                    <span class="pedido-info-label">Items:</span> ${(pedido.items && pedido.items.length) || 0} art√≠culo(s)
                </div>
                ${lockedStatus}
            `;

            // Establecer el ID del pedido a eliminar
            document.getElementById('deletePedidoId').value = pedidoId;
            
            // Limpiar el campo de contrase√±a
            document.getElementById('deletePassword').value = '';
            
            // Deshabilitar el bot√≥n de confirmaci√≥n
            document.getElementById('confirmDelete').disabled = true;

            // Mostrar el modal
            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            modal.show();
        }

        function validarClave() {
            const password = document.getElementById('deletePassword').value;
            const confirmBtn = document.getElementById('confirmDelete');
            
            if (password === '212118') {
                confirmBtn.disabled = false;
            } else {
                confirmBtn.disabled = true;
            }
        }

        function eliminarPedido() {
            // Verificar permisos de administrador
            if (!admin) {
                alert('Acceso denegado. Esta funci√≥n requiere permisos de administrador.');
                return;
            }
            
            const pedidoId = document.getElementById('deletePedidoId').value;
            const password = document.getElementById('deletePassword').value;
            
            if (password !== '212118') {
                alert('Clave incorrecta');
                return;
            }

            // Mostrar loading en el bot√≥n
            const confirmBtn = document.getElementById('confirmDelete');
            const originalText = confirmBtn.innerHTML;
            confirmBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Eliminando...';
            confirmBtn.disabled = true;

            // NOTA: Esta funci√≥n elimina el pedido independientemente del campo "locked"
            // La eliminaci√≥n se ejecuta aun cuando el registro tenga locked = true
            
            // Intentar m√∫ltiples m√©todos de eliminaci√≥n para superar restricciones de permisos
            const eliminarConPermisos = async () => {
                try {
                    // M√©todo 1: Eliminaci√≥n directa
                    await db.ref('pedidos/' + pedidoId).remove();
                    return { success: true, method: 'direct' };
                } catch (error1) {
                    console.warn('M√©todo directo fall√≥, intentando alternativo:', error1);
                    
                    try {
                        // M√©todo 2: Establecer valor null (equivalente a eliminar)
                        await db.ref('pedidos/' + pedidoId).set(null);
                        return { success: true, method: 'set_null' };
                    } catch (error2) {
                        console.warn('M√©todo set null fall√≥, intentando actualizaci√≥n:', error2);
                        
                        try {
                            // M√©todo 3: Marcar como eliminado sin borrar f√≠sicamente
                            await db.ref('pedidos/' + pedidoId).update({
                                eliminado: true,
                                fechaEliminacion: new Date().toISOString(),
                                eliminadoPor: 'sistema'
                            });
                            return { success: true, method: 'mark_deleted' };
                        } catch (error3) {
                            console.error('Todos los m√©todos fallaron:', error3);
                            return { success: false, error: error3 };
                        }
                    }
                }
            };

            // Ejecutar eliminaci√≥n
            eliminarConPermisos()
                .then((result) => {
                    if (result.success) {
                        // Eliminar de los arrays locales
                        todosLosPedidos = todosLosPedidos.filter(p => p.id !== pedidoId);
                        
                        // Cerrar modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                        modal.hide();

                        // Refrescar tabla
                        aplicarFiltros();
                        actualizarEstadisticas();

                        // Mostrar mensaje de √©xito con m√©todo usado
                        const metodosMsg = {
                            'direct': 'eliminado correctamente',
                            'set_null': 'eliminado correctamente (m√©todo alternativo)',
                            'mark_deleted': 'marcado como eliminado (el registro permanece pero se oculta)'
                        };
                        alert(`Pedido ${metodosMsg[result.method]}`);
                    } else {
                        throw result.error;
                    }
                })
                .catch(error => {
                    console.error('Error al eliminar pedido:', error);
                    let errorMsg = 'Error desconocido';
                    
                    if (error.code === 'PERMISSION_DENIED') {
                        errorMsg = 'Sin permisos para eliminar. Contacte al administrador del sistema.';
                    } else if (error.message) {
                        errorMsg = error.message;
                    }
                    
                    alert('Error al eliminar el pedido: ' + errorMsg);
                })
                .finally(() => {
                    // Restaurar bot√≥n
                    confirmBtn.innerHTML = originalText;
                    confirmBtn.disabled = false;
                });
        }

        // Funci√≥n global para acceso desde onclick
        window.confirmarEliminacion = confirmarEliminacion;

        // Funci√≥n para cerrar sesi√≥n
        function cerrarSesion() {
            if (confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')) {
                firebase.auth().signOut()
                    .then(() => {
                        console.log('Sesi√≥n cerrada exitosamente');
                        // La redirecci√≥n se manejar√° autom√°ticamente por onAuthStateChanged
                    })
                    .catch(error => {
                        console.error('Error al cerrar sesi√≥n:', error);
                        alert('Error al cerrar sesi√≥n: ' + error.message);
                    });
            }
        }

        // Event Listeners
        aplicarFiltrosBtn.addEventListener('click', aplicarFiltros);
        limpiarFiltrosBtn.addEventListener('click', limpiarFiltros);
        exportarExcelBtn.addEventListener('click', exportarExcel);
        refrescarDatosBtn.addEventListener('click', cargarPedidos);

        // Event listeners para los botones de logout
        document.getElementById('logoutBtn')?.addEventListener('click', cerrarSesion);
        document.getElementById('logoutBtnUser')?.addEventListener('click', cerrarSesion);

        // Event listeners para el modal de eliminaci√≥n
        document.getElementById('deletePassword').addEventListener('input', validarClave);
        document.getElementById('confirmDelete').addEventListener('click', eliminarPedido);

        // Aplicar filtros autom√°ticamente cuando cambien los inputs
        [filtroFechaDesde, filtroFechaHasta, filtroCliente, filtroTipoCliente, filtroEntrega].forEach(input => {
            input.addEventListener('change', aplicarFiltros);
            if (input.type === 'text' || input.type === 'number') {
                input.addEventListener('input', debounce(aplicarFiltros, 500));
            }
        });

        // Funci√≥n debounce para evitar demasiadas llamadas
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Cargar datos al iniciar - se movi√≥ a onAuthStateChanged
        // document.addEventListener('DOMContentLoaded', cargarPedidos);
    </script>
</body>
</html>
