<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balance de Cuentas</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-danger {
            background: #dc3545;
        }
        .balance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .balance-table th, .balance-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .balance-table th {
            background: #f1f1f1;
        }
        .entrada {
            color: #0056b3;
        }
        .salida {
            color: #28a745;
        }
        .saldo-positivo {
            color: #0056b3;
            font-weight: bold;
        }
        .saldo-negativo {
            color: #28a745;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Balance de Cuentas</h1>
        
        <!-- Formulario para nuevo registro -->
    <div class="form-section">
            <h3>Nuevo Movimiento</h3>
            <form id="movimientoForm">
                <div class="form-group">
                    <label for="nombre">Nombre:</label>
                    <input type="text" id="nombre" list="listaNombres" autocomplete="off" required>
                    <datalist id="listaNombres"></datalist>
                </div>
                
                <div class="form-group">
                    <label for="tipoMovimiento">Tipo de Movimiento:</label>
                    <select id="tipoMovimiento" required>
                        <option value="">Seleccionar...</option>
                        <option value="compra">Compra</option>
                        <option value="pago">Pago</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="monto">Monto:</label>
                    <input type="number" id="monto" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label for="concepto">Concepto:</label>
                    <input type="text" id="concepto">
                </div>
                
                <div class="form-group">
                    <label for="fecha">Fecha:</label>
                    <input type="date" id="fecha" required>
                </div>
                
                <button type="submit" class="btn">Registrar Movimiento</button>
            </form>
        </div>
        
        <!-- Resumen por proveedor -->
        <div class="form-section">
                <!-- Filtro de proveedor -->
                <div class="form-group">
                    <label for="filtroNombre">Filtrar por Nombre:</label>
                    <select id="filtroNombre">
                        <option value="">Todos</option>
                    </select>
                </div>
            <h3>Resumen por Nombre</h3>
            <div id="resumenNombres"></div>
        </div>
        
        <!-- Historial de movimientos -->
        <div class="form-section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>Historial de Movimientos</h3>
                <button class="btn btn-success" type="button" onclick="imprimirHistorial()">Imprimir Reporte</button>
            </div>
            <table class="balance-table" id="tablaMovimientos">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Nombre</th>
                        <th>Tipo</th>
                        <th>Monto</th>
                        <th>Concepto</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="configAdm.js"></script>
    
    <script>
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
    const balanceRef = database.ref('balanceCuentas');
        
        // Establecer fecha actual por defecto
        document.getElementById('fecha').valueAsDate = new Date();
        
        // Manejar envío del formulario
        document.getElementById('movimientoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            registrarMovimiento();
        });
        
        function registrarMovimiento() {
            const nombre = document.getElementById('nombre').value;
            const tipoMovimiento = document.getElementById('tipoMovimiento').value;
            const monto = parseFloat(document.getElementById('monto').value);
            const concepto = document.getElementById('concepto').value;
            const fecha = document.getElementById('fecha').value;
            
            const movimiento = {
                nombre: nombre,
                tipo: tipoMovimiento,
                monto: monto,
                concepto: concepto,
                fecha: fecha,
                timestamp: Date.now(),
                segmento: 'cliente'
            };
            
            // Guardar en Firebase
            balanceRef.push(movimiento)
                .then(() => {
                    alert('Movimiento registrado exitosamente');
                    document.getElementById('movimientoForm').reset();
                    document.getElementById('fecha').valueAsDate = new Date();
                    cargarMovimientos();
                })
                .catch((error) => {
                    alert('Error al registrar movimiento: ' + error.message);
                });
        }
        
        function cargarMovimientos() {
            balanceRef.orderByChild('timestamp').on('value', (snapshot) => {
                const movimientos = [];
                snapshot.forEach((childSnapshot) => {
                    const movimiento = childSnapshot.val();
                    movimiento.id = childSnapshot.key;
                    // Solo agregar si segmento es 'cliente'
                    if (movimiento.segmento === 'cliente') {
                        movimientos.push(movimiento);
                    }
                });
                const listaMovimientos = movimientos.reverse();
                actualizarFiltroNombres(listaMovimientos);
                aplicarFiltroNombre(listaMovimientos);
            });
        }
        // Actualiza el select de proveedores únicos
        function actualizarFiltroNombres(movimientos) {
            const select = document.getElementById('filtroNombre');
            const nombres = Array.from(new Set(movimientos.map(m => m.nombre))).sort();
            const valorActual = select.value;
            select.innerHTML = '<option value="">Todos</option>' + nombres.map(p => `<option value="${p}">${p}</option>`).join('');
            // Mantener selección si es posible
            if (nombres.includes(valorActual)) {
                select.value = valorActual;
            }

            // Actualizar datalist del input nombre
            const datalist = document.getElementById('listaNombres');
            datalist.innerHTML = nombres.map(p => `<option value="${p}"></option>`).join('');
        }

        // Aplica el filtro seleccionado
        function aplicarFiltroNombre(movimientos) {
            const filtro = document.getElementById('filtroNombre').value;
            let filtrados = movimientos;
            if (filtro) {
                filtrados = movimientos.filter(m => m.nombre === filtro);
            }
            mostrarMovimientos(filtrados);
            calcularResumenNombres(filtrados);
        }

        // Escuchar cambios en el filtro
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('filtroNombre').addEventListener('change', function() {
                // Recargar movimientos y aplicar filtro
                balanceRef.orderByChild('timestamp').once('value', (snapshot) => {
                    const movimientos = [];
                    snapshot.forEach((childSnapshot) => {
                        const movimiento = childSnapshot.val();
                        movimiento.id = childSnapshot.key;
                        movimientos.push(movimiento);
                    });
                    const listaMovimientos = movimientos.reverse();
                    aplicarFiltroNombre(listaMovimientos);
                });
            });
        });
        
        function mostrarMovimientos(movimientos) {
            const tbody = document.querySelector('#tablaMovimientos tbody');
            tbody.innerHTML = '';
            movimientos.forEach(movimiento => {
                const row = document.createElement('tr');
                let tipoClass, montoFormateado, tipoTexto;
                if (movimiento.tipo === 'compra') {
                    tipoClass = 'entrada';
                    montoFormateado = `+$${movimiento.monto.toFixed(2)}`;
                    tipoTexto = 'Compra';
                } else {
                    tipoClass = 'salida';
                    montoFormateado = `-$${movimiento.monto.toFixed(2)}`;
                    tipoTexto = 'Pago';
                }
                row.innerHTML = `
                    <td>${movimiento.fecha}</td>
                    <td>${movimiento.nombre}</td>
                    <td>${tipoTexto}</td>
                    <td class="${tipoClass}">${montoFormateado}</td>
                    <td>${movimiento.concepto}</td>
                    <td>
                        <button class="btn btn-danger" onclick="eliminarMovimiento('${movimiento.id}')">
                            Eliminar
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function calcularResumenNombres(movimientos) {
            const nombres = {};
            movimientos.forEach(movimiento => {
                if (!nombres[movimiento.nombre]) {
                    nombres[movimiento.nombre] = {
                        compras: 0,
                        pagos: 0,
                        saldo: 0
                    };
                }
                if (movimiento.tipo === 'compra') {
                    nombres[movimiento.nombre].compras += movimiento.monto;
                } else {
                    nombres[movimiento.nombre].pagos += movimiento.monto;
                }
                nombres[movimiento.nombre].saldo = 
                    nombres[movimiento.nombre].compras - 
                    nombres[movimiento.nombre].pagos;
            });
            mostrarResumenNombres(nombres);
        }
        
        function mostrarResumenNombres(nombres) {
            const div = document.getElementById('resumenNombres');
            div.innerHTML = '';
            if (Object.keys(nombres).length === 0) {
                div.innerHTML = '<p>No hay movimientos registrados.</p>';
                return;
            }
            const tabla = document.createElement('table');
            tabla.className = 'balance-table';
            tabla.innerHTML = `
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Total Compras</th>
                        <th>Total Pagos</th>
                        <th>Saldo</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            const tbody = tabla.querySelector('tbody');
            Object.keys(nombres).forEach(nombre => {
                const persona = nombres[nombre];
                const saldoClass = persona.saldo >= 0 ? 'saldo-positivo' : 'saldo-negativo';
                const saldoTooltip = persona.saldo >= 0 ? 'DEUDA' : 'A FAVOR';
                row = document.createElement('tr');
                row.innerHTML = `
                    <td>${nombre}</td>
                    <td class="entrada">$${persona.compras.toFixed(2)}</td>
                    <td class="salida">$${persona.pagos.toFixed(2)}</td>
                    <td class="${saldoClass}" title="${saldoTooltip}">$${persona.saldo.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
            div.appendChild(tabla);
        }
        
        function eliminarMovimiento(id) {
            if (confirm('¿Está seguro de que desea eliminar este movimiento?')) {
                balanceRef.child(id).remove()
                    .then(() => {
                        alert('Movimiento eliminado exitosamente');
                    })
                    .catch((error) => {
                        alert('Error al eliminar movimiento: ' + error.message);
                    });
            }
        }
        
        // Cargar movimientos al cargar la página
        window.addEventListener('load', cargarMovimientos);
    // Imprimir solo la tabla de movimientos
    function imprimirHistorial() {
        // Clonar la tabla y eliminar la columna Acciones
        const tablaOriginal = document.getElementById('tablaMovimientos');
        const tablaClon = tablaOriginal.cloneNode(true);
        // Eliminar la última columna de los encabezados
        const ths = tablaClon.querySelectorAll('thead th');
        if (ths.length > 0) ths[ths.length - 1].remove();
        // Eliminar la última celda de cada fila
        tablaClon.querySelectorAll('tbody tr').forEach(tr => {
            if (tr.children.length > 0) tr.removeChild(tr.lastElementChild);
        });
        // Obtener proveedor seleccionado
        const filtroProveedor = document.getElementById('filtroProveedor');
        let proveedorTitulo = '';
        if (filtroProveedor && filtroProveedor.value) {
            proveedorTitulo = ' - Proveedor: ' + filtroProveedor.value;
        }
        const estilo = `<style>table{width:100%;border-collapse:collapse;}th,td{border:1px solid #ddd;padding:8px;}th{background:#f1f1f1;}</style>`;
        const win = window.open('', '', 'width=900,height=700');
        win.document.write('<html><head><title>Reporte de Movimientos</title>' + estilo + '</head><body>');
        win.document.write('<h2>Reporte de Movimientos' + proveedorTitulo + '</h2>');
        win.document.write(tablaClon.outerHTML);
        win.document.write('</body></html>');
        win.document.close();
        win.print();
    }
    </script>
</body>
</html>
