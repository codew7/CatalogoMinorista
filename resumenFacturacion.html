<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resumen de Facturaci√≥n - Distribuidora HomePoint</title>
    <link rel="icon" href="faviconnegro.png" type="image/png">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
            --dark-text: #2c3e50;
            --border-color: #dee2e6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark-text);
        }

        .container-fluid {
            padding: 20px;
        }

        .main-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 10px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(-20px, -20px) rotate(180deg); }
        }

        .header h1 {
            position: relative;
            z-index: 2;
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .header p {
            position: relative;
            z-index: 2;
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .controls-section {
            padding: 30px;
            background: var(--light-bg);
            border-bottom: 2px solid var(--border-color);
        }

        .year-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: space-between;
        }

        .temporalidad-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .temporalidad-selector label {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.1rem;
            margin-right: 5px;
        }

        .temporalidad-buttons {
            display: flex;
            gap: 5px;
        }

        .btn-temporalidad {
            padding: 8px 16px;
            border: 2px solid var(--primary-color);
            border-radius: 20px;
            background: white;
            color: var(--primary-color);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-temporalidad:hover {
            background: rgba(44, 62, 80, 0.1);
            transform: translateY(-1px);
        }

        .btn-temporalidad.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 3px 10px rgba(44, 62, 80, 0.3);
        }

        .year-selector label {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .entrega-filter {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }

        .entrega-filter label {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.1rem;
            margin-right: 5px;
        }

        .filter-buttons {
            display: flex;
            gap: 5px;
        }

        .btn-filter {
            padding: 8px 16px;
            border: 2px solid var(--secondary-color);
            border-radius: 20px;
            background: white;
            color: var(--secondary-color);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-filter:hover {
            background: rgba(52, 152, 219, 0.1);
            transform: translateY(-1px);
        }

        .btn-filter.active {
            background: var(--secondary-color);
            color: white;
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.3);
        }

        .form-select {
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 12px 15px;
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-color);
            width: 200px;
        }

        .form-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
            outline: none;
        }

        .btn {
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .content-section {
            padding: 30px;
        }

        .facturacion-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-radius: 10px;
            overflow: hidden;
        }

        .facturacion-table thead th {
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            padding: 15px 10px;
            border: none;
            text-align: center;
        }

        .facturacion-table tbody td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .facturacion-table tbody tr:hover {
            background: rgba(52, 152, 219, 0.05);
        }

        .facturacion-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .mes-name {
            font-weight: 700;
            color: var(--primary-color);
            text-align: left !important;
            padding-left: 20px !important;
        }

        .currency-cell {
            color: var(--success-color);
            font-weight: 600;
        }

        .percentage-cell {
            font-weight: 600;
            color: var(--secondary-color);
        }

        .facturacion-cell {
            color: #555;
            font-weight: 600;
        }

        .ganancia-cell {
            color: #27ae60;
            font-weight: 600;
        }

        .gastos-cell {
            color: #c0392b;
            font-weight: 600;
        }

        .total-row {
            background: linear-gradient(135deg, #ecf0f1, #bdc3c7) !important;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .total-row:hover {
            background: linear-gradient(135deg, #d5dbdb, #a6acaf) !important;
        }

        .total-row td {
            border-top: 3px solid var(--primary-color);
            padding: 18px 10px !important;
        }

        .expandable-icon {
            font-size: 12px;
            margin-right: 8px;
            transition: transform 0.3s ease;
            display: inline-block;
        }

        .expandable-icon.expanded {
            transform: rotate(90deg);
        }

        .detail-row {
            background-color: #f8f9fa !important;
            border-left: 4px solid var(--secondary-color);
            display: none;
        }

        .detail-row.show {
            display: table-row;
        }

        .detail-row td {
            padding-left: 40px !important;
            font-style: italic;
            color: var(--secondary-color);
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-top: 30px;
            margin-bottom: 20px;
            height: 400px;
        }

        .chart-title {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 30px;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.2rem;
            color: var(--secondary-color);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            border-left: 5px solid var(--secondary-color);
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.success {
            border-left-color: var(--success-color);
        }

        .stat-card.warning {
            border-left-color: var(--warning-color);
        }

        .stat-number {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--secondary-color);
            margin-bottom: 8px;
        }

        .stat-number.success {
            color: var(--success-color);
        }

        .stat-number.warning {
            color: var(--warning-color);
        }

        .stat-label {
            font-size: 1rem;
            color: var(--primary-color);
            font-weight: 600;
        }

        .no-data {
            text-align: center;
            padding: 50px;
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        /* Modal de reporte detallado */
        .modal-reporte {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 15px;
            width: 95%;
            max-width: 1200px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease;
        }

        .close-modal:hover {
            background-color: rgba(255,255,255,0.2);
        }

        .modal-body {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .reporte-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .reporte-stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid var(--secondary-color);
        }

        .reporte-stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .reporte-stat-label {
            font-size: 0.9rem;
            color: #666;
            font-weight: 600;
        }

        .reporte-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.85rem;
        }

        .reporte-table th {
            background: var(--primary-color);
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .reporte-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #dee2e6;
            vertical-align: top;
        }

        .reporte-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .reporte-table tbody tr:nth-child(even) {
            background-color: #fafafa;
        }

        .clickable-cell {
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .clickable-cell:hover {
            background-color: rgba(52, 152, 219, 0.1);
            transform: scale(1.02);
        }

        .clickable-cell::after {
            content: 'üîç';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .clickable-cell:hover::after {
            opacity: 0.7;
        }

        .header-actions {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 3;
        }

        /* Modal de Gastos */
        .modal-gastos {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }

        .modal-gastos-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 15px;
            width: 95%;
            max-width: 1000px;
            height: 95%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        .modal-gastos-header {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-gastos-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }

        .modal-gastos-body {
            padding: 30px;
            max-height: 90%;
            overflow-y: auto;
        }

        .gastos-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid var(--warning-color);
        }

        .form-row {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-row-first {
            grid-template-columns: 1fr 2fr 1fr 1fr;
        }

        .form-row-second {
            grid-template-columns: 2fr 1fr;
            align-items: end;
        }

        .form-group-nota {
            align-self: start;
        }

        .btn-group-gastos {
            display: flex;
            justify-content: center;
            align-self: end;
            margin-top: 25px;
        }

        .btn-agregar-gasto {
            height: 46px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 220px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 15px;
            font-size: 14px;
            font-weight: 500;
            color: var(--primary-color);
            transition: border-color 0.3s ease;
            background-color: white;
        }

        /* Ocultar flechas del input number */
        .form-group input[type="number"]::-webkit-outer-spin-button,
        .form-group input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .form-group input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: var(--warning-color);
            box-shadow: 0 0 0 0.2rem rgba(243, 156, 18, 0.25);
            outline: none;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group select {
            cursor: pointer;
        }

        .btn-agregar-gasto {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-agregar-gasto:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }

        .gastos-lista {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .gastos-table {
            width: 100%;
            border-collapse: collapse;
        }

        .gastos-table thead th {
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            padding: 15px 10px;
            border: none;
            text-align: center;
        }

        .gastos-table tbody td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .gastos-table tbody tr:hover {
            background: rgba(243, 156, 18, 0.05);
        }

        .gastos-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .gastos-concepto {
            text-align: left !important;
            font-weight: 600;
            color: var(--primary-color);
        }

        .gastos-valor {
            color: var(--danger-color);
            font-weight: 600;
        }

        .gastos-cuenta {
            color: var(--secondary-color);
            font-weight: 600;
            text-align: center !important;
        }

        .gastos-nota {
            text-align: left !important;
            font-style: italic;
            color: #666;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .btn-eliminar-gasto {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-eliminar-gasto:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .gastos-resumen {
            background: linear-gradient(135deg, #ecf0f1, #bdc3c7);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .gastos-total {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--danger-color);
            margin-bottom: 5px;
        }

        .gastos-periodo {
            font-size: 1rem;
            color: var(--primary-color);
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .container-fluid {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .year-selector {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .temporalidad-selector {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .temporalidad-buttons {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .btn-temporalidad {
                font-size: 0.8rem;
                padding: 6px 12px;
            }
            
            .entrega-filter {
                margin-left: 0;
                justify-content: center;
            }
            
            .filter-buttons {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .btn-filter {
                font-size: 0.8rem;
                padding: 6px 12px;
            }
            
            .form-select {
                width: 100%;
            }
            
            .facturacion-table {
                font-size: 0.8rem;
            }
            
            .facturacion-table thead th,
            .facturacion-table tbody td {
                padding: 8px 5px;
            }
            
            .form-row-first,
            .form-row-second {
                grid-template-columns: 1fr;
            }
            
            .header-actions {
                position: static;
                margin-top: 15px;
                text-align: center;
            }
            
            .modal-gastos-content {
                width: 98%;
                margin: 1% auto;
            }
            
            .btn-group-gastos {
                margin-top: 15px;
            }

            .btn-agregar-gasto {
                height: 46px;
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="main-card">
            <div class="header">
                <h1><i class="bi bi-graph-up"></i> Distribuidora HomePoint</h1>
                <p>Resumen de Facturaci√≥n y Ganancia por Mes</p>
                
                <!-- Bot√≥n para gestionar gastos -->
                <div class="header-actions">
                    <button class="btn btn-outline-light" id="btnGestionarGastos">
                        <i class="bi bi-wallet2"></i> Gestionar Gastos
                    </button>
                </div>
            </div>

            <!-- Controles -->
            <div class="controls-section">
                <div class="year-selector">
                    <!-- Selector de Temporalidad -->
                    <div class="temporalidad-selector">
                        <label>Temporalidad:</label>
                        <div class="temporalidad-buttons">
                            <button class="btn-temporalidad active" data-temporalidad="mensual">Mensual</button>
                            <button class="btn-temporalidad" data-temporalidad="semanal">Semanal</button>
                            <button class="btn-temporalidad" data-temporalidad="diario">Diario</button>
                        </div>
                    </div>
                    
                    <label for="yearSelect">A√±o:</label>
                    <select class="form-select" id="yearSelect">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                    </select>
                    <button class="btn btn-primary" id="actualizarBtn">
                        <i class="bi bi-arrow-clockwise"></i> Actualizar
                    </button>
                    
                    <!-- Filtro de Entrega -->
                    <div class="entrega-filter">
                        <label>Entrega:</label>
                        <div class="filter-buttons">
                            <button class="btn-filter active" data-filter="todas">Todas</button>
                            <button class="btn-filter" data-filter="Local">Local</button>
                            <button class="btn-filter" data-filter="Envios">Env√≠os</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenido Principal -->
            <div class="content-section">
                <!-- Loading -->
                <div id="loadingDiv" class="loading">
                    <div class="spinner"></div>
                    <span id="loadingText">Cargando datos de facturaci√≥n...</span>
                </div>

                <!-- Estad√≠sticas Resumen -->
                <div id="statsContainer" class="stats-cards" style="display: none;">
                    <div class="stat-card success">
                        <div class="stat-number success" id="totalFacturacion">$0</div>
                        <div class="stat-label">Total Facturaci√≥n</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalGanancia">$0</div>
                        <div class="stat-label">Ganancia Neta</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-number warning" id="porcentajeGanancia">0%</div>
                        <div class="stat-label">% Ganancia</div>
                    </div>
                </div>

                <!-- Tabla de Facturaci√≥n -->
                <div id="tableContainer" style="display: none;">
                    <table class="facturacion-table">
                        <thead>
                            <tr id="tableHeaders">
                                <th>Per√≠odo</th>
                                <th>Ene</th>
                                <th>Feb</th>
                                <th>Mar</th>
                                <th>Abr</th>
                                <th>May</th>
                                <th>Jun</th>
                                <th>Jul</th>
                                <th>Ago</th>
                                <th>Sept</th>
                                <th>Oct</th>
                                <th>Nov</th>
                                <th>Dic</th>
                                <th>TOTAL</th>
                            </tr>
                        </thead>
                        <tbody id="facturacionTableBody">
                            <!-- Datos se cargar√°n din√°micamente -->
                        </tbody>
                    </table>
                </div>

                <!-- Gr√°fico -->
                <div id="chartContainer" class="chart-container" style="display: none;">
                    <div class="chart-title" id="chartTitle">Ganancia Neta</div>
                    <canvas id="gananciaChart" width="400" height="200"></canvas>
                </div>

                <!-- Sin datos -->
                <div id="noDataDiv" class="no-data" style="display: none;">
                    <i class="bi bi-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                    <p>No hay datos de facturaci√≥n para el a√±o seleccionado</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Reporte Detallado -->
    <div id="modalReporte" class="modal-reporte">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Detalle de Registros</h2>
                <button class="close-modal" onclick="cerrarModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="reporte-stats" id="reporteStats">
                    <!-- Estad√≠sticas se cargar√°n din√°micamente -->
                </div>
                <div id="reporteTablaContainer">
                    <!-- Tabla de detalles se cargar√° din√°micamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Gesti√≥n de Gastos -->
    <div id="modalGastos" class="modal-gastos">
        <div class="modal-gastos-content">
            <div class="modal-gastos-header">
                <h2 class="modal-gastos-title">
                    <i class="bi bi-wallet2"></i> Gesti√≥n de Gastos
                </h2>
                <button class="close-modal" onclick="cerrarModalGastos()">&times;</button>
            </div>
            <div class="modal-gastos-body">
                <!-- Formulario para agregar gastos -->
                <div class="gastos-form">
                    <h3 style="margin-bottom: 20px; color: var(--primary-color);">
                        <i class="bi bi-plus-circle"></i> Agregar Nuevo Gasto
                    </h3>
                    <form id="formAgregarGasto">
                        <div class="form-row form-row-first">
                            <div class="form-group">
                                <label for="fechaGasto">Fecha</label>
                                <input type="date" id="fechaGasto" name="fecha" required>
                            </div>
                            <div class="form-group">
                                <label for="conceptoGasto">Concepto</label>
                                <input type="text" id="conceptoGasto" name="concepto" list="conceptosDatalist"
                                       placeholder="Ej: Alquiler, Servicios, Compras..." required autocomplete="off">
                                <datalist id="conceptosDatalist">
                                    <!-- Se llenar√° din√°micamente con conceptos anteriores -->
                                </datalist>
                            </div>
                            <div class="form-group">
                                <label for="valorGasto">Valor ($)</label>
                                <input type="number" id="valorGasto" name="valor" 
                                       placeholder="0.00" step="0.01" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="cuentaGasto">Cuenta</label>
                                <select id="cuentaGasto" name="cuenta" class="form-select" required>
                                    <option value="Ambas" selected>Ambas (50%)</option>
                                    <option value="Local">Local</option>
                                    <option value="Envios">Env√≠os</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row form-row-second">
                            <div class="form-group form-group-nota">
                                <label for="notaGasto">Nota</label>
                                <input type="text" id="notaGasto" name="nota" 
                                       placeholder="Detalles adicionales sobre este gasto...">
                            </div>
                            <div class="btn-group-gastos">
                                <button type="submit" class="btn-agregar-gasto">
                                    <i class="bi bi-check-circle"></i> Agregar Gasto
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Lista de gastos -->
                <div class="gastos-lista">
                    <h3 style="padding: 20px 20px 0; margin: 10px; color: var(--primary-color);">
                        <i class="bi bi-list-ul"></i> Listado de Gastos
                    </h3>
                    <div id="gastosListaContainer">
                        <!-- La tabla se generar√° din√°micamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="config.js"></script>

    <script>
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        // Variables globales
        let datosFacturacion = {};
        let gananciaChart = null;
        let yearActual = new Date().getFullYear();
        let filtroEntrega = 'todas'; // Filtro de entrega: 'todas', 'local', 'envios'
        let temporalidad = 'mensual'; // Temporalidad: 'mensual', 'semanal', 'diario'
        let periodoLabels = []; // Almacena las etiquetas de los per√≠odos actuales
        let pedidosProcesados = []; // Almacena los pedidos procesados para drill-down
        
        // Variables para gastos
        let gastosData = [];
        let gastosAgrupados = {};
        
        // Elementos del DOM
        const loadingDiv = document.getElementById('loadingDiv');
        const statsContainer = document.getElementById('statsContainer');
        const tableContainer = document.getElementById('tableContainer');
        const chartContainer = document.getElementById('chartContainer');
        const noDataDiv = document.getElementById('noDataDiv');
        const yearSelect = document.getElementById('yearSelect');
        const actualizarBtn = document.getElementById('actualizarBtn');
        
        // Nombres de meses
        const meses = [
            'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
        ];
        
        const mesesCortos = [
            'Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun',
            'Jul', 'Ago', 'Sept', 'Oct', 'Nov', 'Dic'
        ];

        // Verificar autenticaci√≥n
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                inicializarApp();
            } else {
                window.location.href = 'login.html';
            }
        });

        function inicializarApp() {
            // Establecer a√±o actual en el selector
            yearSelect.value = yearActual;
            
            // Configurar filtros de entrega
            configurarFiltrosEntrega();
            
            // Configurar botones de temporalidad
            configurarBotonesTemporalidad();
            
            // Configurar gesti√≥n de gastos
            configurarGestionGastos();
            
            // Cargar gastos primero, luego cargar datos
            cargarGastosIniciales();
        }

        function cargarGastosIniciales() {
            // Cargar gastos desde Firebase al inicio de la aplicaci√≥n
            db.ref('gastos').once('value')
                .then(snapshot => {
                    gastosData = [];
                    gastosAgrupados = { Local: {}, Envios: {} };
                    
                    if (snapshot.exists()) {
                        Object.entries(snapshot.val()).forEach(([gastoId, gasto]) => {
                            gastosData.push({ id: gastoId, ...gasto });
                        });
                        
                        console.log('Gastos cargados al inicio:', gastosData.length);
                        actualizarConceptosDatalist();
                        agruparGastosPorPeriodo(); // Agrupar gastos inmediatamente
                    }
                    
                    // Despu√©s de cargar gastos, cargar los datos de facturaci√≥n
                    cargarDatos();
                })
                .catch(error => {
                    console.error('Error al cargar gastos iniciales:', error);
                    // Continuar con la carga de datos aunque falle la carga de gastos
                    cargarDatos();
                });
        }

        function configurarGestionGastos() {
            const btnGestionarGastos = document.getElementById('btnGestionarGastos');
            if (btnGestionarGastos) {
                btnGestionarGastos.addEventListener('click', abrirModalGastos);
            }
            
            const formAgregarGasto = document.getElementById('formAgregarGasto');
            if (formAgregarGasto) {
                formAgregarGasto.addEventListener('submit', agregarGasto);
            }
            
            // Establecer fecha actual por defecto
            const fechaGasto = document.getElementById('fechaGasto');
            if (fechaGasto) {
                fechaGasto.value = new Date().toISOString().split('T')[0];
            }
            // Establecer opci√≥n por defecto en cuenta
            const cuentaGasto = document.getElementById('cuentaGasto');
            if (cuentaGasto) {
                cuentaGasto.value = 'Ambas';
            }
        }

        function configurarFiltrosEntrega() {
            const filterButtons = document.querySelectorAll('.btn-filter');
            
            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remover clase active de todos los botones
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // Agregar clase active al bot√≥n clickeado
                    button.classList.add('active');
                    
                    // Actualizar filtro
                    filtroEntrega = button.dataset.filter;
                    
                    // Recargar datos con el nuevo filtro
                    cargarDatos();
                });
            });
        }

        function configurarBotonesTemporalidad() {
            const temporalidadButtons = document.querySelectorAll('.btn-temporalidad');
            
            temporalidadButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remover clase active de todos los botones
                    temporalidadButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // Agregar clase active al bot√≥n clickeado
                    button.classList.add('active');
                    
                    // Actualizar temporalidad
                    temporalidad = button.dataset.temporalidad;
                    
                    // Recargar datos con la nueva temporalidad
                    cargarDatos();
                });
            });
        }

        function generarEtiquetasPeriodos() {
            // Usar fecha local de Argentina (GMT-3)
            const ahora = new Date();
            periodoLabels = [];
            
            if (temporalidad === 'mensual') {
                // √öltimos 12 meses
                for (let i = 11; i >= 0; i--) {
                    const fecha = new Date(ahora.getFullYear(), ahora.getMonth() - i, 1);
                    periodoLabels.push(mesesCortos[fecha.getMonth()]);
                }
            } else if (temporalidad === 'semanal') {
                // √öltimas 12 semanas
                for (let i = 11; i >= 0; i--) {
                    // Calcular la fecha de inicio de cada semana
                    const fechaBase = new Date(ahora);
                    fechaBase.setDate(fechaBase.getDate() - (i * 7));
                    
                    // Encontrar el lunes de esa semana (d√≠a 1)
                    const diaSemana = fechaBase.getDay(); // 0=Domingo, 1=Lunes, ..., 6=S√°bado
                    const diasHastaLunes = (diaSemana === 0) ? 6 : diaSemana - 1; // Si es domingo, retroceder 6 d√≠as
                    
                    const inicioSemana = new Date(fechaBase);
                    inicioSemana.setDate(fechaBase.getDate() - diasHastaLunes);
                    
                    const finSemana = new Date(inicioSemana);
                    finSemana.setDate(inicioSemana.getDate() + 6);
                    
                    // Formatear fechas para mostrar d√≠a/mes
                    const inicioStr = `${inicioSemana.getDate()}/${inicioSemana.getMonth() + 1}`;
                    const finStr = `${finSemana.getDate()}/${finSemana.getMonth() + 1}`;
                    
                    periodoLabels.push(`${inicioStr}-${finStr}`);
                }
            } else if (temporalidad === 'diario') {
                // Para vista diaria, inicialmente generamos todas las fechas posibles
                // Luego filtraremos solo las que tienen datos
                for (let i = 30; i >= 0; i--) { // √öltimos 30 d√≠as para tener m√°s opciones
                    const fecha = new Date(ahora);
                    fecha.setDate(fecha.getDate() - i);
                    const etiqueta = `${fecha.getDate()}/${fecha.getMonth() + 1}`;
                    periodoLabels.push(etiqueta);
                }
            }
        }

        function actualizarHeadersTabla() {
            const tableHeaders = document.getElementById('tableHeaders');
            if (!tableHeaders) return;
            
            // Limpiar headers existentes
            tableHeaders.innerHTML = '';
            
            // Primer header
            const firstTh = document.createElement('th');
            firstTh.textContent = 'Per√≠odo';
            tableHeaders.appendChild(firstTh);
            
            // Headers de per√≠odos
            periodoLabels.forEach(label => {
                const th = document.createElement('th');
                th.textContent = label;
                tableHeaders.appendChild(th);
            });
            
            // Header total
            const totalTh = document.createElement('th');
            totalTh.textContent = 'TOTAL';
            tableHeaders.appendChild(totalTh);
        }

        function cargarDatos() {
            const year = parseInt(yearSelect.value);
            
            mostrarLoading(true);
            
            // Generar etiquetas de per√≠odos seg√∫n la temporalidad
            generarEtiquetasPeriodos();
            
            // Actualizar headers de la tabla
            actualizarHeadersTabla();
            
            // Reinicializar datos con la cantidad correcta de per√≠odos
            const numPeriodos = periodoLabels.length;
            datosFacturacion = {
                facturacion: new Array(numPeriodos).fill(0),
                consumidorFinal: new Array(numPeriodos).fill(0),
                mayorista: new Array(numPeriodos).fill(0),
                gastos: new Array(numPeriodos).fill(0),
                gananciaNeta: new Array(numPeriodos).fill(0),
                gananciaPercent: new Array(numPeriodos).fill(0),
                ventasGeneradas: new Array(numPeriodos).fill(0),
                ventasConsumidorFinal: new Array(numPeriodos).fill(0),
                ventasMayoristas: new Array(numPeriodos).fill(0),
                gananciaBruta: new Array(numPeriodos).fill(0),
                // Nuevos campos para el desglose de ganancia
                gananciaBrutaConsumidor: new Array(numPeriodos).fill(0),
                gananciaBrutaMayorista: new Array(numPeriodos).fill(0),
                gananciaSeleccionados: new Array(numPeriodos).fill(0),
                // Nuevos campos para facturaci√≥n por medio de pago
                facturacionEfectivo: new Array(numPeriodos).fill(0),
                facturacionTransferencia: new Array(numPeriodos).fill(0),
                facturacionTarjeta: new Array(numPeriodos).fill(0),
                facturacionOtros: new Array(numPeriodos).fill(0),
                // Nuevos campos para porcentaje de ganancia por tipo de cliente
                gananciaPercentConsumidor: new Array(numPeriodos).fill(0),
                gananciaPercentMayorista: new Array(numPeriodos).fill(0)
            };

            // Cargar pedidos desde Firebase
            db.ref('pedidos').once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        procesarPedidos(snapshot.val(), year);
                        mostrarDatos();
                    } else {
                        mostrarSinDatos();
                    }
                })
                .catch(error => {
                    console.error('Error al cargar datos:', error);
                    mostrarSinDatos();
                });
        }

        function procesarPedidos(pedidos, year) {
            let totalPedidosProcesados = 0;
            let pedidosFiltrados = 0;
            const ahora = new Date();
            const numPeriodos = periodoLabels.length;
            
            // Reinicializar array de pedidos procesados
            pedidosProcesados = [];
            
            // Normalizar fecha actual al inicio del d√≠a para comparaciones consistentes
            const ahoraInicioDelDia = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate());
            
            Object.entries(pedidos).forEach(([pedidoId, pedido]) => {
                if (!pedido.fecha) return;
                
                const fechaPedido = new Date(pedido.fecha);
                // Normalizar fecha del pedido al inicio del d√≠a
                const fechaPedidoInicioDelDia = new Date(fechaPedido.getFullYear(), fechaPedido.getMonth(), fechaPedido.getDate());
                
                // Solo procesar pedidos despachados/entregados
                if (pedido.status !== 'DESPACHADO/ENTREGADO') return;
                
                totalPedidosProcesados++;
                
                // Aplicar filtro de entrega
                if (!aplicarFiltroEntrega(pedido)) return;
                
                // Calcular el √≠ndice del per√≠odo seg√∫n la temporalidad
                let indicePeriodo = -1;
                
                if (temporalidad === 'mensual') {
                    // Solo procesar pedidos del a√±o seleccionado
                    if (fechaPedido.getFullYear() !== year) return;
                    
                    // Calcular √≠ndice basado en los √∫ltimos 12 meses desde ahora
                    const mesesDiferencia = (ahora.getFullYear() - fechaPedido.getFullYear()) * 12 + 
                                          (ahora.getMonth() - fechaPedido.getMonth());
                    indicePeriodo = 11 - mesesDiferencia;
                    
                } else if (temporalidad === 'semanal') {
                    // Calcular diferencia en d√≠as desde el inicio del d√≠a
                    const diferenciaDias = Math.floor((ahoraInicioDelDia - fechaPedidoInicioDelDia) / (1000 * 60 * 60 * 24));
                    
                    // Calcular en qu√© semana cae este pedido
                    // Encontrar el lunes de la semana actual
                    const diaSemanaActual = ahora.getDay();
                    const diasHastaLunesActual = (diaSemanaActual === 0) ? 6 : diaSemanaActual - 1;
                    const lunesActual = new Date(ahoraInicioDelDia);
                    lunesActual.setDate(ahoraInicioDelDia.getDate() - diasHastaLunesActual);
                    
                    // Encontrar el lunes de la semana del pedido
                    const diaSemanaPedido = fechaPedido.getDay();
                    const diasHastaLunesPedido = (diaSemanaPedido === 0) ? 6 : diaSemanaPedido - 1;
                    const lunesPedido = new Date(fechaPedidoInicioDelDia);
                    lunesPedido.setDate(fechaPedidoInicioDelDia.getDate() - diasHastaLunesPedido);
                    
                    // Calcular diferencia en semanas
                    const diferenciaEnSemanas = Math.floor((lunesActual - lunesPedido) / (1000 * 60 * 60 * 24 * 7));
                    indicePeriodo = 11 - diferenciaEnSemanas;
                    
                } else if (temporalidad === 'diario') {
                    // Calcular diferencia en d√≠as desde el inicio del d√≠a
                    const diferenciaDias = Math.floor((ahoraInicioDelDia - fechaPedidoInicioDelDia) / (1000 * 60 * 60 * 24));
                    indicePeriodo = 30 - diferenciaDias; // Usar 30 d√≠as en lugar de 11
                }
                
                // Verificar que el √≠ndice est√© en el rango v√°lido
                if (indicePeriodo < 0 || indicePeriodo >= numPeriodos) return;
                
                pedidosFiltrados++;
                
                // Usar los campos correctos de Firebase
                const totalPedido = pedido.pagos?.totalFinal || 0;
                const gananciaPedido = pedido.pagos?.ganancia || 0;
                const gananciaSelec = pedido.pagos?.gananciaSelec || 0;
                const tipoCliente = pedido.cliente?.tipoCliente || 'consumidor final';
                const medioPago = pedido.pagos?.medioPago || 'Efectivo';
                
                // Almacenar pedido procesado para drill-down
                pedidosProcesados.push({
                    id: pedidoId,
                    fecha: pedido.fecha,
                    fechaFormatted: fechaPedido.toLocaleDateString('es-AR'),
                    cliente: pedido.cliente?.nombre || 'Sin nombre',
                    tipoCliente: tipoCliente,
                    entrega: pedido.entrega || 'N/A',
                    medioPago: medioPago.toLowerCase(), // Normalizar a min√∫sculas
                    totalPedido: totalPedido,
                    gananciaPedido: gananciaPedido,
                    gananciaSelec: gananciaSelec,
                    gananciaNeta: gananciaPedido - gananciaSelec,
                    indicePeriodo: indicePeriodo,
                    periodoLabel: periodoLabels[indicePeriodo],
                    status: pedido.status || 'N/A',
                    observaciones: pedido.observaciones || '',
                    productos: pedido.productos || [],
                    pagos: pedido.pagos || {}
                });
                
                // Facturaci√≥n total
                datosFacturacion.facturacion[indicePeriodo] += totalPedido;
                
                // Segmentar facturaci√≥n por medio de pago
                if (medioPago === 'efectivo' || medioPago === 'Efectivo') {
                    datosFacturacion.facturacionEfectivo[indicePeriodo] += totalPedido;
                } else if (medioPago === 'transferencia' || medioPago === 'Transferencia') {
                    datosFacturacion.facturacionTransferencia[indicePeriodo] += totalPedido;
                } else if (medioPago === 'mercadopago' || medioPago === 'MercadoPago' || medioPago === 'Mercado Pago') {
                    datosFacturacion.facturacionTarjeta[indicePeriodo] += totalPedido;
                } else {
                    datosFacturacion.facturacionOtros[indicePeriodo] += totalPedido;
                }
                
                // Segmentar por tipo de cliente usando pedido.cliente.tipoCliente
                if (tipoCliente === 'consumidor final' || tipoCliente === 'Consumidor Final' || tipoCliente === 'consumidor-final') {
                    datosFacturacion.consumidorFinal[indicePeriodo] += totalPedido;
                    datosFacturacion.ventasConsumidorFinal[indicePeriodo] += 1;
                    // Usar ganancia real del pedido para consumidor final
                    datosFacturacion.gananciaBrutaConsumidor[indicePeriodo] += gananciaPedido;
                } else if (tipoCliente === 'mayorista' || tipoCliente === 'Mayorista') {
                    datosFacturacion.mayorista[indicePeriodo] += totalPedido;
                    datosFacturacion.ventasMayoristas[indicePeriodo] += 1;
                    // Usar ganancia real del pedido para mayorista
                    datosFacturacion.gananciaBrutaMayorista[indicePeriodo] += gananciaPedido;
                }
                
                // Contar ventas generadas
                datosFacturacion.ventasGeneradas[indicePeriodo] += 1;
                
                // Ganancia bruta (antes de gastos) - usar ganancia real
                datosFacturacion.gananciaBruta[indicePeriodo] += gananciaPedido;
                
                // Ganancia Seleccionados
                datosFacturacion.gananciaSeleccionados[indicePeriodo] += gananciaSelec;
            });
            
            console.log(`Pedidos procesados: ${totalPedidosProcesados}, Filtrados: ${pedidosFiltrados}, Filtro actual: ${filtroEntrega}, Temporalidad: ${temporalidad}`);
            console.log(`Pedidos almacenados para drill-down: ${pedidosProcesados.length}`);
            
            // Mostrar muestra de pedidos procesados
            if (pedidosProcesados.length > 0) {
                console.log('Muestra de pedido procesado:', pedidosProcesados[0]);
            }
            
            // Agregar gastos despu√©s de procesar pedidos
            agregarGastosAProcesamiento();
            
            // Calcular Ganancia Neta como Ganancia Bruta - Ganancia Seleccionados - Gastos
            for (let i = 0; i < numPeriodos; i++) {
                datosFacturacion.gananciaNeta[i] = 
                    datosFacturacion.gananciaBruta[i] - 
                    datosFacturacion.gananciaSeleccionados[i] - 
                    datosFacturacion.gastos[i];
                
                // Calcular porcentajes de ganancia usando Ganancia Bruta
                if (datosFacturacion.facturacion[i] > 0) {
                    datosFacturacion.gananciaPercent[i] = 
                        (datosFacturacion.gananciaBruta[i] / datosFacturacion.facturacion[i]) * 100;
                }
                
                // Calcular porcentajes por tipo de cliente
                if (datosFacturacion.consumidorFinal[i] > 0) {
                    datosFacturacion.gananciaPercentConsumidor[i] = 
                        (datosFacturacion.gananciaBrutaConsumidor[i] / datosFacturacion.consumidorFinal[i]) * 100;
                }
                
                if (datosFacturacion.mayorista[i] > 0) {
                    datosFacturacion.gananciaPercentMayorista[i] = 
                        (datosFacturacion.gananciaBrutaMayorista[i] / datosFacturacion.mayorista[i]) * 100;
                }
            }
            
            // Para vista diaria, filtrar solo las columnas con datos
            if (temporalidad === 'diario') {
                filtrarColumnasConDatos();
            }
        }

        // Funciones de gesti√≥n de gastos
        function abrirModalGastos() {
            cargarGastos();
            document.getElementById('modalGastos').style.display = 'block';
        }

        function cerrarModalGastos() {
            document.getElementById('modalGastos').style.display = 'none';
        }

        function cargarGastos() {
            // Si los gastos ya est√°n cargados, solo actualizar la interfaz
            if (gastosData.length > 0) {
                // Ordenar por fecha (m√°s recientes primero)
                gastosData.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                
                actualizarConceptosDatalist();
                renderizarListaGastos();
                agruparGastosPorPeriodo();
                return;
            }
            
            // Si no est√°n cargados, cargar desde Firebase
            db.ref('gastos').once('value')
                .then(snapshot => {
                    gastosData = [];
                    gastosAgrupados = { Local: {}, Envios: {} };
                    
                    if (snapshot.exists()) {
                        Object.entries(snapshot.val()).forEach(([id, gasto]) => {
                            gastosData.push({
                                id: id,
                                ...gasto
                            });
                        });
                    }
                    
                    // Ordenar por fecha (m√°s recientes primero)
                    gastosData.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                    
                    actualizarConceptosDatalist();
                    renderizarListaGastos();
                    agruparGastosPorPeriodo();
                })
                .catch(error => {
                    console.error('Error al cargar gastos:', error);
                    alert('Error al cargar los gastos. Int√©ntalo de nuevo.');
                });
        }

        function agregarGasto(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            // Tomar la fecha como string tal cual del input (YYYY-MM-DD)
            const fechaInput = formData.get('fecha');
            const nuevoGasto = {
                fecha: fechaInput, // Guardar exactamente como string
                concepto: formData.get('concepto'),
                valor: parseFloat(formData.get('valor')),
                cuenta: formData.get('cuenta'),
                nota: formData.get('nota') || '',
                fechaCreacion: new Date().toISOString()
            };
            
            // Validaciones
            if (!nuevoGasto.fecha || !nuevoGasto.concepto || nuevoGasto.valor <= 0 || !nuevoGasto.cuenta) {
                alert('Por favor completa todos los campos obligatorios correctamente.');
                return;
            }
            
            // Guardar en Firebase
            const gastosRef = db.ref('gastos').push();
            gastosRef.set(nuevoGasto)
                .then(() => {
                    // Limpiar formulario
                    limpiarFormularioGasto();
                    
                    // Forzar recarga completa de gastos desde Firebase
                    gastosData = []; // Limpiar array local para forzar recarga
                    
                    // Recargar gastos
                    cargarGastos();
                    
                    // Mostrar confirmaci√≥n
                    mostrarNotificacion('Gasto agregado correctamente', 'success');
                    
                    // Recargar datos de facturaci√≥n para actualizar la tabla
                    cargarDatos();
                })
                .catch(error => {
                    console.error('Error al guardar gasto:', error);
                    alert('Error al guardar el gasto. Int√©ntalo de nuevo.');
                });
        }

        function eliminarGasto(gastoId) {
            if (confirm('¬øEst√°s seguro de que deseas eliminar este gasto?')) {
                db.ref('gastos/' + gastoId).remove()
                    .then(() => {
                        // Forzar recarga completa de gastos desde Firebase
                        gastosData = []; // Limpiar array local para forzar recarga
                        
                        mostrarNotificacion('Gasto eliminado correctamente', 'success');
                        cargarGastos();
                        cargarDatos(); // Recargar datos de facturaci√≥n
                    })
                    .catch(error => {
                        console.error('Error al eliminar gasto:', error);
                        alert('Error al eliminar el gasto. Int√©ntalo de nuevo.');
                    });
            }
        }

        function limpiarFormularioGasto() {
            document.getElementById('formAgregarGasto').reset();
            document.getElementById('fechaGasto').value = new Date().toISOString().split('T')[0];
        }

        function actualizarConceptosDatalist() {
            const datalist = document.getElementById('conceptosDatalist');
            const conceptosUnicos = [...new Set(gastosData.map(gasto => gasto.concepto))];
            
            // Limpiar opciones existentes
            datalist.innerHTML = '';
            
            // Agregar conceptos √∫nicos ordenados alfab√©ticamente
            conceptosUnicos.sort().forEach(concepto => {
                const option = document.createElement('option');
                option.value = concepto;
                datalist.appendChild(option);
            });
        }

        function renderizarListaGastos() {
            const container = document.getElementById('gastosListaContainer');
            
            if (gastosData.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="bi bi-inbox" style="font-size: 3rem; margin-bottom: 20px;"></i>
                        <p>No hay gastos registrados a√∫n.</p>
                        <p>Utiliza el formulario de arriba para agregar tu primer gasto.</p>
                    </div>
                `;
                return;
            }
            
            let tablaHTML = `
                <table class="gastos-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Concepto</th>
                            <th>Valor</th>
                            <th>Cuenta</th>
                            <th>Nota</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            gastosData.forEach(gasto => {
                // Formatear fecha manualmente como DD/MM/YYYY
                let fechaFormateada = gasto.fecha;
                if (gasto.fecha && gasto.fecha.length === 10) {
                    const [yyyy, mm, dd] = gasto.fecha.split('-');
                    fechaFormateada = `${dd}/${mm}/${yyyy}`;
                }
                const cuentaDisplay = obtenerDisplayCuenta(gasto.cuenta);
                
                tablaHTML += `
                    <tr>
                        <td>${fechaFormateada}</td>
                        <td class="gastos-concepto">${gasto.concepto}</td>
                        <td class="gastos-valor">${formatearMoneda(gasto.valor)}</td>
                        <td class="gastos-cuenta">${cuentaDisplay}</td>
                        <td class="gastos-nota" title="${gasto.nota || ''}">${gasto.nota || '-'}</td>
                        <td>
                            <button class="btn-eliminar-gasto" onclick="eliminarGasto('${gasto.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tablaHTML += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tablaHTML;
        }

        function obtenerDisplayCuenta(cuenta) {
            switch(cuenta) {
                case 'Local': return 'üè™ Local';
                case 'Envios': return 'üöö Env√≠os';
                case 'Ambas': return 'üè™üöö Ambas';
                default: return cuenta || 'N/A';
            }
        }

        function agruparGastosPorPeriodo() {
            // Reinicializar gastos agrupados
            gastosAgrupados = {
                Local: {},
                Envios: {}
            };
            
            gastosData.forEach(gasto => {
                const fechaGasto = new Date(gasto.fecha);
                
                // Agrupar seg√∫n la temporalidad actual
                let claveAgrupacion = '';
                
                if (temporalidad === 'mensual') {
                    claveAgrupacion = `${fechaGasto.getFullYear()}-${fechaGasto.getMonth()}`;
                } else if (temporalidad === 'semanal') {
                    // Calcular semana del a√±o
                    const inicioAno = new Date(fechaGasto.getFullYear(), 0, 1);
                    const diasTranscurridos = Math.floor((fechaGasto - inicioAno) / (24 * 60 * 60 * 1000));
                    const semanaDelAno = Math.ceil((diasTranscurridos + inicioAno.getDay() + 1) / 7);
                    claveAgrupacion = `${fechaGasto.getFullYear()}-S${semanaDelAno}`;
                } else if (temporalidad === 'diario') {
                    claveAgrupacion = `${fechaGasto.getFullYear()}-${fechaGasto.getMonth()}-${fechaGasto.getDate()}`;
                }
                
                // Distribuir gastos seg√∫n la cuenta
                if (gasto.cuenta === 'Local') {
                    // 100% para Local
                    if (!gastosAgrupados.Local[claveAgrupacion]) {
                        gastosAgrupados.Local[claveAgrupacion] = 0;
                    }
                    gastosAgrupados.Local[claveAgrupacion] += gasto.valor;
                    
                } else if (gasto.cuenta === 'Envios') {
                    // 100% para Env√≠os
                    if (!gastosAgrupados.Envios[claveAgrupacion]) {
                        gastosAgrupados.Envios[claveAgrupacion] = 0;
                    }
                    gastosAgrupados.Envios[claveAgrupacion] += gasto.valor;
                    
                } else if (gasto.cuenta === 'Ambas') {
                    // 50% para cada uno
                    const valorDistribuido = gasto.valor / 2;
                    
                    if (!gastosAgrupados.Local[claveAgrupacion]) {
                        gastosAgrupados.Local[claveAgrupacion] = 0;
                    }
                    if (!gastosAgrupados.Envios[claveAgrupacion]) {
                        gastosAgrupados.Envios[claveAgrupacion] = 0;
                    }
                    
                    gastosAgrupados.Local[claveAgrupacion] += valorDistribuido;
                    gastosAgrupados.Envios[claveAgrupacion] += valorDistribuido;
                }
            });
            
            console.log('Gastos agrupados por per√≠odo y cuenta:', gastosAgrupados);
        }

        function agregarGastosAProcesamiento() {
            // Asegurar que los gastos est√©n agrupados
            agruparGastosPorPeriodo();
            
            // Aplicar gastos seg√∫n el filtro de entrega actual
            if (filtroEntrega === 'todas') {
                // Si est√° en "todas", sumar gastos de ambas cuentas
                ['Local', 'Envios'].forEach(cuenta => {
                    Object.entries(gastosAgrupados[cuenta] || {}).forEach(([claveAgrupacion, totalGastos]) => {
                        const indicePeriodo = calcularIndicePeriodo(claveAgrupacion);
                        if (indicePeriodo >= 0 && indicePeriodo < periodoLabels.length) {
                            datosFacturacion.gastos[indicePeriodo] += totalGastos;
                        }
                    });
                });
            } else {
                // Aplicar solo los gastos de la cuenta correspondiente
                const cuentaAplicar = filtroEntrega === 'Local' ? 'Local' : 'Envios';
                Object.entries(gastosAgrupados[cuentaAplicar] || {}).forEach(([claveAgrupacion, totalGastos]) => {
                    const indicePeriodo = calcularIndicePeriodo(claveAgrupacion);
                    if (indicePeriodo >= 0 && indicePeriodo < periodoLabels.length) {
                        datosFacturacion.gastos[indicePeriodo] += totalGastos;
                    }
                });
            }
        }

        function calcularIndicePeriodo(claveAgrupacion) {
            let indicePeriodo = -1;
            const ahora = new Date();
            
            if (temporalidad === 'mensual') {
                // Formato: "YYYY-M"
                const [ano, mes] = claveAgrupacion.split('-').map(Number);
                const mesesDiferencia = (ahora.getFullYear() - ano) * 12 + (ahora.getMonth() - mes);
                indicePeriodo = 11 - mesesDiferencia;
            } else if (temporalidad === 'semanal') {
                // Implementar l√≥gica de semanas si es necesario
            } else if (temporalidad === 'diario') {
                // Implementar l√≥gica de d√≠as si es necesario
            }
            
            return indicePeriodo;
        }

        function mostrarNotificacion(mensaje, tipo = 'info') {
            // Crear elemento de notificaci√≥n
            const notificacion = document.createElement('div');
            notificacion.className = `alert alert-${tipo} position-fixed`;
            notificacion.style.cssText = `
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                animation: slideInRight 0.3s ease-out;
                padding: 15px;
                border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            `;
            
            const bgColor = tipo === 'success' ? '#d4edda' : '#f8d7da';
            const textColor = tipo === 'success' ? '#155724' : '#721c24';
            const borderColor = tipo === 'success' ? '#c3e6cb' : '#f5c6cb';
            
            notificacion.style.backgroundColor = bgColor;
            notificacion.style.color = textColor;
            notificacion.style.border = `1px solid ${borderColor}`;
            
            notificacion.innerHTML = `
                <i class="bi bi-check-circle-fill"></i> ${mensaje}
                <button type="button" style="background: none; border: none; float: right; font-size: 1.2rem; cursor: pointer; color: ${textColor};" onclick="this.parentElement.remove()">&times;</button>
            `;
            
            document.body.appendChild(notificacion);
            
            // Auto-eliminar despu√©s de 3 segundos
            setTimeout(() => {
                if (notificacion.parentElement) {
                    notificacion.remove();
                }
            }, 3000);
        }

        // Cerrar modal de gastos con clic fuera
        window.addEventListener('click', function(event) {
            const modalGastos = document.getElementById('modalGastos');
            if (event.target === modalGastos) {
                cerrarModalGastos();
            }
        });

        // Cerrar modal de gastos con ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                cerrarModalGastos();
            }
        });

        function filtrarColumnasConDatos() {
            // Identificar √≠ndices que tienen datos (facturaci√≥n > 0)
            const indicesConDatos = [];
            const nuevosLabels = [];

            for (let i = 0; i < periodoLabels.length; i++) {
                if (datosFacturacion.facturacion[i] > 0) {
                    indicesConDatos.push(i);
                    nuevosLabels.push(periodoLabels[i]);
                }
            }

            // Mantener solo los √∫ltimos 12 d√≠as con datos
            let indicesFinales = indicesConDatos.slice(-12);
            let labelsFinales = nuevosLabels.slice(-12);

            // Si no hay datos, mantener al menos las √∫ltimas 12 fechas posibles
            if (indicesFinales.length === 0) {
                const inicioIndex = Math.max(0, periodoLabels.length - 12);
                indicesFinales = [];
                labelsFinales = [];
                for (let i = inicioIndex; i < periodoLabels.length; i++) {
                    indicesFinales.push(i);
                    labelsFinales.push(periodoLabels[i]);
                }
            }

            // Crear mapeo de √≠ndices antiguos a nuevos
            const mapeoIndices = {};
            indicesFinales.forEach((indiceAntiguo, nuevoIndice) => {
                mapeoIndices[indiceAntiguo] = nuevoIndice;
            });

            // Crear nuevos arrays filtrados
            const nuevosDatos = {};
            Object.keys(datosFacturacion).forEach(key => {
                nuevosDatos[key] = indicesFinales.map(index => datosFacturacion[key][index]);
            });

            // Actualizar pedidosProcesados con los nuevos √≠ndices
            pedidosProcesados = pedidosProcesados.map(pedido => {
                if (mapeoIndices.hasOwnProperty(pedido.indicePeriodo)) {
                    return {
                        ...pedido,
                        indicePeriodo: mapeoIndices[pedido.indicePeriodo]
                    };
                }
                return null; // Marcar para eliminar
            }).filter(pedido => pedido !== null); // Eliminar pedidos que no est√°n en las columnas filtradas

            // Actualizar datos globales
            datosFacturacion = nuevosDatos;
            periodoLabels = labelsFinales;
        }

        function aplicarFiltroEntrega(pedido) {
            if (filtroEntrega === 'todas') return true;
            
            // Usar el campo 'entrega' de Firebase
            const entrega = pedido.entrega || '';
            
            if (filtroEntrega === 'Local') {
                // Filtrar pedidos con entrega = "Local"
                return entrega === 'Local';
            } else if (filtroEntrega === 'Envios') {
                // Filtrar pedidos de env√≠o (campo entrega = "Envios")
                return entrega === 'Envios';
            }
            
            return false;
        }

        function mostrarDatos() {
            mostrarLoading(false);
            
            // Verificar si hay datos
            const hayDatos = datosFacturacion.facturacion.some(valor => valor > 0);
            
            if (!hayDatos) {
                mostrarSinDatos();
                return;
            }
            
            // Para vista diaria, actualizar headers despu√©s del filtrado
            if (temporalidad === 'diario') {
                actualizarHeadersTabla();
            }
            
            actualizarEstadisticas();
            renderizarTabla();
            renderizarGrafico();
            
            // Mostrar contenedores
            statsContainer.style.display = 'grid';
            tableContainer.style.display = 'block';
            chartContainer.style.display = 'block';
            noDataDiv.style.display = 'none';
        }

        function mostrarSinDatos() {
            mostrarLoading(false);
            statsContainer.style.display = 'none';
            tableContainer.style.display = 'none';
            chartContainer.style.display = 'none';
            noDataDiv.style.display = 'block';
        }

        function mostrarLoading(mostrar) {
            loadingDiv.style.display = mostrar ? 'flex' : 'none';
        }

        function actualizarEstadisticas() {
            const totalFacturacion = datosFacturacion.facturacion.reduce((sum, val) => sum + val, 0);
            const totalGanancia = datosFacturacion.gananciaNeta.reduce((sum, val) => sum + val, 0);
            const porcentajeGanancia = totalFacturacion > 0 ? (totalGanancia / totalFacturacion) * 100 : 0;
            
            document.getElementById('totalFacturacion').textContent = formatearMoneda(totalFacturacion);
            document.getElementById('totalGanancia').textContent = formatearMoneda(totalGanancia);
            document.getElementById('porcentajeGanancia').textContent = porcentajeGanancia.toFixed(1) + '%';
        }

        function renderizarTabla() {
            const tbody = document.getElementById('facturacionTableBody');
            tbody.innerHTML = '';
            
            const numPeriodos = periodoLabels.length;
            
            // Crear filas seg√∫n el formato de la imagen (sin comisiones y sin filas individuales de cliente)
            const filas = [
                { nombre: 'Facturacion', datos: datosFacturacion.facturacion, esMoneda: true, expandible: true, color: 'facturacion' },
                { nombre: 'Ganancia Bruta Tot.', datos: datosFacturacion.gananciaBruta, esMoneda: true, expandible: true, color: 'ganancia' },
                { nombre: 'Ganancia Seleccionados', datos: datosFacturacion.gananciaSeleccionados, esMoneda: true, color: 'ganancia' },
                { nombre: 'Gastos', datos: datosFacturacion.gastos, esMoneda: true, expandible: true, color: 'gastos' },
                { nombre: 'Ganancia Neta', datos: datosFacturacion.gananciaNeta, esMoneda: true, color: 'ganancia' },
                { nombre: 'Ganancia %', datos: datosFacturacion.gananciaPercent, esMoneda: false, expandible: true, color: 'ganancia' },
                { nombre: 'Ventas Generadas', datos: datosFacturacion.ventasGeneradas, esMoneda: false, expandible: true, color: 'facturacion' }
            ];
            
            filas.forEach((fila, index) => {
                const tr = document.createElement('tr');
                
                // Aplicar estilos especiales
                if (fila.expandible) {
                    tr.className = 'total-row';
                    tr.style.cursor = 'pointer';
                    if (fila.nombre === 'Facturacion') {
                        tr.addEventListener('click', () => toggleFacturacionDetail());
                    } else if (fila.nombre === 'Ganancia Bruta Tot.') {
                        tr.addEventListener('click', () => toggleGananciaBrutaDetail());
                    } else if (fila.nombre === 'Gastos') {
                        tr.addEventListener('click', () => toggleGastosDetail());
                    } else if (fila.nombre === 'Ganancia %') {
                        tr.addEventListener('click', () => toggleGananciaPorcentajeDetail());
                    } else if (fila.nombre === 'Ventas Generadas') {
                        tr.addEventListener('click', () => toggleVentasGeneradasDetail());
                    }
                }
                
                // Primera columna: nombre de la fila
                const tdNombre = document.createElement('td');
                tdNombre.className = 'mes-name';
                
                if (fila.expandible) {
                    let iconId = '';
                    if (fila.nombre === 'Facturacion') iconId = 'expandIconFacturacion';
                    else if (fila.nombre === 'Ganancia Bruta Tot.') iconId = 'expandIconGanancia';
                    else if (fila.nombre === 'Gastos') iconId = 'expandIconGastos';
                    else if (fila.nombre === 'Ganancia %') iconId = 'expandIconPorcentaje';
                    else if (fila.nombre === 'Ventas Generadas') iconId = 'expandIconVentas';
                    
                    tdNombre.innerHTML = `<i class="bi bi-chevron-right expandable-icon" id="${iconId}"></i>${fila.nombre}`;
                } else {
                    tdNombre.textContent = fila.nombre;
                }
                
                tr.appendChild(tdNombre);
                
                // Columnas de per√≠odos
                let totalFila = 0;
                for (let i = 0; i < numPeriodos; i++) {
                    const td = document.createElement('td');
                    const valor = fila.datos[i];
                    totalFila += valor;
                    
                    // Hacer la celda clickeable si tiene valor
                    if (valor > 0) {
                        td.className = 'clickable-cell';
                        if (fila.nombre === 'Gastos') {
                            td.onclick = () => abrirReporteDetallado('Gastos', i, periodoLabels[i], 'gastos');
                        } else {
                            td.onclick = () => abrirReporteDetallado(fila.nombre, i, periodoLabels[i]);
                        }
                    }
                    
                    if (fila.esMoneda) {
                        if (fila.color === 'facturacion') {
                            td.classList.add('facturacion-cell');
                        } else if (fila.color === 'ganancia') {
                            td.classList.add('ganancia-cell');
                        } else if (fila.color === 'gastos') {
                            td.classList.add('gastos-cell');
                        } else {
                            td.classList.add('currency-cell');
                        }
                        td.textContent = valor > 0 ? formatearMoneda(valor) : '$0';
                    } else if (fila.nombre === 'Ganancia %') {
                        if (fila.color === 'ganancia') {
                            td.classList.add('ganancia-cell');
                        } else {
                            td.classList.add('percentage-cell');
                        }
                        td.textContent = valor > 0 ? valor.toFixed(1) + '%' : '0%';
                    } else {
                        if (fila.color === 'facturacion') {
                            td.classList.add('facturacion-cell');
                        }
                        td.textContent = Math.round(valor);
                    }
                    
                    tr.appendChild(td);
                }
                
                // Columna total
                const tdTotal = document.createElement('td');
                
                // Hacer la columna total clickeable si tiene valor
                if (totalFila > 0) {
                    tdTotal.className = 'clickable-cell';
                    if (fila.nombre === 'Gastos') {
                        tdTotal.onclick = () => abrirReporteDetallado('Gastos', -1, 'TOTAL', 'gastos');
                    } else {
                        tdTotal.onclick = () => abrirReporteDetallado(fila.nombre, -1, 'TOTAL');
                    }
                }
                
                if (fila.esMoneda) {
                    if (fila.color === 'facturacion') {
                        tdTotal.classList.add('facturacion-cell');
                    } else if (fila.color === 'ganancia') {
                        tdTotal.classList.add('ganancia-cell');
                    } else if (fila.color === 'gastos') {
                        tdTotal.classList.add('gastos-cell');
                    } else {
                        tdTotal.classList.add('currency-cell');
                    }
                    tdTotal.textContent = formatearMoneda(totalFila);
                } else if (fila.nombre === 'Ganancia %') {
                    const totalFacturacion = datosFacturacion.facturacion.reduce((sum, val) => sum + val, 0);
                    const totalGananciaBruta = datosFacturacion.gananciaBruta.reduce((sum, val) => sum + val, 0);
                    const porcentajeTotal = totalFacturacion > 0 ? (totalGananciaBruta / totalFacturacion) * 100 : 0;
                    if (fila.color === 'ganancia') {
                        tdTotal.classList.add('ganancia-cell');
                    } else {
                        tdTotal.classList.add('percentage-cell');
                    }
                    tdTotal.textContent = porcentajeTotal.toFixed(1) + '%';
                } else {
                    if (fila.color === 'facturacion') {
                        tdTotal.classList.add('facturacion-cell');
                    }
                    tdTotal.textContent = Math.round(totalFila);
                }
                tr.appendChild(tdTotal);
                
                tbody.appendChild(tr);
                
                // Agregar filas de detalle despu√©s de Facturacion
                if (fila.nombre === 'Facturacion') {
                    // Fila detalle para Efectivo
                    const trEfectivo = document.createElement('tr');
                    trEfectivo.className = 'detail-row';
                    trEfectivo.id = 'detailEfectivo';
                    
                    const tdEfectivoNombre = document.createElement('td');
                    tdEfectivoNombre.className = 'mes-name';
                    tdEfectivoNombre.textContent = '‚Üí Efectivo';
                    trEfectivo.appendChild(tdEfectivoNombre);
                    
                    let totalEfectivo = 0;
                    for (let i = 0; i < numPeriodos; i++) {
                        const td = document.createElement('td');
                        const valor = datosFacturacion.facturacionEfectivo[i];
                        totalEfectivo += valor;
                        
                        // Hacer clickeable si tiene valor
                        if (valor > 0) {
                            td.className = 'clickable-cell facturacion-cell';
                            td.onclick = () => abrirReporteDetallado('efectivo', i, periodoLabels[i], 'medioPago');
                        } else {
                            td.className = 'facturacion-cell';
                        }
                        
                        td.textContent = valor > 0 ? formatearMoneda(valor) : '$0';
                        trEfectivo.appendChild(td);
                    }
                    
                    const tdTotalEfectivo = document.createElement('td');
                    if (totalEfectivo > 0) {
                        tdTotalEfectivo.className = 'clickable-cell facturacion-cell';
                        tdTotalEfectivo.onclick = () => abrirReporteDetallado('efectivo', -1, 'TOTAL', 'medioPago');
                    } else {
                        tdTotalEfectivo.className = 'facturacion-cell';
                    }
                    tdTotalEfectivo.textContent = formatearMoneda(totalEfectivo);
                    trEfectivo.appendChild(tdTotalEfectivo);
                    
                    tbody.appendChild(trEfectivo);
                    
                    // Fila detalle para Transferencia
                    const trTransferencia = document.createElement('tr');
                    trTransferencia.className = 'detail-row';
                    trTransferencia.id = 'detailTransferencia';
                    
                    const tdTransferenciaNombre = document.createElement('td');
                    tdTransferenciaNombre.className = 'mes-name';
                    tdTransferenciaNombre.textContent = '‚Üí Transferencia';
                    trTransferencia.appendChild(tdTransferenciaNombre);
                    
                    let totalTransferencia = 0;
                    for (let i = 0; i < numPeriodos; i++) {
                        const td = document.createElement('td');
                        const valor = datosFacturacion.facturacionTransferencia[i];
                        totalTransferencia += valor;
                        
                        if (valor > 0) {
                            td.className = 'clickable-cell facturacion-cell';
                            td.onclick = () => abrirReporteDetallado('transferencia', i, periodoLabels[i], 'medioPago');
                        } else {
                            td.className = 'facturacion-cell';
                        }
                        
                        td.textContent = valor > 0 ? formatearMoneda(valor) : '$0';
                        trTransferencia.appendChild(td);
                    }
                    
                    const tdTotalTransferencia = document.createElement('td');
                    if (totalTransferencia > 0) {
                        tdTotalTransferencia.className = 'clickable-cell facturacion-cell';
                        tdTotalTransferencia.onclick = () => abrirReporteDetallado('transferencia', -1, 'TOTAL', 'medioPago');
                    } else {
                        tdTotalTransferencia.className = 'facturacion-cell';
                    }
                    tdTotalTransferencia.textContent = formatearMoneda(totalTransferencia);
                    trTransferencia.appendChild(tdTotalTransferencia);
                    
                    tbody.appendChild(trTransferencia);
                    
                    // Fila detalle para MercadoPago
                    const trTarjeta = document.createElement('tr');
                    trTarjeta.className = 'detail-row';
                    trTarjeta.id = 'detailTarjeta';
                    
                    const tdTarjetaNombre = document.createElement('td');
                    tdTarjetaNombre.className = 'mes-name';
                    tdTarjetaNombre.textContent = '‚Üí MercadoPago';
                    trTarjeta.appendChild(tdTarjetaNombre);
                    
                    let totalTarjeta = 0;
                    for (let i = 0; i < numPeriodos; i++) {
                        const td = document.createElement('td');
                        const valor = datosFacturacion.facturacionTarjeta[i];
                        totalTarjeta += valor;
                        
                        if (valor > 0) {
                            td.className = 'clickable-cell facturacion-cell';
                            td.onclick = () => abrirReporteDetallado('mercadopago', i, periodoLabels[i], 'medioPago');
                        } else {
                            td.className = 'facturacion-cell';
                        }
                        
                        td.textContent = valor > 0 ? formatearMoneda(valor) : '$0';
                        trTarjeta.appendChild(td);
                    }
                    
                    const tdTotalTarjeta = document.createElement('td');
                    if (totalTarjeta > 0) {
                        tdTotalTarjeta.className = 'clickable-cell facturacion-cell';
                        tdTotalTarjeta.onclick = () => abrirReporteDetallado('mercadopago', -1, 'TOTAL', 'medioPago');
                    } else {
                        tdTotalTarjeta.className = 'facturacion-cell';
                    }
                    tdTotalTarjeta.textContent = formatearMoneda(totalTarjeta);
                    trTarjeta.appendChild(tdTotalTarjeta);
                    
                    tbody.appendChild(trTarjeta);
                    
                    // Fila detalle para Otros
                    const trOtros = document.createElement('tr');
                    trOtros.className = 'detail-row';
                    trOtros.id = 'detailOtros';
                    
                    const tdOtrosNombre = document.createElement('td');
                    tdOtrosNombre.className = 'mes-name';
                    tdOtrosNombre.textContent = '‚Üí Otros';
                    trOtros.appendChild(tdOtrosNombre);
                    
                    let totalOtros = 0;
                    for (let i = 0; i < numPeriodos; i++) {
                        const td = document.createElement('td');
                        const valor = datosFacturacion.facturacionOtros[i];
                        totalOtros += valor;
                        
                        if (valor > 0) {
                            td.className = 'clickable-cell facturacion-cell';
                            td.onclick = () => abrirReporteDetallado('Otros', i, periodoLabels[i], 'medioPago');
                        } else {
                            td.className = 'facturacion-cell';
                        }
                        
                        td.textContent = valor > 0 ? formatearMoneda(valor) : '$0';
                        trOtros.appendChild(td);
                    }
                    
                    const tdTotalOtros = document.createElement('td');
                    if (totalOtros > 0) {
                        tdTotalOtros.className = 'clickable-cell facturacion-cell';
                        tdTotalOtros.onclick = () => abrirReporteDetallado('Otros', -1, 'TOTAL', 'medioPago');
                    } else {
                        tdTotalOtros.className = 'facturacion-cell';
                    }
                    tdTotalOtros.textContent = formatearMoneda(totalOtros);
                    trOtros.appendChild(tdTotalOtros);
                    
                    tbody.appendChild(trOtros);
                }
                
                // Agregar filas de detalle despu√©s de Ganancia Bruta Tot.
                if (fila.nombre === 'Ganancia Bruta Tot.') {
                    // Fila detalle para Consumidor Final
                    const trConsumidor = document.createElement('tr');
                    trConsumidor.className = 'detail-row';
                    trConsumidor.id = 'detailConsumidor';
                    
                    const tdConsumidorNombre = document.createElement('td');
                    tdConsumidorNombre.className = 'mes-name';
                    tdConsumidorNombre.textContent = '‚Üí Gan. Consumidor Final';
                    trConsumidor.appendChild(tdConsumidorNombre);
                    
                    let totalConsumidor = 0;
                    for (let i = 0; i < numPeriodos; i++) {
                        const td = document.createElement('td');
                        const valor = datosFacturacion.gananciaBrutaConsumidor[i];
                        totalConsumidor += valor;
                        
                        if (valor > 0) {
                            td.className = 'clickable-cell ganancia-cell';
                            td.onclick = () => abrirReporteDetallado('Ganancia Consumidor Final', i, periodoLabels[i], 'tipoCliente');
                        } else {
                            td.className = 'ganancia-cell';
                        }
                        
                        td.textContent = valor > 0 ? formatearMoneda(valor) : '$0';
                        trConsumidor.appendChild(td);
                    }
                    
                    const tdTotalConsumidor = document.createElement('td');
                    if (totalConsumidor > 0) {
                        tdTotalConsumidor.className = 'clickable-cell ganancia-cell';
                        tdTotalConsumidor.onclick = () => abrirReporteDetallado('Ganancia Consumidor Final', -1, 'TOTAL', 'tipoCliente');
                    } else {
                        tdTotalConsumidor.className = 'ganancia-cell';
                    }
                    tdTotalConsumidor.textContent = formatearMoneda(totalConsumidor);
                    trConsumidor.appendChild(tdTotalConsumidor);
                    
                    tbody.appendChild(trConsumidor);
                    
                    // Fila detalle para Mayorista
                    const trMayorista = document.createElement('tr');
                    trMayorista.className = 'detail-row';
                    trMayorista.id = 'detailMayorista';
                    
                    const tdMayoristaNombre = document.createElement('td');
                    tdMayoristaNombre.className = 'mes-name';
                    tdMayoristaNombre.textContent = '‚Üí Gan. Mayorista';
                    trMayorista.appendChild(tdMayoristaNombre);
                    
                    let totalMayorista = 0;
                    for (let i = 0; i < numPeriodos; i++) {
                        const td = document.createElement('td');
                        const valor = datosFacturacion.gananciaBrutaMayorista[i];
                        totalMayorista += valor;
                        
                        if (valor > 0) {
                            td.className = 'clickable-cell ganancia-cell';
                            td.onclick = () => abrirReporteDetallado('Ganancia Mayorista', i, periodoLabels[i], 'tipoCliente');
                        } else {
                            td.className = 'ganancia-cell';
                        }
                        
                        td.textContent = valor > 0 ? formatearMoneda(valor) : '$0';
                        trMayorista.appendChild(td);
                    }
                    
                    const tdTotalMayorista = document.createElement('td');
                    if (totalMayorista > 0) {
                        tdTotalMayorista.className = 'clickable-cell ganancia-cell';
                        tdTotalMayorista.onclick = () => abrirReporteDetallado('Ganancia Mayorista', -1, 'TOTAL', 'tipoCliente');
                    } else {
                        tdTotalMayorista.className = 'ganancia-cell';
                    }
                    tdTotalMayorista.textContent = formatearMoneda(totalMayorista);
                    trMayorista.appendChild(tdTotalMayorista);
                    
                    tbody.appendChild(trMayorista);
                }
                
                // Agregar filas de detalle despu√©s de Ganancia %
                if (fila.nombre === 'Ganancia %') {
                    // Fila detalle para % Consumidor Final
                    const trPercentConsumidor = document.createElement('tr');
                    trPercentConsumidor.className = 'detail-row';
                    trPercentConsumidor.id = 'detailPercentConsumidor';
                    
                    const tdPercentConsumidorNombre = document.createElement('td');
                    tdPercentConsumidorNombre.className = 'mes-name';
                    tdPercentConsumidorNombre.textContent = '‚Üí % Consumidor Final';
                    trPercentConsumidor.appendChild(tdPercentConsumidorNombre);
                    
                    for (let i = 0; i < numPeriodos; i++) {
                        const td = document.createElement('td');
                        const valor = datosFacturacion.gananciaPercentConsumidor[i];
                        
                        if (valor > 0) {
                            td.className = 'clickable-cell ganancia-cell';
                            td.onclick = () => abrirReporteDetallado('% Consumidor Final', i, periodoLabels[i], 'tipoCliente');
                        } else {
                            td.className = 'ganancia-cell';
                        }
                        
                        td.textContent = valor > 0 ? valor.toFixed(1) + '%' : '0%';
                        trPercentConsumidor.appendChild(td);
                    }
                    
                    // Total promedio para porcentajes
                    const totalFacturacionConsumidor = datosFacturacion.consumidorFinal.reduce((sum, val) => sum + val, 0);
                    const totalGananciaBrutaConsumidor = datosFacturacion.gananciaBrutaConsumidor.reduce((sum, val) => sum + val, 0);
                    const porcentajeTotalConsumidor = totalFacturacionConsumidor > 0 ? 
                        (totalGananciaBrutaConsumidor / totalFacturacionConsumidor) * 100 : 0;
                    
                    const tdTotalPercentConsumidor = document.createElement('td');
                    if (porcentajeTotalConsumidor > 0) {
                        tdTotalPercentConsumidor.className = 'clickable-cell ganancia-cell';
                        tdTotalPercentConsumidor.onclick = () => abrirReporteDetallado('% Consumidor Final', -1, 'TOTAL', 'tipoCliente');
                    } else {
                        tdTotalPercentConsumidor.className = 'ganancia-cell';
                    }
                    tdTotalPercentConsumidor.textContent = porcentajeTotalConsumidor.toFixed(1) + '%';
                    trPercentConsumidor.appendChild(tdTotalPercentConsumidor);
                    
                    tbody.appendChild(trPercentConsumidor);
                    
                    // Fila detalle para % Mayorista
                    const trPercentMayorista = document.createElement('tr');
                    trPercentMayorista.className = 'detail-row';
                    trPercentMayorista.id = 'detailPercentMayorista';
                    
                    const tdPercentMayoristaNombre = document.createElement('td');
                    tdPercentMayoristaNombre.className = 'mes-name';
                    tdPercentMayoristaNombre.textContent = '‚Üí % Mayorista';
                    trPercentMayorista.appendChild(tdPercentMayoristaNombre);
                    
                    for (let i = 0; i < numPeriodos; i++) {
                        const td = document.createElement('td');
                        const valor = datosFacturacion.gananciaPercentMayorista[i];
                        
                        if (valor > 0) {
                            td.className = 'clickable-cell ganancia-cell';
                            td.onclick = () => abrirReporteDetallado('% Mayorista', i, periodoLabels[i], 'tipoCliente');
                        } else {
                            td.className = 'ganancia-cell';
                        }
                        
                        td.textContent = valor > 0 ? valor.toFixed(1) + '%' : '0%';
                        trPercentMayorista.appendChild(td);
                    }
                    
                    // Total promedio para porcentajes
                    const totalFacturacionMayorista = datosFacturacion.mayorista.reduce((sum, val) => sum + val, 0);
                    const totalGananciaBrutaMayorista = datosFacturacion.gananciaBrutaMayorista.reduce((sum, val) => sum + val, 0);
                    const porcentajeTotalMayorista = totalFacturacionMayorista > 0 ? 
                        (totalGananciaBrutaMayorista / totalFacturacionMayorista) * 100 : 0;
                    
                    const tdTotalPercentMayorista = document.createElement('td');
                    if (porcentajeTotalMayorista > 0) {
                        tdTotalPercentMayorista.className = 'clickable-cell ganancia-cell';
                        tdTotalPercentMayorista.onclick = () => abrirReporteDetallado('% Mayorista', -1, 'TOTAL', 'tipoCliente');
                    } else {
                        tdTotalPercentMayorista.className = 'ganancia-cell';
                    }
                    tdTotalPercentMayorista.textContent = porcentajeTotalMayorista.toFixed(1) + '%';
                    trPercentMayorista.appendChild(tdTotalPercentMayorista);
                    
                    tbody.appendChild(trPercentMayorista);
                }
                
                // Agregar filas de detalle despu√©s de Ventas Generadas
                if (fila.nombre === 'Ventas Generadas') {
                    // Fila detalle para Ventas Consumidor Final
                    const trVentasConsumidor = document.createElement('tr');
                    trVentasConsumidor.className = 'detail-row';
                    trVentasConsumidor.id = 'detailVentasConsumidor';
                    
                    const tdVentasConsumidorNombre = document.createElement('td');
                    tdVentasConsumidorNombre.className = 'mes-name';
                    tdVentasConsumidorNombre.textContent = '‚Üí Ventas Cons.Final';
                    trVentasConsumidor.appendChild(tdVentasConsumidorNombre);
                    
                    let totalVentasConsumidor = 0;
                    for (let i = 0; i < numPeriodos; i++) {
                        const td = document.createElement('td');
                        const valor = datosFacturacion.ventasConsumidorFinal[i];
                        totalVentasConsumidor += valor;
                        
                        if (valor > 0) {
                            td.className = 'clickable-cell facturacion-cell';
                            td.onclick = () => abrirReporteDetallado('Ventas Cons.Final', i, periodoLabels[i], 'tipoCliente');
                        } else {
                            td.className = 'facturacion-cell';
                        }
                        
                        td.textContent = Math.round(valor);
                        trVentasConsumidor.appendChild(td);
                    }
                    
                    const tdTotalVentasConsumidor = document.createElement('td');
                    if (totalVentasConsumidor > 0) {
                        tdTotalVentasConsumidor.className = 'clickable-cell facturacion-cell';
                        tdTotalVentasConsumidor.onclick = () => abrirReporteDetallado('Ventas Cons.Final', -1, 'TOTAL', 'tipoCliente');
                    } else {
                        tdTotalVentasConsumidor.className = 'facturacion-cell';
                    }
                    tdTotalVentasConsumidor.textContent = Math.round(totalVentasConsumidor);
                    trVentasConsumidor.appendChild(tdTotalVentasConsumidor);
                    
                    tbody.appendChild(trVentasConsumidor);
                    
                    // Fila detalle para Ventas Mayoristas
                    const trVentasMayorista = document.createElement('tr');
                    trVentasMayorista.className = 'detail-row';
                    trVentasMayorista.id = 'detailVentasMayorista';
                    
                    const tdVentasMayoristaNombre = document.createElement('td');
                    tdVentasMayoristaNombre.className = 'mes-name';
                    tdVentasMayoristaNombre.textContent = '‚Üí Ventas Mayoristas';
                    trVentasMayorista.appendChild(tdVentasMayoristaNombre);
                    
                    let totalVentasMayorista = 0;
                    for (let i = 0; i < numPeriodos; i++) {
                        const td = document.createElement('td');
                        const valor = datosFacturacion.ventasMayoristas[i];
                        totalVentasMayorista += valor;
                        
                        if (valor > 0) {
                            td.className = 'clickable-cell facturacion-cell';
                            td.onclick = () => abrirReporteDetallado('Ventas Mayoristas', i, periodoLabels[i], 'tipoCliente');
                        } else {
                            td.className = 'facturacion-cell';
                        }
                        
                        td.textContent = Math.round(valor);
                        trVentasMayorista.appendChild(td);
                    }
                    
                    const tdTotalVentasMayorista = document.createElement('td');
                    if (totalVentasMayorista > 0) {
                        tdTotalVentasMayorista.className = 'clickable-cell facturacion-cell';
                        tdTotalVentasMayorista.onclick = () => abrirReporteDetallado('Ventas Mayoristas', -1, 'TOTAL', 'tipoCliente');
                    } else {
                        tdTotalVentasMayorista.className = 'facturacion-cell';
                    }
                    tdTotalVentasMayorista.textContent = Math.round(totalVentasMayorista);
                    trVentasMayorista.appendChild(tdTotalVentasMayorista);
                    
                    tbody.appendChild(trVentasMayorista);
                }
            });
        }

        function toggleFacturacionDetail() {
            const expandIcon = document.getElementById('expandIconFacturacion');
            const detailEfectivo = document.getElementById('detailEfectivo');
            const detailTransferencia = document.getElementById('detailTransferencia');
            const detailTarjeta = document.getElementById('detailTarjeta');
            const detailOtros = document.getElementById('detailOtros');
            
            if (expandIcon && detailEfectivo && detailTransferencia && detailTarjeta && detailOtros) {
                const isExpanded = expandIcon.classList.contains('expanded');
                
                if (isExpanded) {
                    expandIcon.classList.remove('expanded');
                    detailEfectivo.classList.remove('show');
                    detailTransferencia.classList.remove('show');
                    detailTarjeta.classList.remove('show');
                    detailOtros.classList.remove('show');
                } else {
                    expandIcon.classList.add('expanded');
                    detailEfectivo.classList.add('show');
                    detailTransferencia.classList.add('show');
                    detailTarjeta.classList.add('show');
                    detailOtros.classList.add('show');
                }
            }
        }

        function toggleGastosDetail() {
            // Para gastos, simplemente abrir el reporte detallado
            abrirReporteDetallado('Gastos', -1, 'TOTAL', 'gastos');
        }

        function toggleGananciaBrutaDetail() {
            const expandIcon = document.getElementById('expandIconGanancia');
            const detailConsumidor = document.getElementById('detailConsumidor');
            const detailMayorista = document.getElementById('detailMayorista');
            
            if (expandIcon && detailConsumidor && detailMayorista) {
                const isExpanded = expandIcon.classList.contains('expanded');
                
                if (isExpanded) {
                    expandIcon.classList.remove('expanded');
                    detailConsumidor.classList.remove('show');
                    detailMayorista.classList.remove('show');
                } else {
                    expandIcon.classList.add('expanded');
                    detailConsumidor.classList.add('show');
                    detailMayorista.classList.add('show');
                }
            }
        }

        function toggleGananciaPorcentajeDetail() {
            const expandIcon = document.getElementById('expandIconPorcentaje');
            const detailPercentConsumidor = document.getElementById('detailPercentConsumidor');
            const detailPercentMayorista = document.getElementById('detailPercentMayorista');
            
            if (expandIcon && detailPercentConsumidor && detailPercentMayorista) {
                const isExpanded = expandIcon.classList.contains('expanded');
                
                if (isExpanded) {
                    expandIcon.classList.remove('expanded');
                    detailPercentConsumidor.classList.remove('show');
                    detailPercentMayorista.classList.remove('show');
                } else {
                    expandIcon.classList.add('expanded');
                    detailPercentConsumidor.classList.add('show');
                    detailPercentMayorista.classList.add('show');
                }
            }
        }

        function toggleVentasGeneradasDetail() {
            const expandIcon = document.getElementById('expandIconVentas');
            const detailVentasConsumidor = document.getElementById('detailVentasConsumidor');
            const detailVentasMayorista = document.getElementById('detailVentasMayorista');
            
            if (expandIcon && detailVentasConsumidor && detailVentasMayorista) {
                const isExpanded = expandIcon.classList.contains('expanded');
                
                if (isExpanded) {
                    expandIcon.classList.remove('expanded');
                    detailVentasConsumidor.classList.remove('show');
                    detailVentasMayorista.classList.remove('show');
                } else {
                    expandIcon.classList.add('expanded');
                    detailVentasConsumidor.classList.add('show');
                    detailVentasMayorista.classList.add('show');
                }
            }
        }

        function renderizarGrafico() {
            const ctx = document.getElementById('gananciaChart').getContext('2d');
            
            // Actualizar t√≠tulo del gr√°fico seg√∫n la temporalidad
            const chartTitle = document.getElementById('chartTitle');
            let titulo = 'Ganancia Neta';
            if (temporalidad === 'semanal') {
                titulo += ' (√öltimas 12 Semanas)';
            } else if (temporalidad === 'diario') {
                titulo += ' (√öltimos 12 D√≠as)';
            } else {
                titulo += ' (√öltimos 12 Meses)';
            }
            chartTitle.textContent = titulo;
            
            // Destruir gr√°fico anterior si existe
            if (gananciaChart) {
                gananciaChart.destroy();
            }
            
            gananciaChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: periodoLabels,
                    datasets: [{
                        label: 'Ganancia Neta',
                        data: datosFacturacion.gananciaNeta,
                        backgroundColor: 'rgba(39, 174, 96, 0.7)',
                        borderColor: 'rgba(39, 174, 96, 1)',
                        borderWidth: 2,
                        borderRadius: 5,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatearMoneda(value);
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    elements: {
                        bar: {
                            borderRadius: 5
                        }
                    }
                }
            });
        }

        function formatearMoneda(monto) {
            if (!monto || monto === 0) return '$0';
            return '$' + Math.round(monto).toLocaleString('es-AR');
        }

        // Funciones del modal de reporte
        function abrirReporteDetallado(tipoFila, indicePeriodo, periodoLabel, filtroEspecial = null) {
            console.log('Abriendo reporte:', { tipoFila, indicePeriodo, periodoLabel, filtroEspecial });
            
            // Caso especial para gastos
            if (filtroEspecial === 'gastos') {
                abrirReporteGastos(indicePeriodo, periodoLabel);
                return;
            }
            
            console.log('Total pedidos procesados:', pedidosProcesados.length);
            
            // Filtrar pedidos seg√∫n los criterios
            let pedidosFiltrados = pedidosProcesados.filter(pedido => {
                // Filtro por per√≠odo
                if (indicePeriodo !== -1 && pedido.indicePeriodo !== indicePeriodo) {
                    return false;
                }
                
                // Filtros espec√≠ficos seg√∫n el tipo de fila
                if (filtroEspecial === 'medioPago') {
                    // Normalizar comparaci√≥n de medios de pago
                    const medioPagoNormalizado = pedido.medioPago.toLowerCase();
                    const tipoFilaNormalizado = tipoFila.toLowerCase();
                    
                    if (tipoFilaNormalizado === 'efectivo') {
                        return medioPagoNormalizado === 'efectivo';
                    } else if (tipoFilaNormalizado === 'transferencia') {
                        return medioPagoNormalizado === 'transferencia';
                    } else if (tipoFilaNormalizado === 'mercadopago') {
                        return medioPagoNormalizado === 'mercadopago' || 
                               medioPagoNormalizado === 'mercado pago';
                    } else {
                        // Otros medios de pago
                        return !['efectivo', 'transferencia', 'mercadopago', 'mercado pago'].includes(medioPagoNormalizado);
                    }
                } else if (filtroEspecial === 'tipoCliente' || tipoFila.includes('Consumidor') || tipoFila.includes('Cons.Final')) {
                    return pedido.tipoCliente === 'consumidor final' || 
                           pedido.tipoCliente === 'Consumidor Final' || 
                           pedido.tipoCliente === 'consumidor-final';
                } else if (filtroEspecial === 'tipoCliente' || tipoFila.includes('Mayorista')) {
                    return pedido.tipoCliente === 'mayorista' || pedido.tipoCliente === 'Mayorista';
                }
                
                return true;
            });
            
            console.log('Pedidos filtrados:', pedidosFiltrados.length);
            
            // Configurar t√≠tulo del modal
            let titulo = `${tipoFila} - ${periodoLabel}`;
            if (temporalidad === 'mensual') titulo += ` ${yearSelect.value}`;
            if (filtroEntrega !== 'todas') titulo += ` (${filtroEntrega})`;
            
            document.getElementById('modalTitle').textContent = titulo;
            
            // Generar estad√≠sticas del reporte
            generarEstadisticasReporte(pedidosFiltrados);
            
            // Generar tabla del reporte
            generarTablaReporte(pedidosFiltrados);
            
            // Mostrar modal
            document.getElementById('modalReporte').style.display = 'block';
        }

        function generarEstadisticasReporte(pedidos) {
            console.log('Generando estad√≠sticas para:', pedidos.length, 'pedidos');
            
            const stats = {
                totalPedidos: pedidos.length,
                totalFacturacion: pedidos.reduce((sum, p) => sum + p.totalPedido, 0),
                totalGanancia: pedidos.reduce((sum, p) => sum + p.gananciaPedido, 0),
                totalGananciaNeta: pedidos.reduce((sum, p) => sum + p.gananciaNeta, 0),
                promedioTicket: pedidos.length > 0 ? pedidos.reduce((sum, p) => sum + p.totalPedido, 0) / pedidos.length : 0
            };
            
            console.log('Estad√≠sticas calculadas:', stats);
            
            const porcentajeGanancia = stats.totalFacturacion > 0 ? (stats.totalGanancia / stats.totalFacturacion) * 100 : 0;
            
            const statsContainer = document.getElementById('reporteStats');
            statsContainer.innerHTML = `
                <div class="reporte-stat-card">
                    <div class="reporte-stat-number">${stats.totalPedidos}</div>
                    <div class="reporte-stat-label">Total Pedidos</div>
                </div>
                <div class="reporte-stat-card">
                    <div class="reporte-stat-number">${formatearMoneda(stats.totalFacturacion)}</div>
                    <div class="reporte-stat-label">Facturaci√≥n Total</div>
                </div>
                <div class="reporte-stat-card">
                    <div class="reporte-stat-number">${formatearMoneda(stats.totalGanancia)}</div>
                    <div class="reporte-stat-label">Ganancia Bruta</div>
                </div>
                <div class="reporte-stat-card">
                    <div class="reporte-stat-number">${formatearMoneda(stats.totalGananciaNeta)}</div>
                    <div class="reporte-stat-label">Ganancia Neta</div>
                </div>
                <div class="reporte-stat-card">
                    <div class="reporte-stat-number">${porcentajeGanancia.toFixed(1)}%</div>
                    <div class="reporte-stat-label">% Ganancia</div>
                </div>
            `;
        }

        function abrirReporteGastos(indicePeriodo, periodoLabel) {
            // Filtrar gastos seg√∫n el per√≠odo y filtro de entrega
            let gastosFiltrados = gastosData.filter(gasto => {
                const fechaGasto = new Date(gasto.fecha);
                
                // Si es un per√≠odo espec√≠fico, filtrar por ese per√≠odo
                if (indicePeriodo !== -1) {
                    let claveAgrupacion = '';
                    
                    if (temporalidad === 'mensual') {
                        claveAgrupacion = `${fechaGasto.getFullYear()}-${fechaGasto.getMonth()}`;
                    } else if (temporalidad === 'semanal') {
                        const inicioAno = new Date(fechaGasto.getFullYear(), 0, 1);
                        const diasTranscurridos = Math.floor((fechaGasto - inicioAno) / (24 * 60 * 60 * 1000));
                        const semanaDelAno = Math.ceil((diasTranscurridos + inicioAno.getDay() + 1) / 7);
                        claveAgrupacion = `${fechaGasto.getFullYear()}-S${semanaDelAno}`;
                    } else if (temporalidad === 'diario') {
                        claveAgrupacion = `${fechaGasto.getFullYear()}-${fechaGasto.getMonth()}-${fechaGasto.getDate()}`;
                    }
                    
                    const indicePeriodoGasto = calcularIndicePeriodo(claveAgrupacion);
                    if (indicePeriodoGasto !== indicePeriodo) {
                        return false;
                    }
                }
                
                // Aplicar filtro de entrega
                if (filtroEntrega !== 'todas') {
                    if (filtroEntrega === 'Local' && gasto.cuenta !== 'Local' && gasto.cuenta !== 'Ambas') {
                        return false;
                    }
                    if (filtroEntrega === 'Envios' && gasto.cuenta !== 'Envios' && gasto.cuenta !== 'Ambas') {
                        return false;
                    }
                }
                
                return true;
            });
            
            // Configurar t√≠tulo del modal
            let titulo = `Gastos - ${periodoLabel}`;
            if (temporalidad === 'mensual') titulo += ` ${yearSelect.value}`;
            if (filtroEntrega !== 'todas') titulo += ` (${filtroEntrega})`;
            
            document.getElementById('modalTitle').textContent = titulo;
            
            // Generar estad√≠sticas de gastos
            generarEstadisticasGastos(gastosFiltrados);
            
            // Generar tabla de gastos
            generarTablaGastos(gastosFiltrados);
            
            // Mostrar modal
            document.getElementById('modalReporte').style.display = 'block';
        }

        function generarEstadisticasGastos(gastos) {
            const stats = {
                totalGastos: gastos.length,
                totalValor: gastos.reduce((sum, g) => sum + g.valor, 0),
                promedioGasto: gastos.length > 0 ? gastos.reduce((sum, g) => sum + g.valor, 0) / gastos.length : 0,
                gastosPorCuenta: {
                    Local: gastos.filter(g => g.cuenta === 'Local').reduce((sum, g) => sum + g.valor, 0),
                    Envios: gastos.filter(g => g.cuenta === 'Envios').reduce((sum, g) => sum + g.valor, 0),
                    Ambas: gastos.filter(g => g.cuenta === 'Ambas').reduce((sum, g) => sum + g.valor, 0)
                }
            };
            
            const statsContainer = document.getElementById('reporteStats');
            statsContainer.innerHTML = `
                <div class="reporte-stat-card">
                    <div class="reporte-stat-number">${stats.totalGastos}</div>
                    <div class="reporte-stat-label">Total Gastos</div>
                </div>
                <div class="reporte-stat-card">
                    <div class="reporte-stat-number">${formatearMoneda(stats.totalValor)}</div>
                    <div class="reporte-stat-label">Valor Total</div>
                </div>
                <div class="reporte-stat-card">
                    <div class="reporte-stat-number">${formatearMoneda(stats.promedioGasto)}</div>
                    <div class="reporte-stat-label">Promedio por Gasto</div>
                </div>
                <div class="reporte-stat-card">
                    <div class="reporte-stat-number">${formatearMoneda(stats.gastosPorCuenta.Local)}</div>
                    <div class="reporte-stat-label">üè™ Local</div>
                </div>
                <div class="reporte-stat-card">
                    <div class="reporte-stat-number">${formatearMoneda(stats.gastosPorCuenta.Envios)}</div>
                    <div class="reporte-stat-label">üöö Env√≠os</div>
                </div>
                <div class="reporte-stat-card">
                    <div class="reporte-stat-number">${formatearMoneda(stats.gastosPorCuenta.Ambas)}</div>
                    <div class="reporte-stat-label">üè™üöö Ambas</div>
                </div>
            `;
        }

        function generarTablaGastos(gastos) {
            if (gastos.length === 0) {
                document.getElementById('reporteTablaContainer').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="bi bi-inbox" style="font-size: 3rem; margin-bottom: 20px;"></i>
                        <p>No hay gastos que coincidan con los criterios seleccionados.</p>
                    </div>
                `;
                return;
            }
            
            // Ordenar gastos por fecha (m√°s recientes primero)
            gastos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            let tablaHTML = `
                <table class="reporte-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Concepto</th>
                            <th>Valor</th>
                            <th>Cuenta</th>
                            <th>Nota</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            gastos.forEach(gasto => {
                // Formatear fecha manualmente como DD/MM/YYYY
                let fechaFormateada = gasto.fecha;
                if (gasto.fecha && gasto.fecha.length === 10) {
                    const [yyyy, mm, dd] = gasto.fecha.split('-');
                    fechaFormateada = `${dd}/${mm}/${yyyy}`;
                }
                const cuentaDisplay = obtenerDisplayCuenta(gasto.cuenta);
                
                tablaHTML += `
                    <tr>
                        <td>${fechaFormateada}</td>
                        <td style="text-align: left; font-weight: 600;">${gasto.concepto}</td>
                        <td style="color: #e74c3c; font-weight: 600;">${formatearMoneda(gasto.valor)}</td>
                        <td style="text-align: center;">${cuentaDisplay}</td>
                        <td style="text-align: left; font-style: italic; color: #666;">${gasto.nota || '-'}</td>
                    </tr>
                `;
            });
            
            tablaHTML += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('reporteTablaContainer').innerHTML = tablaHTML;
        }

        function generarTablaReporte(pedidos) {
            if (pedidos.length === 0) {
                document.getElementById('reporteTablaContainer').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="bi bi-inbox" style="font-size: 3rem; margin-bottom: 20px;"></i>
                        <p>No hay pedidos que coincidan con los criterios seleccionados.</p>
                    </div>
                `;
                return;
            }
            
            let tablaHTML = `
                <table class="reporte-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>Tipo Cliente</th>
                            <th>Entrega</th>
                            <th>Medio Pago</th>
                            <th>Total</th>
                            <th>Ganancia Bruta</th>
                            <th>Gan. Selec.</th>
                            <th>Ganancia Neta</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            pedidos.forEach(pedido => {
                // Capitalizar medio de pago para visualizaci√≥n
                const medioPagoDisplay = pedido.medioPago.charAt(0).toUpperCase() + pedido.medioPago.slice(1);
                
                tablaHTML += `
                    <tr>
                        <td>${pedido.id}</td>
                        <td>${pedido.fechaFormatted}</td>
                        <td style="text-align: left;">${pedido.cliente}</td>
                        <td>${pedido.tipoCliente}</td>
                        <td>${pedido.entrega}</td>
                        <td>${medioPagoDisplay}</td>
                        <td style="text-align: right; color: #555; font-weight: 600;">${formatearMoneda(pedido.totalPedido)}</td>
                        <td style="text-align: right; color: #27ae60; font-weight: 600;">${formatearMoneda(pedido.gananciaPedido)}</td>
                        <td style="text-align: right; color: #27ae60; font-weight: 600;">${formatearMoneda(pedido.gananciaSelec)}</td>
                        <td style="text-align: right; color: #27ae60; font-weight: 600;">${formatearMoneda(pedido.gananciaNeta)}</td>
                    </tr>
                `;
            });
            
            tablaHTML += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('reporteTablaContainer').innerHTML = tablaHTML;
        }

        function cerrarModal() {
            document.getElementById('modalReporte').style.display = 'none';
        }

        // Cerrar modal al hacer clic fuera de √©l
        window.onclick = function(event) {
            const modal = document.getElementById('modalReporte');
            if (event.target === modal) {
                cerrarModal();
            }
        }

        // Cerrar modal con tecla ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                cerrarModal();
            }
        });

        // Event Listeners
        actualizarBtn.addEventListener('click', cargarDatos);
        
        yearSelect.addEventListener('change', () => {
            cargarDatos();
        });

        // Funci√≥n para cerrar sesi√≥n
        function cerrarSesion() {
            firebase.auth().signOut().then(() => {
                window.location.href = 'login.html';
            });
        }

        // Agregar bot√≥n de logout al header si no existe
        document.addEventListener('DOMContentLoaded', () => {
            const header = document.querySelector('.header');
            if (header && !header.querySelector('.logout-btn')) {
                const logoutBtn = document.createElement('button');
                logoutBtn.className = 'btn btn-outline-light btn-sm logout-btn';
                logoutBtn.style.position = 'absolute';
                logoutBtn.style.top = '20px';
                logoutBtn.style.right = '20px';
                logoutBtn.innerHTML = '<i class="bi bi-box-arrow-right"></i> Cerrar Sesi√≥n';
                logoutBtn.addEventListener('click', cerrarSesion);
                header.appendChild(logoutBtn);
            }
        });
    </script>
</body>
</html>
