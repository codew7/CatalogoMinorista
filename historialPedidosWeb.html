<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pedidos Web</title>
  <link rel="icon" href="faviconnegro.png" type="image/png">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <!-- Firebase Auth Check -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script src="config.js"></script>
  <script>
    firebase.initializeApp(firebaseConfig);
    
    // Sistema de autenticación completo
    let admin = false;
    let authResolved = false;
    
    // Lista de emails de administradores
    const adminEmails = ["distribuidorahomepoint@gmail.com"];

    // Función para redirigir a login con parámetro de retorno
    function redirigirALogin() {
        const currentUrl = encodeURIComponent(window.location.href);
        window.location.href = `login.html?redirect=${currentUrl}`;
    }

    // Timeout de seguridad: verificar autenticación después de 5 segundos
    setTimeout(() => {
        if (!authResolved) {
            console.log('Timeout de autenticación alcanzado, redirigiendo a login');
            redirigirALogin();
        }
    }, 5000);

    firebase.auth().onAuthStateChanged(user => {
        console.log('Firebase Auth State Changed:', user ? 'Usuario autenticado' : 'No hay usuario');
        authResolved = true;
        
        if (user) {
            // Verificar si es administrador
            admin = adminEmails.includes(user.email);
            console.log('Usuario admin:', admin);
            
            // Mostrar indicador apropiado
            mostrarIndicadorUsuario(user, admin);
            
            // Inicializar la página después de la autenticación
            inicializarHistorialPedidos();
        } else {
            redirigirALogin();
        }
    });

    // Función para mostrar indicador de usuario
    function mostrarIndicadorUsuario(user, esAdmin) {
        const userIndicator = document.getElementById('userIndicator');
        const adminIndicator = document.getElementById('adminIndicator');
        
        // Verificar que los elementos existan antes de manipular sus estilos
        if (adminIndicator && userIndicator) {
            if (esAdmin) {
                adminIndicator.style.display = 'block';
                userIndicator.style.display = 'none';
            } else {
                adminIndicator.style.display = 'none';
                userIndicator.style.display = 'block';
            }
        } else {
            console.error('No se encontraron los elementos userIndicator o adminIndicator');
        }
    }

    // Función para cerrar sesión
    function cerrarSesion() {
        firebase.auth().signOut().then(() => {
            console.log('Sesión cerrada exitosamente');
            redirigirALogin();
        }).catch((error) => {
            console.error('Error al cerrar sesión:', error);
            alert('Error al cerrar sesión. Inténtalo de nuevo.');
        });
    }
  </script>
  <!-- Fin Firebase Auth Check -->

  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f2f2f2;padding:5px}
    header {background: linear-gradient(90deg, #4CAF50, #69a86b); padding: 1.5rem 1rem 1.5rem 1rem; box-shadow: #5c5866 0px 2px 8px 0px; text-align: center; position: relative;}
    header h1 {margin: 0; font-size: 2.2rem; color: #306932; letter-spacing: 1px; font-weight: 700;}
    table{width:100vw;min-width:600px;max-width:100vw;border-collapse:collapse;background:#fff;box-shadow: #5c5866 0px 2px 8px 0px;}
@media (max-width: 900px) {
  header {
    max-width: 100vw !important;
    width: 100vw !important;
    min-width: 0 !important;
    padding-left: 0.5rem;
    padding-right: 0.5rem;
  }
  .user-indicator {
    right: 8px;
    top: 8px;
  }
  table {
    width: 100vw !important;
    min-width: 320px !important;
    max-width: 100vw !important;
    font-size: 0.95em;
  }
  th, td {
    padding: 6px 2px !important;
    font-size: 0.95em !important;
  }
}
    th,td{padding:8px;border:1px solid #ddd;text-align:center;}
    th{background:#4CAF50;color:#fff}
    button{padding:4px 10px;border:none;border-radius:4px;cursor:pointer;box-shadow: #5c5866 0px 2px 8px 0px;}
    /* Anchos de columnas */
    th.col-indicador, td.col-indicador { width: 4%; min-width: 28px; }
    th.col-nombre, td.col-nombre { width: 16%; min-width: 120px; }
    th.col-fecha, td.col-fecha { width: 10%; min-width: 80px; }
    th.col-entrega, td.col-entrega { width: 10%; min-width: 80px; }
    th.col-estado, td.col-estado { width: 10%; min-width: 80px; }
    th.col-unidades, td.col-unidades { width: 6%; min-width: 40px; }
    th.col-nota, td.col-nota { width: 18%; min-width: 120px; }
    th.col-contacto, td.col-contacto { width: 7%; min-width: 40px; }
  th.col-eliminar, td.col-eliminar { width: 10%; min-width: 90px; text-align: center; vertical-align: middle; }
    @media (max-width: 900px) {
      th.col-indicador, td.col-indicador { min-width: 20px; }
      th.col-nombre, td.col-nombre { min-width: 80px; }
      th.col-fecha, td.col-fecha,
      th.col-entrega, td.col-entrega,
      th.col-estado, td.col-estado { min-width: 60px; }
      th.col-unidades, td.col-unidades { min-width: 32px; }
      th.col-nota, td.col-nota { min-width: 80px; }
      th.col-contacto, td.col-contacto,
      th.col-eliminar, td.col-eliminar { min-width: 80px; }
    }
    .cerrar{background:#4CAF50;color:#fff}
    .cerrado{background:#9e9e9e;color:#fff;cursor:not-allowed}
    .reabrir{background:#FF9800;color:#fff} 
    button + button{ margin-left:6px; }
    .dot{display:inline-block;width:10px;height:10px;border-radius:50%;background:#f44336;}
    .cancelado-row {background: #e0e0e0 !important;color: #888;}

    #filtroStatusBtns {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-top: 20px;
      gap: 5px;
    }
    .filtro-row {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      gap: 10px;
      width: 100%;
      margin-bottom: 8px;
    }
    @media (max-width: 600px) {
      .filtro-row {
        flex-wrap: wrap;
        gap: 6px;
      }
      #filtroStatusBtns {
        gap: 6px;
      }
    }

    /* Estilos para indicadores de usuario */
    .user-indicator {
        position: absolute;
        top: 15px;
        right: 20px;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 25px;
        padding: 8px 20px;
        color: white;
        font-size: 0.9rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .user-indicator:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .user-indicator i {
        font-size: 1.1rem;
    }

    .logout-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 5px;
        margin-left: auto;
        padding: 0;
        box-shadow: none;
        flex-shrink: 0;
    }

    .logout-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .logout-btn i {
        font-size: 0.9rem;
        line-height: 1;
    }

    /* Estilos para el campo de nota */
    .nota-input {
        width: 95%;
        padding: 4px 6px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.85em;
        min-height: 20px;
        resize: vertical;
        font-family: inherit;
    }

    .nota-input:focus {
        outline: none;
        border-color: #4CAF50;
        box-shadow: 0 0 3px rgba(76, 175, 80, 0.3);
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

  </style>
</head>
<body>
  <div style="display: flex; justify-content: center;">
  <header style="width:100vw; max-width:100vw; min-width:0;">
      <h1>Pedidos Web</h1>
      <!-- Indicador de Administrador -->
      <div id="adminIndicator" class="user-indicator" style="display: none;">
          <i class="bi bi-shield-check"></i>
          <span>Modo Administrador</span>
      </div>
      <!-- Indicador de Usuario Normal -->
      <div id="userIndicator" class="user-indicator" style="display: none;">
          <i class="bi bi-person-circle"></i>
          <span>Usuario</span>
          <button class="logout-btn" onclick="cerrarSesion()" title="Cerrar Sesión">
              <i class="bi bi-box-arrow-right"></i>
          </button>
      </div>
      <div id="filtroStatusBtns"></div>
    </header>
  </div>
  
 

  <div style="display: flex; justify-content: center;">
    <div style="width:100vw; overflow-x:auto;">
      <table id="tabla" style="width:100vw; min-width:600px; max-width:100vw;">
    <thead>
<tr>
  <th class="col-indicador"></th>
  <th class="col-nombre">Nombre</th>
  <th class="col-fecha">Fecha</th>
  <th class="col-entrega">Entrega</th>
  <th class="col-estado">Estado</th>
  <th class="col-unidades">U.</th>
  <th class="col-nota">Nota</th>
  <th class="col-eliminar"></th>
</tr>

    </thead>
    <tbody></tbody>
  </table>
  </div>

<!-- Datalist para las opciones de nota -->
<datalist id="notaEstadosDatalist">
  <option value="esperando respuesta">
  <option value="esperando cierre">
  <option value="espera cotización">
  <option value="esperando pago">
  <option value="pago">
  <option value="retira">
  <option value="no responde">
</datalist>

<script>
  // Declarar variables globales y db
  const db = firebase.database();
  const tbody = document.querySelector('#tabla tbody');
  const filtroStatusBtns = document.getElementById('filtroStatusBtns');

  let pedidos = {};           // cache local para filtrar

  // Estados posibles 
  const estados = [
    { label: 'Abierto', value: 'ABIERTO', color: '#4CAF50' },
    { label: 'Cerrado', value: 'CERRADO', color: '#4CAF50' },
    { label: 'Entrega', value: 'DESPACHADO/ENTREGADO', color: '#4CAF50' },
    { label: 'Cancel', value: 'CANCELADO', color: '#4CAF50' },
  ];

  // Por defecto seleccionados
  let statusSeleccionados = ['ABIERTO', 'CERRADO'];
  let entregaSeleccionada = null; // 'Retiro', 'Envio' o null

  // Función para inicializar el historial de pedidos después de la autenticación
  function inicializarHistorialPedidos() {
    // Si la página ya está cargada, ejecutar inmediatamente
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', configurarEventListeners);
    } else {
      configurarEventListeners();
    }
  }

  let descargandoTodo = false;
  let listenerPedidos = null;

  function configurarEventListeners() {
    renderBotonesFiltro();
    agregarBotonDescargarTodo();
    cargarPedidosUltimos30Dias();
  }

  function cargarPedidosUltimos30Dias() {
    if (listenerPedidos) listenerPedidos.off();
    descargandoTodo = false;
    const ahora = Date.now();
    const hace30dias = ahora - 30 * 24 * 60 * 60 * 1000;
    // Consulta por timestamp >= hace 30 días
    listenerPedidos = db.ref('pedidos').orderByChild('timestamp').startAt(hace30dias);
    listenerPedidos.on('value', snap => {
      pedidos = [];
      snap.forEach(child => {
        const p = child.val() || {};
        p.id = child.key;
        pedidos.push(p);
      });
      renderTabla();
    });
  }

  function cargarPedidosTodos() {
    if (listenerPedidos) listenerPedidos.off();
    descargandoTodo = true;
    listenerPedidos = db.ref('pedidos');
    listenerPedidos.on('value', snap => {
      pedidos = [];
      snap.forEach(child => {
        const p = child.val() || {};
        p.id = child.key;
        pedidos.push(p);
      });
      renderTabla();
    });
  }

  function agregarBotonDescargarTodo() {
    let btn = document.getElementById('btnDescargarTodo');
    if (!btn) {
      btn = document.createElement('button');
      btn.id = 'btnDescargarTodo';
      btn.textContent = 'Descargar todo';
      btn.style.background = '#2196F3';
      btn.style.color = '#fff';
      btn.style.border = '1.5px solid #2196F3';
      btn.style.borderRadius = '18px';
  btn.style.padding = '6px 16px';
  btn.style.fontWeight = 'bold';
  btn.style.cursor = 'pointer';
  btn.style.margin = '30px auto 0 auto';
  btn.style.display = 'block';
  btn.style.fontSize = '1em';
      btn.onclick = function() {
        if (!descargandoTodo) cargarPedidosTodos();
      };
      // Insertar el botón fuera del contenedor de la tabla, como pie de página independiente
      let pie = document.getElementById('pieDescargarTodo');
      if (!pie) {
        pie = document.createElement('div');
        pie.id = 'pieDescargarTodo';
        pie.style.width = '100vw';
        pie.style.display = 'flex';
        pie.style.justifyContent = 'center';
        pie.style.alignItems = 'center';
        pie.style.margin = '0 auto 30px auto';
        // Insertar pie al final del body
        document.body.appendChild(pie);
      }
      pie.appendChild(btn);
    }
    // Mostrar/ocultar según estado
    btn.style.display = descargandoTodo ? 'none' : 'block';
  }

  function renderBotonesFiltro() {
    filtroStatusBtns.innerHTML = '';
    // Primera fila: Abierto, Cerrado, Entrega, Cancel
    const row1 = document.createElement('div');
    row1.className = 'filtro-row';
    ['Abierto', 'Cerrado', 'Entrega', 'Cancel'].forEach(label => {
      const est = estados.find(e => e.label === label);
      const btn = document.createElement('button');
      btn.textContent = est.label;
      btn.style.background = statusSeleccionados.includes(est.value) ? est.color : '#fff';
      btn.style.color = statusSeleccionados.includes(est.value) ? (est.textColor || '#fff') : '#333';
      btn.style.border = '1.5px solid ' + est.color;
      btn.style.borderRadius = '18px';
      btn.style.padding = '6px 16px';
      btn.style.fontWeight = 'bold';
      btn.style.cursor = 'pointer';
      btn.style.transition = 'all 0.2s';
      btn.onclick = () => {
        if (est.value === 'ABIERTO' || est.value === 'CERRADO') {
          // Toggle solo para ABIERTO y CERRADO
          if (statusSeleccionados.includes(est.value)) {
            statusSeleccionados = statusSeleccionados.filter(s => s !== est.value);
          } else {
            if (statusSeleccionados.includes('ABIERTO') || statusSeleccionados.includes('CERRADO')) {
              statusSeleccionados.push(est.value);
            } else {
              statusSeleccionados = [est.value];
            }
          }
        } else {
          statusSeleccionados = [est.value];
        }
        renderBotonesFiltro();
        renderTabla();
      };
      row1.appendChild(btn);
    });
    filtroStatusBtns.appendChild(row1);

    // Segunda fila: Retiro, Envio, Todos
    const row2 = document.createElement('div');
    row2.className = 'filtro-row';
    // Retiro
    const btnRetiro = document.createElement('button');
    btnRetiro.textContent = 'Retiro';
    btnRetiro.style.background = entregaSeleccionada === 'Retiro' ? '#FFD600' : '#fff';
    btnRetiro.style.color = entregaSeleccionada === 'Retiro' ? '#333' : '#333';
    btnRetiro.style.border = '1.5px solid #FFD600';
    btnRetiro.style.borderRadius = '18px';
    btnRetiro.style.padding = '6px 16px';
    btnRetiro.style.fontWeight = 'bold';
    btnRetiro.style.cursor = 'pointer';
    btnRetiro.onclick = () => {
      entregaSeleccionada = entregaSeleccionada === 'Retiro' ? null : 'Retiro';
      renderBotonesFiltro();
      renderTabla();
    };
    row2.appendChild(btnRetiro);
    // Envio
    const btnEnvio = document.createElement('button');
    btnEnvio.textContent = 'Envio';
    btnEnvio.style.background = entregaSeleccionada === 'Envio' ? '#FFD600' : '#fff';
    btnEnvio.style.color = entregaSeleccionada === 'Envio' ? '#333' : '#333';
    btnEnvio.style.border = '1.5px solid #FFD600';
    btnEnvio.style.borderRadius = '18px';
    btnEnvio.style.padding = '6px 16px';
    btnEnvio.style.fontWeight = 'bold';
    btnEnvio.style.cursor = 'pointer';
    btnEnvio.onclick = () => {
      entregaSeleccionada = entregaSeleccionada === 'Envio' ? null : 'Envio';
      renderBotonesFiltro();
      renderTabla();
    };
    row2.appendChild(btnEnvio);
    // Todos
    const btnTodos = document.createElement('button');
    btnTodos.textContent = 'Todos';
    btnTodos.style.background = statusSeleccionados.length === 0 && !entregaSeleccionada ? '#4CAF50' : '#fff';
    btnTodos.style.color = statusSeleccionados.length === 0 && !entregaSeleccionada ? '#fff' : '#333';
    btnTodos.style.border = '1.5px solid #4CAF50';
    btnTodos.style.borderRadius = '18px';
    btnTodos.style.padding = '6px 16px';
    btnTodos.style.fontWeight = 'bold';
    btnTodos.style.cursor = 'pointer';
    btnTodos.onclick = () => {
      statusSeleccionados = [];
      entregaSeleccionada = null;
      renderBotonesFiltro();
      renderTabla();
    };
    row2.appendChild(btnTodos);
    filtroStatusBtns.appendChild(row2);
  }

  renderBotonesFiltro();

  function getSelectedStatuses() {
    return statusSeleccionados.length ? statusSeleccionados : null;
  }

  function getEntregaPedido(p) {
    if (
      p.cliente &&
      typeof p.cliente.direccion === 'string' &&
      p.cliente.direccion.trim() !== ''
    ) {
      return 'Envio';
    }
    return 'Retiro';
  }

  function renderTabla() {
    const statusSel = getSelectedStatuses();
    tbody.innerHTML = '';

    pedidos
      .filter(p => {
        // Filtrar pedidos que NO tengan CREATEDBY: 'admin'
        if (p.createdby === 'admin') return false;
        if (!statusSel) return true;
        let estado = 'ABIERTO';
        if (p.status === 'DESPACHADO/ENTREGADO') {
          estado = 'DESPACHADO/ENTREGADO';
        } else if (p.status === 'CANCELADO') {
          estado = 'CANCELADO';
        } else if (p.status === 'CERRADO' || p.locked) {
          estado = 'CERRADO';
        } else if (p.status === 'ABIERTO') {
          estado = 'ABIERTO';
        }
        return statusSel.includes(estado);
      })
      .filter(p => {
        if (!entregaSeleccionada) return true;
        return getEntregaPedido(p) === entregaSeleccionada;
      })
      .sort((a, b) => b.timestamp - a.timestamp) // más nuevos arriba
      .forEach(p => {
        const tr = document.createElement('tr');
        if (p.status === 'CANCELADO') tr.classList.add('cancelado-row');
        // Si el pedido está ABIERTO y tiene más de 7 días, marcar en naranja
        const ahora = Date.now();
        const sieteDiasMs = 7 * 24 * 60 * 60 * 1000;
        if ((p.status === 'ABIERTO' || (!p.status && !p.locked)) && (ahora - p.timestamp > sieteDiasMs)) {
          tr.style.background = '#edb461'; // naranja
          tr.style.color = '#fff';
        }
        // Si el pedido está DESPACHADO/ENTREGADO, marcar en verde agua
        if (p.status === 'DESPACHADO/ENTREGADO') {
          tr.style.background = '#bbfacb'; // verde clarito
          tr.style.color = '#458254';
        }

        /* --- 1. Indicador de modificación --- */
  const indCell = tr.insertCell();
  indCell.className = 'col-indicador';
        if (p.adminViewed === false) {
          const dot = document.createElement('span');
          dot.className = 'dot';
          indCell.appendChild(dot);
        }

        /* --- 3. Nombre cliente --- */
  const nombreCell = tr.insertCell();
  nombreCell.className = 'col-nombre';
        const nombreSpan = document.createElement('span');
        nombreSpan.textContent = p.cliente?.nombre || '—';
        nombreSpan.style.cursor = 'pointer';
        nombreSpan.style.color = '#2196F3';
        nombreSpan.style.textDecoration = 'underline';
        nombreSpan.onclick = () => {
          window.open(`pedidos.html?id=${p.id}&admin=true`, '_blank');
          db.ref(`pedidos/${p.id}`).update({ adminViewed: true })
            .catch(() => console.error('No se pudo marcar adminViewed'));
        };
        nombreCell.appendChild(nombreSpan);

        /* --- 4. Fecha corta --- */
        const fecha = new Date(p.timestamp);
        const fechaCell = tr.insertCell();
        fechaCell.className = 'col-fecha';
        fechaCell.textContent =
          fecha.toLocaleDateString('es-AR') + ' ' +
          fecha.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });


        /* --- 6. ENTREGA --- */
        let tipoEntrega = '';
        const provincia = p.cliente?.provincia ? p.cliente.provincia.trim() : '';
        if (p.tipoEntrega === 'Showroom') {
          tipoEntrega = 'Retiro';
        } else if (!provincia) {
          tipoEntrega = 'Retiro';
        } else if (p.tipoEntrega !== 'Showroom') {
          if (provincia !== 'Gran Buenos Aires' && provincia !== 'CABA') {
            tipoEntrega = 'Envio';
          } else if (provincia === ' Gran Buenos Aires' || provincia === 'CABA') {
            tipoEntrega = 'Envio?';
          } else {
            tipoEntrega = 'Envio';
          }
        } else {
          tipoEntrega = 'Retiro';
        }
  const entregaCell = tr.insertCell();
  entregaCell.className = 'col-entrega';
  entregaCell.textContent = tipoEntrega;

        /* --- 7. Estado --- */
        let estado = 'ABIERTO';
        if (p.status === 'DESPACHADO/ENTREGADO') {
          estado = 'DESPACHADO/ENTREGADO';
        } else if (p.status === 'CANCELADO') {
          estado = 'CANCELADO';
        } else if (p.status === 'CERRADO' || p.locked) {
          estado = 'CERRADO';
        } else if (p.status === 'ABIERTO') {
          estado = 'ABIERTO';
        }
  const estadoCell = tr.insertCell();
  estadoCell.className = 'col-estado';
  estadoCell.textContent = estado;

  /* --- Unidades totales --- */
  const unidadesCell = tr.insertCell();
  unidadesCell.className = 'col-unidades';
  let totalUnidades = 0;
  if (Array.isArray(p.items)) {
    totalUnidades = p.items.reduce((sum, item) => sum + (parseInt(item.cantidad) || 0), 0);
  }
  unidadesCell.textContent = totalUnidades;

        /* --- 8. Nota --- */
        const notaCell = tr.insertCell();
        notaCell.className = 'col-nota';
        // Contenedor para nota y fecha
        const notaCont = document.createElement('div');
        notaCont.style.display = 'flex';
        notaCont.style.flexDirection = 'column';
        notaCont.style.alignItems = 'flex-start';

        const notaInput = document.createElement('input');
        notaInput.type = 'text';
        notaInput.className = 'nota-input';
        notaInput.value = p.nota || '';
        notaInput.placeholder = 'Seleccionar o escribir estado...';
        notaInput.setAttribute('list', 'notaEstadosDatalist');

        // Fecha de última actualización
        const notaFecha = p.notaFecha ? new Date(p.notaFecha) : null;
        const fechaLabel = document.createElement('span');
        fechaLabel.style.fontSize = '0.8em';
        fechaLabel.style.color = '#888';
        fechaLabel.style.marginTop = '2px';
  fechaLabel.textContent = (notaFecha && (p.nota && p.nota.trim() !== '')) ? `${notaFecha.toLocaleDateString('es-AR')}` : '';

        // Manejar selección del datalist para reemplazar el texto existente
        notaInput.addEventListener('focus', function() {
          this.setAttribute('data-valor-anterior', this.value);
        });

        function actualizarNota(nuevaNota) {
          const ahora = Date.now();
          db.ref(`pedidos/${p.id}`).update({ nota: nuevaNota, notaFecha: ahora })
            .then(() => {
              fechaLabel.textContent = (nuevaNota && nuevaNota.trim() !== '')
                ? `Última actualización: ${new Date(ahora).toLocaleDateString('es-AR')} ${new Date(ahora).toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' })}`
                : '';
            })
            .catch(() => console.error('Error al guardar la nota'));
        }

        notaInput.addEventListener('change', function() {
          const nuevaNota = this.value.trim();
          actualizarNota(nuevaNota);
        });

        let timeoutId;
        notaInput.addEventListener('input', () => {
          clearTimeout(timeoutId);
          timeoutId = setTimeout(() => {
            const nuevaNota = notaInput.value.trim();
            actualizarNota(nuevaNota);
          }, 5000);
        });

        notaCont.appendChild(notaInput);
        notaCont.appendChild(fechaLabel);
        notaCell.appendChild(notaCont);

        /* --- 9. Acciones (llamada, compartir y eliminar) --- */
        const acciones = tr.insertCell();
        acciones.className = 'col-eliminar';
        acciones.style.textAlign = 'center';
        acciones.style.verticalAlign = 'middle';
        acciones.style.padding = '4px';
        
        // Contenedor flex para los botones
        const botonesContainer = document.createElement('div');
        botonesContainer.style.display = 'flex';
        botonesContainer.style.gap = '6px';
        botonesContainer.style.justifyContent = 'center';
        botonesContainer.style.alignItems = 'center';
        botonesContainer.style.flexWrap = 'nowrap';
        
        // Botón Llamar/WhatsApp
        const telefono = p.cliente?.telefono ? p.cliente.telefono.replace(/[^\d]/g, '') : '';
        let telClean = telefono;
        if (telClean.startsWith('0')) telClean = telClean.substring(1);
        if (telClean && !telClean.startsWith('54')) telClean = '54' + telClean;
        const btnTel = document.createElement('button');
        btnTel.innerHTML = '<i class="bi bi-telephone-fill"></i>';
        btnTel.title = 'Contactar por WhatsApp';
        btnTel.style.background = '#25D366';
        btnTel.style.color = '#fff';
        btnTel.style.borderRadius = '50%';
        btnTel.style.width = '26px';
        btnTel.style.height = '26px';
        btnTel.style.display = 'flex';
        btnTel.style.alignItems = 'center';
        btnTel.style.justifyContent = 'center';
        btnTel.style.fontSize = '0.85em';
        btnTel.style.boxShadow = 'none';
        btnTel.style.border = 'none';
        btnTel.style.cursor = 'pointer';
        btnTel.style.padding = '0';
        btnTel.style.flexShrink = '0';
        btnTel.disabled = !telClean;
        if (!telClean) {
          btnTel.style.opacity = '0.5';
          btnTel.style.cursor = 'not-allowed';
        }
        btnTel.onclick = () => {
          if (telClean) {
            window.open(`https://api.whatsapp.com/send/?phone=${telClean}`, '_blank');
          } else {
            alert('Teléfono no disponible');
          }
        };
        botonesContainer.appendChild(btnTel);
        
        // Botón Copiar URL
        const btnCopiar = document.createElement('button');
        btnCopiar.innerHTML = '<i class="bi bi-link-45deg"></i>';
        btnCopiar.title = 'Copiar URL del pedido';
        btnCopiar.style.background = '#FFA726';
        btnCopiar.style.color = '#fff';
        btnCopiar.style.borderRadius = '50%';
        btnCopiar.style.width = '26px';
        btnCopiar.style.height = '26px';
        btnCopiar.style.display = 'flex';
        btnCopiar.style.alignItems = 'center';
        btnCopiar.style.justifyContent = 'center';
        btnCopiar.style.fontSize = '1em';
        btnCopiar.style.boxShadow = 'none';
        btnCopiar.style.border = 'none';
        btnCopiar.style.cursor = 'pointer';
        btnCopiar.style.padding = '0';
        btnCopiar.style.flexShrink = '0';
        btnCopiar.onclick = () => {
          // Crear URL sin el parámetro admin=true
          const urlBase = window.location.origin + '/pedidos.html?id=' + p.id;
          navigator.clipboard.writeText(urlBase).then(() => {
            btnCopiar.innerHTML = '<i class="bi bi-check-lg"></i>';
            setTimeout(() => {
              btnCopiar.innerHTML = '<i class="bi bi-link-45deg"></i>';
            }, 2000);
          }).catch(err => {
            alert('No se pudo copiar la URL');
            console.error('Error al copiar:', err);
          });
        };
        botonesContainer.appendChild(btnCopiar);
        
        // Botón Eliminar
        const btnEliminar = document.createElement('button');
        btnEliminar.innerHTML = '<i class="bi bi-x-lg"></i>';
        btnEliminar.title = 'Eliminar';
        btnEliminar.style.background = '#f44336';
        btnEliminar.style.color = '#fff';
        btnEliminar.style.borderRadius = '50%';
        btnEliminar.style.width = '26px';
        btnEliminar.style.height = '26px';
        btnEliminar.style.display = 'flex';
        btnEliminar.style.alignItems = 'center';
        btnEliminar.style.justifyContent = 'center';
        btnEliminar.style.fontSize = '0.85em';
        btnEliminar.style.boxShadow = 'none';
        btnEliminar.style.border = 'none';
        btnEliminar.style.cursor = 'pointer';
        btnEliminar.style.padding = '0';
        btnEliminar.style.flexShrink = '0';
        btnEliminar.onclick = () => {
          mostrarModalClave(() => {
            if (confirm('¿Está seguro que desea eliminar este pedido? Esta acción es irreversible.')) {
              db.ref(`pedidos/${p.id}`).remove()
                .catch(()=>alert('Error al eliminar el pedido'));
            }
          });
        };
        botonesContainer.appendChild(btnEliminar);
        
        acciones.appendChild(botonesContainer);

        tbody.appendChild(tr);
      });
}


</script>

<!-- Modal de autorización reutilizable -->
<div id="modalClave" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);justify-content:center;align-items:center;z-index:9999;">
  <div style="background:#fff;padding:18px 22px;border-radius:8px;min-width:220px;max-width:90vw;box-shadow:0 2px 12px #0003;text-align:center;">
    <div style='font-size:1.1em;margin-bottom:10px;'>Código de autorización</div>
    <input id="inputClave" type="password" style="width:120px;padding:6px 8px;font-size:1em;margin-bottom:12px;" maxlength="8" autocomplete="off" autofocus>
    <br>
    <button id="btnOkClave" style="background:#4CAF50;color:#fff;margin-right:8px;">OK</button>
    <button id="btnCancelClave" style="background:#888;color:#fff;">Cancelar</button>
  </div>
</div>

<script>
function mostrarModalClave(onSuccess) {
  const modal = document.getElementById('modalClave');
  const input = document.getElementById('inputClave');
  const btnOk = document.getElementById('btnOkClave');
  const btnCancel = document.getElementById('btnCancelClave');
  input.value = '';
  modal.style.display = 'flex';
  input.focus();
  btnOk.onclick = () => {
    if (input.value === '212118') {
      modal.style.display = 'none';
      onSuccess();
    } else {
      alert('Código incorrecto. No se eliminará el pedido.');
      input.value = '';
      input.focus();
    }
  };
  btnCancel.onclick = () => { modal.style.display = 'none'; };
  input.onkeydown = e => { if (e.key === 'Enter') btnOk.onclick(); };
}
</script>

</body>
</html>